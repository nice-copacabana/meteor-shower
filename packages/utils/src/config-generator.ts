// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°ConfigGeneratoræ¨¡æ¿é©±åŠ¨æ›¿æ¢ç¡¬ç¼–ç ï¼Œä½¿ç”¨å®é™…æ¨¡æ¿æ–‡ä»¶æ¸²æŸ“é…ç½®

/**
 * é…ç½®ç”Ÿæˆå™¨æ¨¡å—
 * åŸºäºæ¨¡æ¿å’Œå˜é‡ç”Ÿæˆå…·ä½“çš„é…ç½®æ“ä½œè®¡åˆ’
 *
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - æ¨¡æ¿æ¸²æŸ“ï¼šå°†æ¨¡æ¿è½¬æ¢ä¸ºå…·ä½“é…ç½®
 * - æ“ä½œè§„åˆ’ï¼šç”Ÿæˆæ–‡ä»¶æ“ä½œåºåˆ—
 * - å¤šå·¥å…·æ”¯æŒï¼šä¸ºä¸åŒå·¥å…·ç”Ÿæˆç›¸åº”é…ç½®
 */

import { TemplateEngine, TemplateMetadata } from './template-engine.js';
import { FileOperations } from './file-ops.js';
import chalk from 'chalk';                 // ç»ˆç«¯é¢œè‰²è¾“å‡º
import fs from 'fs/promises';              // æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
import path from 'path';                   // è·¯å¾„æ“ä½œ
import os from 'os';                       // æ“ä½œç³»ç»Ÿä¿¡æ¯

/**
 * é…ç½®è®¡åˆ’æ¥å£
 * å®šä¹‰é…ç½®ç”Ÿæˆçš„ç»“æœå’Œæ‰§è¡Œè®¡åˆ’
 */
export interface ConfigPlan {
  toolset: string[];                        // ç›®æ ‡å·¥å…·é›†
  template: string;                         // ä½¿ç”¨çš„æ¨¡æ¿ID
  variables: Record<string, unknown>;       // å˜é‡å€¼
  operations: Array<{                       // å…·ä½“çš„æ–‡ä»¶æ“ä½œåºåˆ—
    target: string;                         // ç›®æ ‡å·¥å…·ç±»å‹
    path: string;                           // ç›®æ ‡æ–‡ä»¶è·¯å¾„
    content: string;                        // æ–‡ä»¶å†…å®¹
    kind: 'create' | 'update' | 'delete';   // æ“ä½œç±»å‹
  }>;
}

/**
 * é…ç½®ç”Ÿæˆå™¨ç±»
 * è´Ÿè´£å°†æ¨¡æ¿å’Œå˜é‡è½¬æ¢ä¸ºå…·ä½“çš„é…ç½®æ“ä½œè®¡åˆ’
 *
 * å·¥ä½œæµç¨‹ï¼š
 * 1. åŠ è½½å’ŒéªŒè¯æ¨¡æ¿
 * 2. ä¸ºæ¯ä¸ªç›®æ ‡å·¥å…·ç”Ÿæˆé…ç½®
 * 3. ç”Ÿæˆæ–‡ä»¶æ“ä½œåºåˆ—
 * 4. è¿”å›å®Œæ•´çš„é…ç½®è®¡åˆ’
 */
export class ConfigGenerator {
  private templateEngine: TemplateEngine;   // æ¨¡æ¿å¼•æ“å®ä¾‹
  private fileOps: FileOperations;          // æ–‡ä»¶æ“ä½œå®ä¾‹

  /**
   * æ„é€ å‡½æ•°
   * åˆå§‹åŒ–æ¨¡æ¿å¼•æ“å’Œæ–‡ä»¶æ“ä½œå®ä¾‹
   */
  constructor() {
    this.templateEngine = new TemplateEngine();
    this.fileOps = new FileOperations();
  }

  /**
   * ç”Ÿæˆé…ç½®è®¡åˆ’
   * åŸºäºå·¥å…·é›†ã€æ¨¡æ¿å’Œå˜é‡ç”Ÿæˆå®Œæ•´çš„é…ç½®æ“ä½œè®¡åˆ’
   *
   * @param toolset ç›®æ ‡å·¥å…·é›†åˆ
   * @param templateId æ¨¡æ¿ID
   * @param variables å˜é‡æ˜ å°„
   * @returns å®Œæ•´çš„é…ç½®è®¡åˆ’ï¼ŒåŒ…å«æ‰€æœ‰æ–‡ä»¶æ“ä½œ
   */
  async generateConfig(toolset: string[], templateId: string, variables: Record<string, unknown>): Promise<ConfigPlan> {
    console.log(chalk.cyan('ğŸ”§ ç”Ÿæˆé…ç½®è®¡åˆ’...'));

    // åŠ è½½å¹¶éªŒè¯æ¨¡æ¿
    const template = await this.templateEngine.loadTemplate(templateId);
    const operations: ConfigPlan['operations'] = [];

    // ä¸ºæ¯ä¸ªç›®æ ‡å·¥å…·ç”Ÿæˆå¯¹åº”çš„é…ç½®æ“ä½œ
    for (const tool of toolset) {
      console.log(chalk.gray(`  ğŸ“¦ å¤„ç† ${tool} é…ç½®...`));
      const configs = await this.generateToolConfig(tool, template, variables);
      operations.push(...configs);
    }

    console.log(chalk.green(`âœ… ç”Ÿæˆ ${operations.length} ä¸ªé…ç½®æ“ä½œ`));
    return {
      toolset,
      template: templateId,
      variables,
      operations
    };
  }

  /**
   * ä¸ºæŒ‡å®šå·¥å…·ç”Ÿæˆé…ç½®æ“ä½œ
   * åŸºäºæ¨¡æ¿æ–‡ä»¶å’Œå˜é‡æ¸²æŸ“é…ç½®å†…å®¹
   *
   * @param tool å·¥å…·åç§°
   * @param template æ¨¡æ¿å…ƒæ•°æ®
   * @param variables å˜é‡æ˜ å°„
   * @returns è¯¥å·¥å…·çš„é…ç½®æ“ä½œåˆ—è¡¨
   */
  private async generateToolConfig(tool: string, template: TemplateMetadata, variables: Record<string, unknown>) {
    const operations: ConfigPlan['operations'] = [];
    
    // æ ¹æ®å·¥å…·ç±»å‹å®šä¹‰é…ç½®æ–‡ä»¶æ˜ å°„
    const configMappings: Record<string, Array<{templateFile: string, targetPath: string}>> = {
      gemini: [
        { templateFile: 'GEMINI.md.template', targetPath: '~/.gemini/GEMINI.md' },
        { templateFile: 'settings.json.template', targetPath: '~/.gemini/settings.json' },
        { templateFile: 'plan.toml.template', targetPath: '.gemini/commands/plan.toml' }
      ],
      claude: [
        { templateFile: 'claude.json.template', targetPath: '~/.claude/claude.json' },
        { templateFile: 'CLAUDE.md.template', targetPath: './CLAUDE.md' },
        { templateFile: 'CLAUDE.local.md.template', targetPath: './CLAUDE.local.md' }
      ],
      cursor: [
        { templateFile: 'cursorrules.template', targetPath: './.cursorrules' },
        { templateFile: 'cursor-rules.txt.template', targetPath: './.cursor/rules.txt' },
        { templateFile: 'CURSOR.local.md.template', targetPath: './CURSOR.local.md' }
      ],
      openai: [
        { templateFile: 'AGENTS.md.template', targetPath: './AGENTS.md' },
        { templateFile: 'env.example.template', targetPath: './.env.example' },
        { templateFile: 'OPENAI.local.md.template', targetPath: './OPENAI.local.md' }
      ]
    };

    const mappings = configMappings[tool];
    if (!mappings) {
      console.warn(chalk.yellow(`âš ï¸ æœªçŸ¥å·¥å…·ç±»å‹: ${tool}ï¼Œè·³è¿‡`));
      return operations;
    }

    // ä¸ºæ¯ä¸ªæ¨¡æ¿æ–‡ä»¶ç”Ÿæˆæ“ä½œ
    for (const mapping of mappings) {
      try {
        const content = await this.renderTemplateFile(tool, mapping.templateFile, variables);
        operations.push({
          target: tool,
          path: mapping.targetPath,
          content,
          kind: 'create'
        });
      } catch (error) {
        console.error(chalk.red(`âŒ æ¸²æŸ“æ¨¡æ¿å¤±è´¥ ${mapping.templateFile}: ${error}`));
      }
    }
    
    return operations;
  }

  /**
   * æ¸²æŸ“æ¨¡æ¿æ–‡ä»¶
   * è¯»å–æ¨¡æ¿æ–‡ä»¶å¹¶ä½¿ç”¨å˜é‡è¿›è¡Œæ¸²æŸ“
   *
   * @param tool å·¥å…·åç§°
   * @param templateFileName æ¨¡æ¿æ–‡ä»¶å
   * @param variables å˜é‡æ˜ å°„
   * @returns æ¸²æŸ“åçš„å†…å®¹
   */
  private async renderTemplateFile(tool: string, templateFileName: string, variables: Record<string, unknown>): Promise<string> {
    // æ„å»ºæ¨¡æ¿æ–‡ä»¶è·¯å¾„
    const templatePath = path.join(
      process.cwd(),
      'packages/templates/configs',
      tool,
      templateFileName
    );

    try {
      // è¯»å–æ¨¡æ¿æ–‡ä»¶
      let content = await fs.readFile(templatePath, 'utf-8');

      // è¿›è¡Œå˜é‡æ›¿æ¢
      content = this.replaceVariables(content, variables);

      return content;
    } catch (error: any) {
      if (error.code === 'ENOENT') {
        console.warn(chalk.yellow(`âš ï¸ æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: ${templatePath}`));
        // è¿”å›åŸºæœ¬çš„å ä½ç¬¦å†…å®¹
        return this.generateFallbackContent(tool, templateFileName, variables);
      }
      throw error;
    }
  }

  /**
   * æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
   * æ”¯æŒç®€å•çš„ {{variableName}} æ ¼å¼
   * æ”¯æŒ Handlebars çš„ {{#each}} å¾ªç¯è¯­æ³•
   *
   * @param content æ¨¡æ¿å†…å®¹
   * @param variables å˜é‡æ˜ å°„
   * @returns æ›¿æ¢åçš„å†…å®¹
   */
  private replaceVariables(content: string, variables: Record<string, unknown>): string {
    let result = content;

    // å¤„ç† {{#each techStack}} å¾ªç¯
    const eachRegex = /\{\{#each (\w+)\}\}([\s\S]*?)\{\{\/each\}\}/g;
    result = result.replace(eachRegex, (match, arrayName, template) => {
      const array = variables[arrayName];
      if (!Array.isArray(array)) {
        return '';
      }
      return array.map(item => template.replace(/\{\{this\}\}/g, String(item))).join('');
    });

    // å¤„ç† {{#if condition}} æ¡ä»¶
    const ifRegex = /\{\{#if (\w+(?:\.\w+)?)\}\}([\s\S]*?)\{\{\/if\}\}/g;
    result = result.replace(ifRegex, (match, condition, content) => {
      // æ”¯æŒ features.database è¿™æ ·çš„åµŒå¥—è®¿é—®
      const keys = condition.split('.');
      let value: any = variables;
      for (const key of keys) {
        value = value?.[key];
      }
      return value ? content : '';
    });

    // å¤„ç†ç®€å•å˜é‡ {{variableName}}
    for (const [key, value] of Object.entries(variables)) {
      const placeholder = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
      result = result.replace(placeholder, String(value));
    }

    return result;
  }

  /**
   * ç”Ÿæˆå¤‡ç”¨å†…å®¹
   * å½“æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œç”Ÿæˆç®€å•çš„å ä½ç¬¦å†…å®¹
   *
   * @param tool å·¥å…·åç§°
   * @param templateFileName æ¨¡æ¿æ–‡ä»¶å
   * @param variables å˜é‡æ˜ å°„
   * @returns å ä½ç¬¦å†…å®¹
   */
  private generateFallbackContent(tool: string, templateFileName: string, variables: Record<string, unknown>): string {
    const projectName = variables.projectName || 'my-project';
    const persona = variables.persona || 'ä½ æ˜¯ä¸€åèµ„æ·±å·¥ç¨‹å¸ˆ';

    return `# ${projectName} - ${tool.toUpperCase()} é…ç½®

<!-- ç”Ÿæˆè‡ªå¤‡ç”¨æ¨¡æ¿ï¼Œè¯·åˆ›å»ºå®é™…æ¨¡æ¿æ–‡ä»¶: ${templateFileName} -->

## è§’è‰²å®šä¹‰
${persona}

## é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®åç§°: ${projectName}
- å·¥å…·: ${tool}

## ç¼–ç è§„èŒƒ
- ä¿æŒä»£ç ç®€æ´
- éµå¾ªæœ€ä½³å®è·µ
- ç¼–å†™å•å…ƒæµ‹è¯•
`;
  }
}
