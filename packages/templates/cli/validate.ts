// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: åˆ›å»ºæ¨¡æ¿éªŒè¯CLIå‘½ä»¤

import { Command } from 'commander';
import chalk from 'chalk';
import fs from 'fs/promises';
import path from 'path';
import { TemplateValidator } from '../src/validator.js';

/**
 * éªŒè¯æ¨¡æ¿æ–‡ä»¶å‘½ä»¤
 */
export async function validateTemplateCommand(filePath: string, options: any = {}) {
  console.log(chalk.cyan.bold('\nğŸ” éªŒè¯æ¨¡æ¿æ–‡ä»¶\n'));
  console.log(chalk.gray('â”€'.repeat(60)));

  try {
    // è¯»å–æ¨¡æ¿æ–‡ä»¶
    const absolutePath = path.isAbsolute(filePath) 
      ? filePath 
      : path.join(process.cwd(), filePath);
    
    console.log(chalk.gray(`\nğŸ“„ æ¨¡æ¿æ–‡ä»¶: ${absolutePath}\n`));
    
    const templateContent = await fs.readFile(absolutePath, 'utf-8');
    const templateData = JSON.parse(templateContent);
    
    // åˆ›å»ºéªŒè¯å™¨
    const validator = new TemplateValidator();
    
    // æ‰§è¡ŒéªŒè¯
    const result = options.fix 
      ? await validator.validateAndFix(templateData)
      : await validator.validate(templateData);
    
    // æ‰“å°ç»“æœ
    validator.printValidationResult(result);
    
    // å¦‚æœè‡ªåŠ¨ä¿®å¤æˆåŠŸï¼Œä¿å­˜ä¿®å¤åçš„æ–‡ä»¶
    if (result.fixed && result.fixedTemplate && options.fix) {
      if (options.output) {
        // ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶
        await fs.writeFile(
          options.output,
          JSON.stringify(result.fixedTemplate, null, 2),
          'utf-8'
        );
        console.log(chalk.green(`\nâœ… ä¿®å¤åçš„æ¨¡æ¿å·²ä¿å­˜åˆ°: ${options.output}`));
      } else if (options.inPlace) {
        // åŸåœ°ä¿®æ”¹
        await fs.writeFile(
          absolutePath,
          JSON.stringify(result.fixedTemplate, null, 2),
          'utf-8'
        );
        console.log(chalk.green(`\nâœ… æ¨¡æ¿å·²åŸåœ°ä¿®å¤`));
      } else {
        // æ˜¾ç¤ºä¿®å¤åçš„å†…å®¹
        console.log(chalk.cyan('\nğŸ“ ä¿®å¤åçš„æ¨¡æ¿å†…å®¹:'));
        console.log(chalk.gray('â”€'.repeat(60)));
        console.log(JSON.stringify(result.fixedTemplate, null, 2));
      }
    }
    
    console.log(chalk.gray('\n' + 'â”€'.repeat(60)));
    
    // æä¾›ä¸‹ä¸€æ­¥å»ºè®®
    if (!result.valid && !options.fix) {
      console.log(chalk.yellow('\nğŸ’¡ æç¤º:'));
      console.log(chalk.white('  â€¢ è¿è¡Œ ' + chalk.cyan('validate-template --fix') + ' è‡ªåŠ¨ä¿®å¤é”™è¯¯'));
      console.log(chalk.white('  â€¢ è¿è¡Œ ' + chalk.cyan('validate-template --fix --in-place') + ' åŸåœ°ä¿®å¤'));
      console.log(chalk.white('  â€¢ è¿è¡Œ ' + chalk.cyan('validate-template --fix --output <file>') + ' ä¿å­˜åˆ°æ–°æ–‡ä»¶'));
    }
    
    console.log('');
    
    // è¿”å›ç»“æœç 
    process.exit(result.valid ? 0 : 1);
    
  } catch (error: any) {
    console.log(chalk.gray('\n' + 'â”€'.repeat(60)));
    console.error(chalk.red.bold('\nâŒ éªŒè¯å¤±è´¥\n'));
    
    if (error.code === 'ENOENT') {
      console.error(chalk.red('æ–‡ä»¶ä¸å­˜åœ¨: ' + filePath));
    } else if (error instanceof SyntaxError) {
      console.error(chalk.red('JSONæ ¼å¼é”™è¯¯: ' + error.message));
    } else {
      console.error(chalk.red('é”™è¯¯è¯¦æƒ…: ' + error.message));
    }
    
    console.log('');
    process.exit(1);
  }
}

/**
 * æ‰¹é‡éªŒè¯æ¨¡æ¿ç›®å½•
 */
export async function validateTemplatesDir(dirPath: string, options: any = {}) {
  console.log(chalk.cyan.bold('\nğŸ” æ‰¹é‡éªŒè¯æ¨¡æ¿\n'));
  console.log(chalk.gray('â”€'.repeat(60)));

  try {
    const absolutePath = path.isAbsolute(dirPath) 
      ? dirPath 
      : path.join(process.cwd(), dirPath);
    
    console.log(chalk.gray(`\nğŸ“ æ¨¡æ¿ç›®å½•: ${absolutePath}\n`));
    
    // è¯»å–ç›®å½•ä¸­çš„æ‰€æœ‰JSONæ–‡ä»¶
    const files = await fs.readdir(absolutePath);
    const jsonFiles = files.filter(f => f.endsWith('.json'));
    
    if (jsonFiles.length === 0) {
      console.log(chalk.yellow('âš ï¸  æœªæ‰¾åˆ°æ¨¡æ¿æ–‡ä»¶'));
      process.exit(0);
    }
    
    console.log(chalk.white(`æ‰¾åˆ° ${jsonFiles.length} ä¸ªæ¨¡æ¿æ–‡ä»¶\n`));
    
    // éªŒè¯æ¯ä¸ªæ–‡ä»¶
    const validator = new TemplateValidator();
    const results: Array<{ file: string; valid: boolean; errors: number; warnings: number }> = [];
    
    for (const file of jsonFiles) {
      const filePath = path.join(absolutePath, file);
      const templateContent = await fs.readFile(filePath, 'utf-8');
      const templateData = JSON.parse(templateContent);
      
      const result = await validator.validate(templateData);
      
      results.push({
        file,
        valid: result.valid,
        errors: result.errors.filter(e => e.severity === 'error').length,
        warnings: result.warnings.length
      });
      
      // æ‰“å°ç®€è¦ç»“æœ
      const status = result.valid ? chalk.green('âœ“') : chalk.red('âœ—');
      const details = result.valid 
        ? chalk.gray(`(${result.warnings.length} warnings)`)
        : chalk.red(`(${result.errors.filter(e => e.severity === 'error').length} errors)`);
      
      console.log(`${status} ${file} ${details}`);
    }
    
    // æ‰“å°æ€»ç»“
    console.log(chalk.gray('\n' + 'â”€'.repeat(60)));
    const validCount = results.filter(r => r.valid).length;
    const invalidCount = results.length - validCount;
    
    console.log(chalk.cyan('\nğŸ“Š éªŒè¯æ€»ç»“:\n'));
    console.log(chalk.white(`  æ€»è®¡:   ${results.length} ä¸ªæ¨¡æ¿`));
    console.log(chalk.green(`  é€šè¿‡:   ${validCount} ä¸ª`));
    
    if (invalidCount > 0) {
      console.log(chalk.red(`  å¤±è´¥:   ${invalidCount} ä¸ª`));
    }
    
    console.log('');
    
    process.exit(invalidCount > 0 ? 1 : 0);
    
  } catch (error: any) {
    console.log(chalk.gray('\n' + 'â”€'.repeat(60)));
    console.error(chalk.red.bold('\nâŒ éªŒè¯å¤±è´¥\n'));
    console.error(chalk.red('é”™è¯¯è¯¦æƒ…: ' + error.message));
    console.log('');
    process.exit(1);
  }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶
if (import.meta.url === `file://${process.argv[1]}`) {
  const program = new Command();
  
  program
    .name('validate-template')
    .description('éªŒè¯æ¨¡æ¿æ–‡ä»¶æ˜¯å¦ç¬¦åˆSchemaå®šä¹‰')
    .argument('<file>', 'æ¨¡æ¿æ–‡ä»¶è·¯å¾„')
    .option('--fix', 'è‡ªåŠ¨ä¿®å¤é”™è¯¯')
    .option('--in-place', 'åŸåœ°ä¿®æ”¹æ–‡ä»¶')
    .option('--output <file>', 'ä¿å­˜ä¿®å¤åçš„æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„')
    .action(validateTemplateCommand);
  
  program
    .command('dir')
    .description('æ‰¹é‡éªŒè¯ç›®å½•ä¸­çš„æ‰€æœ‰æ¨¡æ¿')
    .argument('<directory>', 'æ¨¡æ¿ç›®å½•è·¯å¾„')
    .action(validateTemplatesDir);
  
  program.parse();
}
