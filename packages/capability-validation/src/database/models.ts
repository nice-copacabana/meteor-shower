// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-17
// Task: 创建M7案例数据库模型（5张表）

/**
 * M7能力验证案例库数据模型
 */

import Database from 'better-sqlite3';

/**
 * 验证案例表模型
 */
export interface ValidationCaseModel {
  id: string;
  title: string;
  category: string;
  difficulty: 'BEGINNER' | 'INTERMEDIATE' | 'EXPERT' | 'MASTER' | 'LEGENDARY';
  description: string;
  scenario: string;
  expected_result: string;
  evaluation_criteria: string;  // JSON字符串
  author_id: string;
  status: 'DRAFT' | 'PUBLISHED' | 'ARCHIVED';
  created_at: number;
  updated_at: number;
  rating: number;
  execution_count: number;
}

/**
 * 案例标签表模型
 */
export interface CaseTagModel {
  id: string;
  case_id: string;
  tag_name: string;
  created_at: number;
}

/**
 * 案例版本表模型
 */
export interface CaseVersionModel {
  id: string;
  case_id: string;
  version: number;
  content: string;  // JSON字符串
  change_log: string;
  created_at: number;
  created_by: string;
}

/**
 * 案例执行表模型
 */
export interface CaseExecutionModel {
  id: string;
  case_id: string;
  tool_name: 'GEMINI' | 'CLAUDE' | 'CURSOR' | 'OPENAI';
  config_id: string | null;
  result: string | null;
  scores: string;  // JSON字符串
  execution_time: number;
  created_at: number;
  user_id: string;
}

/**
 * 案例评价表模型
 */
export interface CaseRatingModel {
  id: string;
  case_id: string;
  user_id: string;
  rating: number;
  comment: string | null;
  created_at: number;
}

/**
 * 创建所有表的SQL语句
 */
export const CREATE_TABLES_SQL_M7 = {
  validation_cases: `
    CREATE TABLE IF NOT EXISTS validation_cases (
      id TEXT PRIMARY KEY,
      title TEXT NOT NULL,
      category TEXT NOT NULL,
      difficulty TEXT NOT NULL CHECK(difficulty IN ('BEGINNER', 'INTERMEDIATE', 'EXPERT', 'MASTER', 'LEGENDARY')),
      description TEXT NOT NULL,
      scenario TEXT NOT NULL,
      expected_result TEXT NOT NULL,
      evaluation_criteria TEXT,
      author_id TEXT NOT NULL,
      status TEXT NOT NULL CHECK(status IN ('DRAFT', 'PUBLISHED', 'ARCHIVED')),
      created_at INTEGER NOT NULL,
      updated_at INTEGER NOT NULL,
      rating REAL DEFAULT 0.0,
      execution_count INTEGER DEFAULT 0
    )
  `,

  case_tags: `
    CREATE TABLE IF NOT EXISTS case_tags (
      id TEXT PRIMARY KEY,
      case_id TEXT NOT NULL,
      tag_name TEXT NOT NULL,
      created_at INTEGER NOT NULL,
      FOREIGN KEY (case_id) REFERENCES validation_cases(id) ON DELETE CASCADE
    )
  `,

  case_versions: `
    CREATE TABLE IF NOT EXISTS case_versions (
      id TEXT PRIMARY KEY,
      case_id TEXT NOT NULL,
      version INTEGER NOT NULL,
      content TEXT NOT NULL,
      change_log TEXT,
      created_at INTEGER NOT NULL,
      created_by TEXT NOT NULL,
      FOREIGN KEY (case_id) REFERENCES validation_cases(id) ON DELETE CASCADE
    )
  `,

  case_executions: `
    CREATE TABLE IF NOT EXISTS case_executions (
      id TEXT PRIMARY KEY,
      case_id TEXT NOT NULL,
      tool_name TEXT NOT NULL CHECK(tool_name IN ('GEMINI', 'CLAUDE', 'CURSOR', 'OPENAI')),
      config_id TEXT,
      result TEXT,
      scores TEXT NOT NULL,
      execution_time INTEGER NOT NULL,
      created_at INTEGER NOT NULL,
      user_id TEXT NOT NULL,
      FOREIGN KEY (case_id) REFERENCES validation_cases(id) ON DELETE CASCADE
    )
  `,

  case_ratings: `
    CREATE TABLE IF NOT EXISTS case_ratings (
      id TEXT PRIMARY KEY,
      case_id TEXT NOT NULL,
      user_id TEXT NOT NULL,
      rating INTEGER NOT NULL CHECK(rating >= 1 AND rating <= 5),
      comment TEXT,
      created_at INTEGER NOT NULL,
      FOREIGN KEY (case_id) REFERENCES validation_cases(id) ON DELETE CASCADE,
      UNIQUE(case_id, user_id)
    )
  `,
};

/**
 * 创建索引的SQL语句
 */
export const CREATE_INDEXES_SQL_M7 = [
  'CREATE INDEX IF NOT EXISTS idx_cases_category ON validation_cases(category)',
  'CREATE INDEX IF NOT EXISTS idx_cases_difficulty ON validation_cases(difficulty)',
  'CREATE INDEX IF NOT EXISTS idx_cases_author ON validation_cases(author_id)',
  'CREATE INDEX IF NOT EXISTS idx_cases_status ON validation_cases(status)',
  'CREATE INDEX IF NOT EXISTS idx_tags_case ON case_tags(case_id)',
  'CREATE INDEX IF NOT EXISTS idx_versions_case ON case_versions(case_id)',
  'CREATE INDEX IF NOT EXISTS idx_executions_case ON case_executions(case_id)',
  'CREATE INDEX IF NOT EXISTS idx_executions_tool ON case_executions(tool_name)',
  'CREATE INDEX IF NOT EXISTS idx_executions_user ON case_executions(user_id)',
  'CREATE INDEX IF NOT EXISTS idx_executions_created ON case_executions(created_at)',
  'CREATE INDEX IF NOT EXISTS idx_ratings_case ON case_ratings(case_id)',
];

/**
 * 初始化M7数据库
 */
export function initializeDatabaseM7(db: Database.Database): void {
  db.pragma('foreign_keys = ON');

  Object.values(CREATE_TABLES_SQL_M7).forEach(sql => {
    db.exec(sql);
  });

  CREATE_INDEXES_SQL_M7.forEach(sql => {
    db.exec(sql);
  });

  console.log('✅ M7数据库初始化完成（5张表）');
}
