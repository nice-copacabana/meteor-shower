// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-15
// Task: M6 Phase5 - 定价页面交互逻辑

document.addEventListener('DOMContentLoaded', () => {
    // 计费周期切换
    const billingToggle = document.getElementById('billingToggle');
    const monthlyPrices = document.querySelectorAll('.price.monthly, .period.monthly');
    const yearlyPrices = document.querySelectorAll('.price.yearly, .period.yearly');

    if (billingToggle) {
        billingToggle.addEventListener('change', (e) => {
            const isYearly = e.target.checked;
            
            monthlyPrices.forEach(el => {
                el.style.display = isYearly ? 'none' : 'inline';
            });
            
            yearlyPrices.forEach(el => {
                el.style.display = isYearly ? 'inline' : 'none';
            });
        });
    }

    // CTA 按钮点击处理
    const ctaButtons = document.querySelectorAll('.cta-button');
    ctaButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const buttonClass = e.target.className;
            
            if (buttonClass.includes('free-button')) {
                handleFreePlan();
            } else if (buttonClass.includes('pro-button')) {
                handleProPlan();
            } else if (buttonClass.includes('team-button')) {
                handleTeamPlan();
            } else if (buttonClass.includes('enterprise-button')) {
                handleEnterprisePlan();
            } else if (buttonClass.includes('large-button')) {
                handleFreePlan();
            }
        });
    });

    // FAQ 折叠/展开
    const faqItems = document.querySelectorAll('.faq-item');
    faqItems.forEach(item => {
        item.addEventListener('click', () => {
            item.classList.toggle('active');
        });
    });

    // 滚动动画
    observeElements();
});

/**
 * 处理免费版注册
 */
function handleFreePlan() {
    console.log('注册免费版');
    // 跳转到注册页面
    window.location.href = '/register?plan=free';
}

/**
 * 处理专业版升级
 */
function handleProPlan() {
    console.log('升级到专业版');
    const isYearly = document.getElementById('billingToggle').checked;
    const plan = isYearly ? 'pro_yearly' : 'pro_monthly';
    
    // 检查用户是否已登录
    if (!isUserLoggedIn()) {
        // 跳转到登录页面，携带升级意图
        window.location.href = `/login?redirect=/upgrade&plan=${plan}`;
    } else {
        // 跳转到升级页面
        window.location.href = `/upgrade?plan=${plan}`;
    }
}

/**
 * 处理团队版咨询
 */
function handleTeamPlan() {
    console.log('咨询团队版');
    const isYearly = document.getElementById('billingToggle').checked;
    const plan = isYearly ? 'team_yearly' : 'team_monthly';
    
    // 跳转到联系销售页面
    window.location.href = `/contact-sales?plan=${plan}`;
}

/**
 * 处理企业版咨询
 */
function handleEnterprisePlan() {
    console.log('咨询企业版');
    // 跳转到企业咨询页面
    window.location.href = '/contact-sales?plan=enterprise';
}

/**
 * 检查用户是否已登录
 */
function isUserLoggedIn() {
    // 实际项目中从 localStorage 或 cookie 检查登录状态
    return localStorage.getItem('authToken') !== null;
}

/**
 * 元素进入视口时添加动画
 */
function observeElements() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, {
        threshold: 0.1
    });

    // 观察所有卡片
    document.querySelectorAll('.pricing-card, .testimonial-card, .faq-item').forEach(el => {
        observer.observe(el);
    });
}

/**
 * 获取当前选择的计费周期
 */
function getCurrentBillingCycle() {
    const billingToggle = document.getElementById('billingToggle');
    return billingToggle && billingToggle.checked ? 'yearly' : 'monthly';
}

/**
 * 格式化价格显示
 */
function formatPrice(amount, currency = '¥') {
    return `${currency}${amount.toLocaleString('zh-CN')}`;
}

/**
 * 计算年付节省金额
 */
function calculateYearlySavings(monthlyPrice, yearlyPrice) {
    const monthlyTotal = monthlyPrice * 12;
    const savings = monthlyTotal - yearlyPrice;
    const percentage = Math.round((savings / monthlyTotal) * 100);
    return { amount: savings, percentage };
}

/**
 * 显示价格计算器弹窗
 */
function showPriceCalculator() {
    // 创建价格计算器弹窗
    const modal = document.createElement('div');
    modal.className = 'price-calculator-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>价格计算器</h3>
            <div class="calculator-form">
                <label>
                    选择方案:
                    <select id="planSelect">
                        <option value="pro">专业版</option>
                        <option value="team">团队版</option>
                    </select>
                </label>
                <label id="seatsLabel" style="display:none;">
                    席位数量:
                    <input type="number" id="seatsInput" min="3" max="50" value="5">
                </label>
                <label>
                    计费周期:
                    <select id="cycleSelect">
                        <option value="monthly">月付</option>
                        <option value="yearly">年付 (省17%)</option>
                    </select>
                </label>
            </div>
            <div class="calculator-result">
                <h4>总价: <span id="totalPrice">¥99</span></h4>
                <p id="savingsInfo"></p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="closeCalculator()">确定</button>
                <button class="btn-secondary" onclick="closeCalculator()">取消</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 添加事件监听
    setupCalculatorListeners();
}

/**
 * 设置计算器事件监听
 */
function setupCalculatorListeners() {
    const planSelect = document.getElementById('planSelect');
    const seatsInput = document.getElementById('seatsInput');
    const cycleSelect = document.getElementById('cycleSelect');
    
    if (planSelect) {
        planSelect.addEventListener('change', updateCalculation);
    }
    
    if (seatsInput) {
        seatsInput.addEventListener('input', updateCalculation);
    }
    
    if (cycleSelect) {
        cycleSelect.addEventListener('change', updateCalculation);
    }
    
    updateCalculation();
}

/**
 * 更新价格计算
 */
function updateCalculation() {
    const plan = document.getElementById('planSelect')?.value;
    const seats = parseInt(document.getElementById('seatsInput')?.value || '1');
    const cycle = document.getElementById('cycleSelect')?.value;
    
    const prices = {
        pro: { monthly: 99, yearly: 999 },
        team: { monthly: 299, yearly: 2999 }
    };
    
    let price = prices[plan][cycle];
    if (plan === 'team') {
        price *= seats;
        document.getElementById('seatsLabel').style.display = 'block';
    } else {
        document.getElementById('seatsLabel').style.display = 'none';
    }
    
    document.getElementById('totalPrice').textContent = formatPrice(price);
    
    // 显示节省信息
    if (cycle === 'yearly') {
        const monthlyTotal = prices[plan].monthly * 12 * (plan === 'team' ? seats : 1);
        const savings = monthlyTotal - price;
        document.getElementById('savingsInfo').textContent = 
            `相比月付节省 ${formatPrice(savings)} (${Math.round((savings / monthlyTotal) * 100)}%)`;
    } else {
        document.getElementById('savingsInfo').textContent = '';
    }
}

/**
 * 关闭计算器
 */
function closeCalculator() {
    const modal = document.querySelector('.price-calculator-modal');
    if (modal) {
        modal.remove();
    }
}

// 导出功能供外部使用
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        handleFreePlan,
        handleProPlan,
        handleTeamPlan,
        handleEnterprisePlan,
        showPriceCalculator,
        getCurrentBillingCycle,
        formatPrice,
        calculateYearlySavings
    };
}
