// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°OpenAIé€‚é…å™¨å®Œæ•´æ–‡ä»¶å†™å…¥é€»è¾‘ï¼ŒåŒ…å«AGENTS.mdå’Œç¯å¢ƒå˜é‡é…ç½®

import { Adapter, ApplyContext, DiffResult } from './index.js';
import { FileOperations } from '@meteor-shower/utils';
import chalk from 'chalk';
import fs from 'fs/promises';
import path from 'path';
import os from 'os';

/**
 * OpenAI é€‚é…å™¨ç±»
 * å®ç° Adapter æ¥å£ï¼Œæä¾› OpenAI API çš„é…ç½®ç®¡ç†
 * 
 * é…ç½®æ–‡ä»¶ï¼š
 * - ./AGENTS.md: AI Agent é…ç½®æ–‡æ¡£
 * - ./.env.example: ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
 * - ./OPENAI.local.md: æœ¬åœ°è¦†ç›–é…ç½®ï¼ˆä¸æäº¤åˆ°Gitï¼‰
 */
export class OpenAIAdapter implements Adapter {
  private fileOps: FileOperations;
  private backupPaths: Map<string, string> = new Map();

  constructor() {
    this.fileOps = new FileOperations();
  }

  /**
   * è§„åˆ’é…ç½®å˜æ›´
   * åˆ†æå°†è¦è¿›è¡Œçš„é…ç½®å˜æ›´ï¼Œè¿”å›å˜æ›´è¯¦æƒ…
   */
  async plan(ctx: ApplyContext): Promise<DiffResult> {
    console.log(chalk.gray('ğŸ“‹ è§„åˆ’ OpenAI é…ç½®å˜æ›´...'));
    
    const projectRoot = process.cwd();
    const changes = [];

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    const agentsPath = path.join(projectRoot, 'AGENTS.md');
    const envPath = path.join(projectRoot, '.env.example');
    const localPath = path.join(projectRoot, 'OPENAI.local.md');

    try {
      await fs.access(agentsPath);
      changes.push({ path: './AGENTS.md', kind: 'update' });
    } catch {
      changes.push({ path: './AGENTS.md', kind: 'create' });
    }

    try {
      await fs.access(envPath);
      changes.push({ path: './.env.example', kind: 'update' });
    } catch {
      changes.push({ path: './.env.example', kind: 'create' });
    }

    try {
      await fs.access(localPath);
      changes.push({ path: './OPENAI.local.md', kind: 'update' });
    } catch {
      changes.push({ path: './OPENAI.local.md', kind: 'create' });
    }
    
    return {
      changes,
      summary: `å°†${changes.filter(c => c.kind === 'create').length > 0 ? 'åˆ›å»º' : 'æ›´æ–°'} OpenAI é…ç½®æ–‡ä»¶`
    };
  }

  /**
   * åº”ç”¨é…ç½®
   * æ‰§è¡Œå®é™…çš„é…ç½®å†™å…¥æ“ä½œ
   */
  async apply(ctx: ApplyContext): Promise<void> {
    console.log(chalk.green('âš¡ åº”ç”¨ OpenAI é…ç½®...'));
    
    if (ctx.dryRun) {
      console.log(chalk.yellow('ğŸ” æ¨¡æ‹Ÿæ¨¡å¼ï¼šè·³è¿‡å®é™…å†™å…¥'));
      return;
    }
    
    try {
      await this.writeOpenAIConfigs(ctx);
      console.log(chalk.green('âœ… OpenAI é…ç½®åº”ç”¨å®Œæˆ'));
    } catch (error) {
      console.error(chalk.red('âŒ OpenAI é…ç½®åº”ç”¨å¤±è´¥'));
      await this.rollback(ctx);
      throw error;
    }
  }

  /**
   * å›æ»šé…ç½®
   * å°†é…ç½®æ¢å¤åˆ°åº”ç”¨å‰çš„çŠ¶æ€
   */
  async rollback(ctx: ApplyContext): Promise<void> {
    console.log(chalk.yellow('ğŸ”„ å›æ»š OpenAI é…ç½®...'));
    
    for (const [originalPath, backupPath] of this.backupPaths) {
      try {
        await this.fileOps.rollbackFromBackup(backupPath, originalPath);
        console.log(chalk.gray(`  âœ… æ¢å¤ ${originalPath}`));
      } catch (error) {
        console.error(chalk.red(`  âŒ å›æ»šå¤±è´¥ ${originalPath}: ${error}`));
      }
    }
    
    this.backupPaths.clear();
    console.log(chalk.green('âœ… OpenAI é…ç½®å›æ»šå®Œæˆ'));
  }

  /**
   * å†™å…¥ OpenAI é…ç½®æ–‡ä»¶
   * æ ¹æ®å˜é‡ç”Ÿæˆå®é™…çš„é…ç½®æ–‡ä»¶
   */
  private async writeOpenAIConfigs(ctx: ApplyContext): Promise<void> {
    const projectRoot = process.cwd();
    
    const configs = [
      {
        target: path.join(projectRoot, 'AGENTS.md'),
        content: this.generateAgentsMarkdown(ctx.variables),
        description: 'AI Agent é…ç½®æ–‡æ¡£'
      },
      {
        target: path.join(projectRoot, '.env.example'),
        content: this.generateEnvExample(ctx.variables),
        description: 'ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶'
      },
      {
        target: path.join(projectRoot, 'OPENAI.local.md'),
        content: this.generateLocalConfig(ctx.variables),
        description: 'æœ¬åœ°è¦†ç›–é…ç½®'
      }
    ];

    for (const config of configs) {
      try {
        // å¤‡ä»½ç°æœ‰æ–‡ä»¶
        try {
          await fs.access(config.target);
          const backupPath = await this.fileOps.createBackup(config.target);
          this.backupPaths.set(config.target, backupPath);
        } catch {
          // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€å¤‡ä»½
        }

        // ç¡®ä¿ç›®å½•å­˜åœ¨
        await fs.mkdir(path.dirname(config.target), { recursive: true });
        
        // å†™å…¥æ–‡ä»¶
        await fs.writeFile(config.target, config.content, 'utf-8');
        console.log(chalk.gray(`  âœ… å†™å…¥ ${config.description}: ${config.target}`));
      } catch (error) {
        console.error(chalk.red(`  âŒ å†™å…¥å¤±è´¥ ${config.description}: ${error}`));
        throw error;
      }
    }
  }

  /**
   * ç”Ÿæˆ AGENTS.md é…ç½®å†…å®¹
   */
  private generateAgentsMarkdown(variables: Record<string, unknown>): string {
    const projectName = variables.projectName || 'my-project';
    const persona = variables.persona || 'ä½ æ˜¯ä¸€åèµ„æ·±çš„å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ';
    const techStack = Array.isArray(variables.techStack) ? variables.techStack : ['TypeScript', 'Node.js'];
    const codingStyle = variables.codingStyle || 'clean-code';

    return `# ${projectName} - AI Agents é…ç½®

<!-- Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14 -->
<!-- Task: OpenAI é€‚é…å™¨ç”Ÿæˆçš„ AI Agent é…ç½®æ–‡æ¡£ -->

## ğŸ¤– AI è§’è‰²è®¾å®š

${persona}

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

${techStack.map((tech: any) => `- ${tech}`).join('\n')}

## ğŸ“ ä»£ç é£æ ¼

**ç¼–ç è§„èŒƒ**: ${codingStyle}

### é€šç”¨åŸåˆ™

- ä¼˜å…ˆä½¿ç”¨ç°ä»£è¯­æ³•ç‰¹æ€§
- ä¿æŒä»£ç ç®€æ´å’Œå¯è¯»æ€§
- éµå¾ªå•ä¸€èŒè´£åŸåˆ™
- ç¼–å†™è‡ªè§£é‡Šçš„ä»£ç 

### å‘½åçº¦å®š

- **å˜é‡å’Œå‡½æ•°**: camelCase
- **ç±»å’Œæ¥å£**: PascalCase
- **å¸¸é‡**: UPPER_SNAKE_CASE
- **ç§æœ‰æˆå‘˜**: å‰ç¼€ä¸‹åˆ’çº¿ _privateMethod

### æ³¨é‡Šè§„èŒƒ

- ä½¿ç”¨ JSDoc ä¸ºå…¬å…± API æ·»åŠ æ–‡æ¡£
- å¤æ‚é€»è¾‘æ·»åŠ è¡Œå†…æ³¨é‡Šè¯´æ˜æ„å›¾
- é¿å…æ˜¾è€Œæ˜“è§çš„æ³¨é‡Š

## ğŸ§ª æµ‹è¯•è¦æ±‚

- æ ¸å¿ƒåŠŸèƒ½å¿…é¡»æœ‰å•å…ƒæµ‹è¯•
- æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡ > 80%
- ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
- éµå¾ª AAA æ¨¡å¼ (Arrange-Act-Assert)

## ğŸ”’ å®‰å…¨è§„èŒƒ

- æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡
- è¾“å…¥éªŒè¯å’Œæ¸…ç†
- é˜²æ­¢ SQL æ³¨å…¥å’Œ XSS æ”»å‡»
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢

## ğŸ“¦ ä¾èµ–ç®¡ç†

- å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬
- å®¡æŸ¥æ–°å¢ä¾èµ–çš„å¿…è¦æ€§
- ä¼˜å…ˆé€‰æ‹©ç»´æŠ¤æ´»è·ƒçš„åº“
- é¿å…å¼•å…¥è¿‡é‡çš„ä¾èµ–

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

- é¿å…ä¸å¿…è¦çš„é‡å¤è®¡ç®—
- ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„
- è€ƒè™‘å¼‚æ­¥æ“ä½œçš„æ€§èƒ½å½±å“
- åŠæ—¶é‡Šæ”¾èµ„æº

## ğŸ“ æäº¤è§„èŒƒ

éµå¾ª Conventional Commits æ ¼å¼ï¼š

\`\`\`
<type>(<scope>): <subject>

<body>

<footer>
\`\`\`

**ç±»å‹ (type)**:
- feat: æ–°åŠŸèƒ½
- fix: ä¿®å¤ bug
- docs: æ–‡æ¡£æ›´æ–°
- style: ä»£ç æ ¼å¼è°ƒæ•´
- refactor: é‡æ„
- test: æµ‹è¯•ç›¸å…³
- chore: æ„å»º/å·¥å…·å˜æ›´

## ğŸ”— ç›¸å…³é…ç½®

- ç¯å¢ƒå˜é‡é…ç½®å‚è€ƒ \`.env.example\`
- æœ¬åœ°è¦†ç›–é…ç½®å¯åœ¨ \`OPENAI.local.md\` ä¸­å®šä¹‰
`;
  }

  /**
   * ç”Ÿæˆ .env.example ç¯å¢ƒå˜é‡ç¤ºä¾‹
   */
  private generateEnvExample(variables: Record<string, unknown>): string {
    const projectName = variables.projectName || 'my-project';
    const includeDatabase = variables.features && Array.isArray(variables.features) 
      ? (variables.features as string[]).includes('database') 
      : false;

    let content = `# ${projectName} - ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹
# Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14

# ==========================================
# OpenAI API é…ç½®
# ==========================================

# OpenAI API å¯†é’¥
OPENAI_API_KEY=sk-your-api-key-here

# OpenAI API åŸºç¡€ URLï¼ˆå¯é€‰ï¼Œç”¨äºä»£ç†æˆ–è‡ªå®šä¹‰ç«¯ç‚¹ï¼‰
# OPENAI_API_BASE=https://api.openai.com/v1

# é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹
OPENAI_MODEL=gpt-4-turbo-preview

# æ¸©åº¦å‚æ•°ï¼ˆ0-2ï¼Œæ§åˆ¶è¾“å‡ºéšæœºæ€§ï¼‰
OPENAI_TEMPERATURE=0.7

# æœ€å¤§ tokens æ•°
OPENAI_MAX_TOKENS=4096

# ==========================================
# åº”ç”¨é…ç½®
# ==========================================

# åº”ç”¨ç¯å¢ƒ (development/production/test)
NODE_ENV=development

# åº”ç”¨ç«¯å£
PORT=3000

# æ—¥å¿—çº§åˆ« (debug/info/warn/error)
LOG_LEVEL=info

`;

    if (includeDatabase) {
      content += `# ==========================================
# æ•°æ®åº“é…ç½®
# ==========================================

# æ•°æ®åº“ URL
DATABASE_URL=postgresql://user:password@localhost:5432/dbname

# Redis URLï¼ˆç”¨äºç¼“å­˜å’Œä¼šè¯ï¼‰
REDIS_URL=redis://localhost:6379

`;
    }

    content += `# ==========================================
# å®‰å…¨é…ç½®
# ==========================================

# JWT å¯†é’¥ï¼ˆç”¨äºèº«ä»½éªŒè¯ï¼‰
JWT_SECRET=your-secret-key-change-in-production

# JWT è¿‡æœŸæ—¶é—´
JWT_EXPIRES_IN=7d

# CORS å…è®¸çš„æº
CORS_ORIGIN=http://localhost:3000

# ==========================================
# å…¶ä»–é…ç½®
# ==========================================

# æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
DEBUG=false

# API é€Ÿç‡é™åˆ¶ï¼ˆè¯·æ±‚æ•°/åˆ†é’Ÿï¼‰
RATE_LIMIT=100
`;

    return content;
  }

  /**
   * ç”Ÿæˆæœ¬åœ°è¦†ç›–é…ç½®æ–‡ä»¶
   */
  private generateLocalConfig(variables: Record<string, unknown>): string {
    return `# æœ¬åœ°è¦†ç›–é…ç½®

<!-- Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14 -->
<!-- æ­¤æ–‡ä»¶ç”¨äºæœ¬åœ°å¼€å‘æ—¶è¦†ç›– AGENTS.md ä¸­çš„é…ç½®ï¼Œä¸åº”æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ -->

## ğŸ“ è¯´æ˜

æ­¤æ–‡ä»¶ç”¨äºå®šä¹‰ä»…åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒç”Ÿæ•ˆçš„é…ç½®ï¼Œä¼šè¦†ç›– \`AGENTS.md\` ä¸­çš„ç›¸åº”è®¾ç½®ã€‚

å»ºè®®å°†æ­¤æ–‡ä»¶æ·»åŠ åˆ° \`.gitignore\` ä¸­ï¼Œé¿å…æäº¤ä¸ªäººé…ç½®åˆ°ä»£ç ä»“åº“ã€‚

## ğŸ› ï¸ æœ¬åœ°é…ç½®ç¤ºä¾‹

### è‡ªå®šä¹‰ AI è§’è‰²

\`\`\`markdown
ä½ æ˜¯ä¸€åä¸“æ³¨äºæ€§èƒ½ä¼˜åŒ–çš„é«˜çº§å·¥ç¨‹å¸ˆï¼Œæ“…é•¿å‘ç°å’Œè§£å†³æ€§èƒ½ç“¶é¢ˆã€‚
\`\`\`

### ä¸ªäººåå¥½è®¾ç½®

- æ›´è¯¦ç»†çš„ä»£ç æ³¨é‡Š
- åå¥½å‡½æ•°å¼ç¼–ç¨‹é£æ ¼
- ä¼˜å…ˆè€ƒè™‘ä»£ç æ€§èƒ½

### å¼€å‘å·¥å…·é…ç½®

- ä½¿ç”¨ Vim å¿«æ·é”®
- è‡ªåŠ¨ä¿å­˜é—´éš”ï¼š5ç§’
- ä»£ç æ ¼å¼åŒ–ï¼šä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ–

## ğŸ”§ ç¯å¢ƒç‰¹å®šé…ç½®

### å¼€å‘ç¯å¢ƒ

- å¯ç”¨è¯¦ç»†æ—¥å¿—
- å…³é—­æŸäº›æ€§èƒ½ä¼˜åŒ–ä»¥ä¾¿è°ƒè¯•
- ä½¿ç”¨æœ¬åœ°æ•°æ®åº“

### è°ƒè¯•é…ç½®

- æ–­ç‚¹è®¾ç½®åå¥½
- æ—¥å¿—è¿‡æ»¤è§„åˆ™
- æ€§èƒ½åˆ†æå·¥å…·é…ç½®
`;
  }
}
