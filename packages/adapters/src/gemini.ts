// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°Geminié€‚é…å™¨å®Œæ•´æ–‡ä»¶å†™å…¥é€»è¾‘ï¼ˆå‚è€ƒClaude/Cursoræ¨¡å¼ï¼‰

/**
 * Gemini é€‚é…å™¨å®ç°
 * è´Ÿè´£ Google Gemini AI æ¨¡å‹çš„é…ç½®æ–‡ä»¶ç®¡ç†
 *
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - ç”Ÿæˆ Gemini ä¸»é…ç½®æ–‡ä»¶ (GEMINI.md)
 * - ç”Ÿæˆè®¾ç½®æ–‡ä»¶ (settings.json)
 * - ç”Ÿæˆå‘½ä»¤è§„åˆ’æ–‡ä»¶ (plan.toml)
 * - æ”¯æŒæ–‡ä»¶å¤‡ä»½å’Œå›æ»š
 *
 * æ–‡ä»¶ä½ç½®ï¼š
 * - ~/.gemini/GEMINI.md - å…¨å±€ä¸»é…ç½®
 * - ~/.gemini/settings.json - API è®¾ç½®
 * - .gemini/commands/plan.toml - é¡¹ç›®å‘½ä»¤é…ç½®
 */

import { Adapter, ApplyContext, DiffResult } from './index.js';
import chalk from 'chalk';
import fs from 'fs/promises';
import path from 'path';
import os from 'os';

/**
 * Gemini é€‚é…å™¨ç±»
 * å®ç° Adapter æ¥å£ï¼Œæä¾› Gemini é…ç½®çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†
 */
export class GeminiAdapter implements Adapter {
  // å¤‡ä»½æ–‡ä»¶è·¯å¾„æ˜ å°„ï¼šåŸå§‹è·¯å¾„ -> å¤‡ä»½è·¯å¾„
  private backupPaths: Map<string, string> = new Map();

  /**
   * è§„åˆ’é…ç½®å˜æ›´
   * åˆ†æå°†è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„é…ç½®æ–‡ä»¶ï¼Œä¸å®é™…ä¿®æ”¹
   *
   * @param ctx åº”ç”¨ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«å˜é‡å’Œé…ç½®
   * @returns å·®å¼‚ç»“æœï¼ŒåŒ…å«å˜æ›´åˆ—è¡¨å’Œæ‘˜è¦
   */
  async plan(ctx: ApplyContext): Promise<DiffResult> {
    console.log(chalk.gray('ğŸ“‹ è§„åˆ’ Gemini é…ç½®å˜æ›´...'));
    
    return {
      changes: [
        { path: '~/.gemini/GEMINI.md', kind: 'create' },
        { path: '~/.gemini/settings.json', kind: 'create' },
        { path: './.gemini/commands/plan.toml', kind: 'create' }
      ],
      summary: 'å°†åˆ›å»º 3 ä¸ª Gemini é…ç½®æ–‡ä»¶'
    };
  }

  /**
   * åº”ç”¨é…ç½®å˜æ›´
   * å®é™…å†™å…¥ Gemini é…ç½®æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿ
   *
   * å·¥ä½œæµç¨‹ï¼š
   * 1. æ£€æŸ¥æ˜¯å¦ä¸º dryRun æ¨¡å¼
   * 2. è°ƒç”¨ writeGeminiConfigs å†™å…¥æ–‡ä»¶
   *
   * @param ctx åº”ç”¨ä¸Šä¸‹æ–‡
   */
  async apply(ctx: ApplyContext): Promise<void> {
    console.log(chalk.green('âš¡ åº”ç”¨ Gemini é…ç½®...'));
    
    if (ctx.dryRun) {
      console.log(chalk.yellow('ğŸ” æ¨¡æ‹Ÿæ¨¡å¼ï¼šè·³è¿‡å®é™…å†™å…¥'));
      return;
    }
    
    await this.writeGeminiConfigs(ctx);
  }

  /**
   * å›æ»šé…ç½®å˜æ›´
   * ä»å¤‡ä»½æ–‡ä»¶æ¢å¤åŸå§‹é…ç½®ï¼Œç”¨äºé”™è¯¯æ¢å¤
   *
   * å›æ»šé€»è¾‘ï¼š
   * 1. éå†æ‰€æœ‰å¤‡ä»½æ–‡ä»¶
   * 2. å°†å¤‡ä»½å†…å®¹æ¢å¤åˆ°åŸå§‹ä½ç½®
   * 3. æ¸…ç©ºå¤‡ä»½è®°å½•
   *
   * @param ctx åº”ç”¨ä¸Šä¸‹æ–‡
   */
  async rollback(ctx: ApplyContext): Promise<void> {
    console.log(chalk.yellow('ğŸ”„ å›æ»š Gemini é…ç½®...'));
    
    for (const [originalPath, backupPath] of this.backupPaths) {
      try {
        const content = await fs.readFile(backupPath, 'utf-8');
        await fs.writeFile(originalPath, content, 'utf-8');
        console.log(chalk.yellow(`  ğŸ”„ å›æ»š: ${originalPath}`));
      } catch (error) {
        console.error(chalk.red(`  âŒ å›æ»šå¤±è´¥ ${originalPath}: ${error}`));
      }
    }
    
    this.backupPaths.clear();
    console.log(chalk.green('âœ… Gemini é…ç½®å›æ»šå®Œæˆ'));
  }

  /**
   * å†™å…¥ Gemini é…ç½®æ–‡ä»¶
   * æ ¸å¿ƒæ–‡ä»¶å†™å…¥é€»è¾‘ï¼Œå¤„ç†å¤‡ä»½ã€ç›®å½•åˆ›å»ºå’Œæ–‡ä»¶å†™å…¥
   *
   * å·¥ä½œæµç¨‹ï¼š
   * 1. å®šä¹‰éœ€è¦å†™å…¥çš„é…ç½®æ–‡ä»¶åˆ—è¡¨
   * 2. å¯¹æ¯ä¸ªæ–‡ä»¶ï¼š
   *    a. å¤‡ä»½ç°æœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
   *    b. åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
   *    c. å†™å…¥æ–°é…ç½®å†…å®¹
   * 3. è®°å½•å¤‡ä»½è·¯å¾„ï¼Œç”¨äºå›æ»š
   *
   * @param ctx åº”ç”¨ä¸Šä¸‹æ–‡
   */
  private async writeGeminiConfigs(ctx: ApplyContext): Promise<void> {
    const homeDir = os.homedir();
    const projectRoot = process.cwd();
    
    // å®šä¹‰éœ€è¦ç”Ÿæˆçš„ä¸‰ä¸ªé…ç½®æ–‡ä»¶
    const configs = [
      {
        target: path.join(homeDir, '.gemini', 'GEMINI.md'),
        content: this.generateGeminiMd(ctx.variables),
        description: 'Gemini ä¸»é…ç½®æ–‡ä»¶'
      },
      {
        target: path.join(homeDir, '.gemini', 'settings.json'),
        content: this.generateSettingsJson(ctx.variables),
        description: 'Gemini è®¾ç½®æ–‡ä»¶'
      },
      {
        target: path.join(projectRoot, '.gemini', 'commands', 'plan.toml'),
        content: this.generatePlanToml(ctx.variables),
        description: 'Gemini å‘½ä»¤è§„åˆ’æ–‡ä»¶'
      }
    ];

    // ä¾æ¬¡å¤„ç†æ¯ä¸ªé…ç½®æ–‡ä»¶
    for (const config of configs) {
      try {
        // ========== å¤‡ä»½ç°æœ‰æ–‡ä»¶ ==========
        // å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå…ˆè¿›è¡Œå¤‡ä»½ä»¥ä¾¿å›æ»š
        try {
          await fs.access(config.target);
          const backup = `${config.target}.backup`;
          await fs.copyFile(config.target, backup);
          this.backupPaths.set(config.target, backup);
        } catch {
          // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€å¤‡ä»½
        }

        // ========== åˆ›å»ºç›®å½•å’Œå†™å…¥æ–‡ä»¶ ==========
        // ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨
        await fs.mkdir(path.dirname(config.target), { recursive: true });
        
        // å†™å…¥æ–‡ä»¶
        await fs.writeFile(config.target, config.content, 'utf-8');
        console.log(chalk.gray(`  âœ… å†™å…¥ ${config.description}: ${config.target}`));
      } catch (error) {
        console.error(chalk.red(`  âŒ å†™å…¥å¤±è´¥ ${config.description}: ${error}`));
        throw error;
      }
    }
  }

  /**
   * ç”Ÿæˆ GEMINI.md ä¸»é…ç½®æ–‡ä»¶
   * åŒ…å«è§’è‰²å®šä½ã€ç¼–ç è§„èŒƒã€å¼€å‘æµç¨‹ç­‰
   *
   * @param variables é…ç½®å˜é‡
   * @returns Markdown æ ¼å¼çš„é…ç½®å†…å®¹
   */
  private generateGeminiMd(variables: Record<string, unknown>): string {
    const projectName = variables.projectName || 'my-project';
    const persona = variables.persona || 'ä½ æ˜¯ä¸€å AI è¾…åŠ©å¼€å‘ä¸“å®¶';
    
    return `# ${projectName} - Gemini é…ç½®

## è§’è‰²å®šä½
${persona}

## ç¼–ç è§„èŒƒ
- ä½¿ç”¨ TypeScript
- éµå¾ª ESLint è§„åˆ™
- ç¼–å†™å•å…ƒæµ‹è¯•
- ä¿æŒä»£ç å¯è¯»æ€§

## å¼€å‘æµç¨‹
1. åˆ†æéœ€æ±‚å’Œä¸Šä¸‹æ–‡
2. è®¾è®¡æŠ€æœ¯æ–¹æ¡ˆ
3. å®ç°æ ¸å¿ƒé€»è¾‘
4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
5. ä»£ç å®¡æŸ¥ä¼˜åŒ–

## Gemini ç‰¹æ€§é…ç½®
- å¤šæ¨¡æ€æ”¯æŒ: ${variables.enableMultimodal ? 'å¯ç”¨' : 'ç¦ç”¨'}
- ä»£ç ç”Ÿæˆä¼˜åŒ–: ${variables.enableCodeOptimization ? 'å¯ç”¨' : 'ç¦ç”¨'}
- ä¸Šä¸‹æ–‡çª—å£: ${variables.contextWindow || '32k tokens'}
`;
  }

  /**
   * ç”Ÿæˆ settings.json è®¾ç½®æ–‡ä»¶
   * åŒ…å« API å¯†é’¥ã€æ¨¡å‹å‚æ•°ã€å®‰å…¨è®¾ç½®ç­‰
   *
   * @param variables é…ç½®å˜é‡
   * @returns JSON æ ¼å¼çš„è®¾ç½®å†…å®¹
   */
  private generateSettingsJson(variables: Record<string, unknown>): string {
    return JSON.stringify({
      apiKey: "{{GEMINI_API_KEY}}",
      model: variables.geminiModel || "gemini-2.0-flash-exp",
      temperature: variables.temperature || 0.2,
      maxOutputTokens: variables.maxTokens || 8192,
      topP: variables.topP || 0.95,
      topK: variables.topK || 40,
      safetySettings: [
        {
          category: "HARM_CATEGORY_HARASSMENT",
          threshold: "BLOCK_MEDIUM_AND_ABOVE"
        },
        {
          category: "HARM_CATEGORY_HATE_SPEECH",
          threshold: "BLOCK_MEDIUM_AND_ABOVE"
        }
      ],
      generationConfig: {
        stopSequences: variables.stopSequences || [],
        candidateCount: 1,
        responseMimeType: "text/plain"
      }
    }, null, 2);
  }

  /**
   * ç”Ÿæˆ plan.toml å‘½ä»¤è§„åˆ’æ–‡ä»¶
   * åŒ…å«é¡¹ç›®ä¿¡æ¯ã€å‘½ä»¤é…ç½®ã€å·¥ä½Ÿæµæ­¥éª¤ç­‰
   *
   * @param variables é…ç½®å˜é‡
   * @returns TOML æ ¼å¼çš„é…ç½®å†…å®¹
   */
  private generatePlanToml(variables: Record<string, unknown>): string {
    const projectDescription = variables.projectDescription || 'é¡¹ç›®å¼€å‘è§„åˆ’';
    
    return `# Gemini å‘½ä»¤è§„åˆ’é…ç½®

[project]
name = "${variables.projectName || 'my-project'}"
description = "${projectDescription}"

[commands.plan]
enabled = true
model = "${variables.geminiModel || 'gemini-2.0-flash-exp'}"
max_tokens = ${variables.maxTokens || 8192}

[commands.implement]
enabled = true
require_tests = ${variables.requireTests !== false}
code_style = "${variables.indentStyle || '2 spaces'}"

[commands.review]
enabled = true
auto_fix = ${variables.autoFix || false}
lint_on_save = ${variables.enableESLint || true}

[workflow]
steps = [
  "analyze",
  "plan",
  "implement",
  "test",
  "review"
]

[quality]
min_coverage = ${variables.minCoverage || 80}
enforce_types = ${variables.enforceTypes !== false}
require_docs = ${variables.requireDocs || false}
`;
  }
}
