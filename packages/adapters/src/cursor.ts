// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°Cursoré€‚é…å™¨å®Œæ•´é€»è¾‘

import { Adapter, ApplyContext, DiffResult } from './index.js';
import chalk from 'chalk';
import fs from 'fs/promises';
import path from 'path';

export class CursorAdapter implements Adapter {
  private backupPaths: Map<string, string> = new Map();

  async plan(ctx: ApplyContext): Promise<DiffResult> {
    console.log(chalk.gray('ğŸ“‹ è§„åˆ’ Cursor é…ç½®å˜æ›´...'));
    
    return {
      changes: [
        { path: './.cursor/rules.txt', kind: 'create' },
        { path: './.cursorrules', kind: 'create' }
      ],
      summary: 'å°†åˆ›å»º Cursor è§„åˆ™æ–‡ä»¶'
    };
  }

  async apply(ctx: ApplyContext): Promise<void> {
    console.log(chalk.green('âš¡ åº”ç”¨ Cursor é…ç½®...'));
    
    if (ctx.dryRun) {
      console.log(chalk.yellow('ğŸ” æ¨¡æ‹Ÿæ¨¡å¼ï¼šè·³è¿‡å®é™…å†™å…¥'));
      return;
    }
    
    await this.writeCursorConfigs(ctx);
  }

  async rollback(ctx: ApplyContext): Promise<void> {
    console.log(chalk.yellow('ğŸ”„ å›æ»š Cursor é…ç½®...'));
    
    for (const [originalPath, backupPath] of this.backupPaths) {
      try {
        const content = await fs.readFile(backupPath, 'utf-8');
        await fs.writeFile(originalPath, content, 'utf-8');
        console.log(chalk.yellow(`  ğŸ”„ å›æ»š: ${originalPath}`));
      } catch (error) {
        console.error(chalk.red(`  âŒ å›æ»šå¤±è´¥ ${originalPath}: ${error}`));
      }
    }
    
    this.backupPaths.clear();
    console.log(chalk.green('âœ… Cursor é…ç½®å›æ»šå®Œæˆ'));
  }

  private async writeCursorConfigs(ctx: ApplyContext): Promise<void> {
    const projectRoot = process.cwd();
    
    const configs = [
      {
        target: path.join(projectRoot, '.cursor', 'rules.txt'),
        content: this.generateCursorRules(ctx.variables),
        description: 'Cursor è§„åˆ™æ–‡ä»¶'
      },
      {
        target: path.join(projectRoot, '.cursorrules'),
        content: this.generateCursorRulesFile(ctx.variables),
        description: 'Cursor æ ¹è§„åˆ™æ–‡ä»¶'
      }
    ];

    for (const config of configs) {
      try {
        // å¤‡ä»½ç°æœ‰æ–‡ä»¶
        try {
          await fs.access(config.target);
          const backup = `${config.target}.backup`;
          await fs.copyFile(config.target, backup);
          this.backupPaths.set(config.target, backup);
        } catch {
          // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€å¤‡ä»½
        }

        // ç¡®ä¿ç›®å½•å­˜åœ¨
        await fs.mkdir(path.dirname(config.target), { recursive: true });
        
        // å†™å…¥æ–‡ä»¶
        await fs.writeFile(config.target, config.content, 'utf-8');
        console.log(chalk.gray(`  âœ… å†™å…¥ ${config.description}: ${config.target}`));
      } catch (error) {
        console.error(chalk.red(`  âŒ å†™å…¥å¤±è´¥ ${config.description}: ${error}`));
        throw error;
      }
    }
  }

  private generateCursorRules(variables: Record<string, unknown>): string {
    const projectName = variables.projectName || 'my-project';
    const persona = variables.persona || 'ä½ æ˜¯ä¸€åèµ„æ·±æ¶æ„å¸ˆ';
    
    return `# ${projectName} - Cursor è§„åˆ™

${persona}

## ä»£ç é£æ ¼
- ä½¿ç”¨ç°ä»£ JavaScript/TypeScript
- éµå¾ªé¡¹ç›® ESLint é…ç½®
- ç¼–å†™æ¸…æ™°çš„æ³¨é‡Š
- ä¿æŒå‡½æ•°å•ä¸€èŒè´£

## æµ‹è¯•è¦æ±‚
- æ¯ä¸ªæ–°åŠŸèƒ½å¿…é¡»æœ‰æµ‹è¯•
- æµ‹è¯•è¦†ç›–ç‡ > 80%
- ä½¿ç”¨é€‚å½“çš„æµ‹è¯•æ¡†æ¶

## å¼€å‘è§„èŒƒ
- ä»£ç ç¼©è¿›: ${variables.indentStyle || '2 spaces'}
- Prettier: ${variables.enablePrettier ? 'å¯ç”¨' : 'ç¦ç”¨'}
- ESLint: ${variables.enableESLint ? 'å¯ç”¨' : 'ç¦ç”¨'}

## Cursor Composer é…ç½®
- å¯ç”¨: ${variables.enableComposer ? 'true' : 'false'}
- æ¨¡å‹: ${variables.cursorModel || 'gpt-4'}
`;
  }

  private generateCursorRulesFile(variables: Record<string, unknown>): string {
    const projectDescription = variables.projectDescription || 'é¡¹ç›®æè¿°';
    const persona = variables.persona || 'ä½ æ˜¯ä¸€åå…¨æ ˆå·¥ç¨‹å¸ˆ';
    
    return `${persona}

é¡¹ç›®: ${projectDescription}

ç¼–ç è§„èŒƒ:
- éµå¾ªé¡¹ç›®ç°æœ‰ä»£ç é£æ ¼
- ç¼–å†™å•å…ƒæµ‹è¯•
- æ·»åŠ å¿…è¦çš„æ³¨é‡Š
- ä¿æŒä»£ç ç®€æ´

å“åº”è¦æ±‚:
- æä¾›æ¸…æ™°çš„è§£é‡Š
- ç»™å‡ºå¯æ‰§è¡Œçš„ä»£ç 
- è€ƒè™‘è¾¹ç•Œæƒ…å†µ
- æ³¨é‡æ€§èƒ½å’Œå®‰å…¨
`;
  }
}
