// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°Cloud Hubæ¨¡æ¿ä¸Šä¼ API

import { Router, Request, Response } from 'express';
import { FileStorage, Template } from '../storage/file-storage.js';
import chalk from 'chalk';

const router = Router();
let storage: FileStorage;

/**
 * åˆå§‹åŒ–è·¯ç”±
 * @param storageInstance å­˜å‚¨å®ä¾‹
 */
export function initializeTemplatesRouter(storageInstance: FileStorage): Router {
  storage = storageInstance;
  return router;
}

/**
 * è·å–æ¨¡æ¿åˆ—è¡¨
 * GET /api/v1/templates
 * 
 * æŸ¥è¯¢å‚æ•°:
 * - tool: å·¥å…·ç±»å‹è¿‡æ»¤
 * - tags: æ ‡ç­¾è¿‡æ»¤ï¼ˆé€—å·åˆ†éš”ï¼‰
 * - author: ä½œè€…è¿‡æ»¤
 * - search: å…³é”®è¯æœç´¢
 * - page: é¡µç ï¼ˆé»˜è®¤1ï¼‰
 * - limit: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰
 */
router.get('/', async (req: Request, res: Response) => {
  try {
    const { tool, tags, author, search, page = '1', limit = '20' } = req.query;

    // æ„å»ºè¿‡æ»¤æ¡ä»¶
    const filter: any = {};
    if (tool) filter.tool = tool as string;
    if (tags) filter.tags = (tags as string).split(',');
    if (author) filter.author = author as string;
    if (search) filter.search = search as string;

    // è·å–æ¨¡æ¿åˆ—è¡¨
    const allTemplates = await storage.listTemplates(filter);

    // åˆ†é¡µ
    const pageNum = parseInt(page as string);
    const limitNum = parseInt(limit as string);
    const startIndex = (pageNum - 1) * limitNum;
    const endIndex = startIndex + limitNum;
    const paginatedTemplates = allTemplates.slice(startIndex, endIndex);

    res.json({
      success: true,
      data: paginatedTemplates,
      pagination: {
        page: pageNum,
        limit: limitNum,
        total: allTemplates.length,
        pages: Math.ceil(allTemplates.length / limitNum)
      }
    });

    console.log(chalk.gray(`ğŸ“‹ è·å–æ¨¡æ¿åˆ—è¡¨: ${paginatedTemplates.length}/${allTemplates.length}`));
  } catch (error: any) {
    console.error(chalk.red('âŒ è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥:'), error.message);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      message: error.message
    });
  }
});

/**
 * è·å–å•ä¸ªæ¨¡æ¿
 * GET /api/v1/templates/:id
 */
router.get('/:id', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const template = await storage.getTemplate(id);

    if (!template) {
      return res.status(404).json({
        success: false,
        error: 'æ¨¡æ¿ä¸å­˜åœ¨'
      });
    }

    // å¢åŠ ä¸‹è½½è®¡æ•°
    await storage.incrementDownloads(id);

    res.json({
      success: true,
      data: template
    });

    console.log(chalk.gray(`ğŸ“¥ ä¸‹è½½æ¨¡æ¿: ${id}`));
  } catch (error: any) {
    console.error(chalk.red('âŒ è·å–æ¨¡æ¿å¤±è´¥:'), error.message);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      message: error.message
    });
  }
});

/**
 * ä¸Šä¼ æ¨¡æ¿
 * POST /api/v1/templates
 * 
 * è¯·æ±‚ä½“:
 * {
 *   id: string,
 *   name: string,
 *   version: string,
 *   description?: string,
 *   author?: string,
 *   targets: string[],
 *   variables: object,
 *   configs?: any[],
 *   tags?: string[]
 * }
 */
router.post('/', async (req: Request, res: Response) => {
  try {
    const template: Template = req.body;

    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!template.id || !template.name || !template.targets || !template.version) {
      return res.status(400).json({
        success: false,
        error: 'ç¼ºå°‘å¿…å¡«å­—æ®µ',
        required: ['id', 'name', 'version', 'targets']
      });
    }

    // éªŒè¯ targets æ˜¯æ•°ç»„
    if (!Array.isArray(template.targets) || template.targets.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'targets å¿…é¡»æ˜¯éç©ºæ•°ç»„'
      });
    }

    // ä¿å­˜æ¨¡æ¿
    const savedTemplate = await storage.saveTemplate(template);

    res.status(201).json({
      success: true,
      data: savedTemplate,
      message: 'æ¨¡æ¿ä¸Šä¼ æˆåŠŸ'
    });

    console.log(chalk.green(`âœ… æ¨¡æ¿ä¸Šä¼ æˆåŠŸ: ${template.id} (${template.name})`));
  } catch (error: any) {
    console.error(chalk.red('âŒ ä¸Šä¼ æ¨¡æ¿å¤±è´¥:'), error.message);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      message: error.message
    });
  }
});

/**
 * æ›´æ–°æ¨¡æ¿
 * PUT /api/v1/templates/:id
 */
router.put('/:id', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const updates: Partial<Template> = req.body;

    // æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å­˜åœ¨
    const existingTemplate = await storage.getTemplate(id);
    if (!existingTemplate) {
      return res.status(404).json({
        success: false,
        error: 'æ¨¡æ¿ä¸å­˜åœ¨'
      });
    }

    // åˆå¹¶æ›´æ–°
    const updatedTemplate: Template = {
      ...existingTemplate,
      ...updates,
      id // ç¡®ä¿IDä¸å˜
    };

    const savedTemplate = await storage.saveTemplate(updatedTemplate);

    res.json({
      success: true,
      data: savedTemplate,
      message: 'æ¨¡æ¿æ›´æ–°æˆåŠŸ'
    });

    console.log(chalk.green(`âœ… æ¨¡æ¿æ›´æ–°æˆåŠŸ: ${id}`));
  } catch (error: any) {
    console.error(chalk.red('âŒ æ›´æ–°æ¨¡æ¿å¤±è´¥:'), error.message);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      message: error.message
    });
  }
});

/**
 * åˆ é™¤æ¨¡æ¿
 * DELETE /api/v1/templates/:id
 */
router.delete('/:id', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const deleted = await storage.deleteTemplate(id);

    if (!deleted) {
      return res.status(404).json({
        success: false,
        error: 'æ¨¡æ¿ä¸å­˜åœ¨'
      });
    }

    res.json({
      success: true,
      message: 'æ¨¡æ¿åˆ é™¤æˆåŠŸ'
    });

    console.log(chalk.yellow(`ğŸ—‘ï¸  æ¨¡æ¿å·²åˆ é™¤: ${id}`));
  } catch (error: any) {
    console.error(chalk.red('âŒ åˆ é™¤æ¨¡æ¿å¤±è´¥:'), error.message);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      message: error.message
    });
  }
});

/**
 * è¯„åˆ†æ¨¡æ¿
 * POST /api/v1/templates/:id/rating
 * 
 * è¯·æ±‚ä½“:
 * {
 *   rating: number (0-5)
 * }
 */
router.post('/:id/rating', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const { rating } = req.body;

    if (typeof rating !== 'number' || rating < 0 || rating > 5) {
      return res.status(400).json({
        success: false,
        error: 'è¯„åˆ†å¿…é¡»æ˜¯ 0-5 ä¹‹é—´çš„æ•°å­—'
      });
    }

    await storage.updateRating(id, rating);

    res.json({
      success: true,
      message: 'è¯„åˆ†æˆåŠŸ'
    });

    console.log(chalk.gray(`â­ æ¨¡æ¿è¯„åˆ†: ${id} = ${rating}`));
  } catch (error: any) {
    console.error(chalk.red('âŒ è¯„åˆ†å¤±è´¥:'), error.message);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      message: error.message
    });
  }
});

/**
 * è·å–ç»Ÿè®¡ä¿¡æ¯
 * GET /api/v1/templates/stats
 */
router.get('/stats/summary', async (req: Request, res: Response) => {
  try {
    const stats = await storage.getStats();

    res.json({
      success: true,
      data: stats
    });

    console.log(chalk.gray('ğŸ“Š è·å–ç»Ÿè®¡ä¿¡æ¯'));
  } catch (error: any) {
    console.error(chalk.red('âŒ è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:'), error.message);
    res.status(500).json({
      success: false,
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      message: error.message
    });
  }
});

export default router;

