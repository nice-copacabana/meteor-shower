// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°CLI shareå‘½ä»¤äº‘ç«¯ä¸Šä¼ åŠŸèƒ½ï¼Œæ‰“åŒ…å¹¶ä¸Šä¼ é…ç½®æ¨¡æ¿åˆ°Cloud Hub

/**
 * é…ç½®åˆ†äº«å‘½ä»¤
 * è´Ÿè´£æ‰«æå½“å‰é¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œæ‰“åŒ…ä¸ºæ¨¡æ¿å¹¶åˆ†äº«åˆ°äº‘ç«¯
 *
 * æ ¸å¿ƒèŒè´£ï¼š
 * - æ‰«æé¡¹ç›®ä¸­çš„å„ç§ AI å·¥å…·é…ç½®æ–‡ä»¶
 * - æ”¶é›†æ¨¡æ¿å…ƒæ•°æ®ï¼ˆåç§°ã€æè¿°ã€æ ‡ç­¾ç­‰ï¼‰
 * - æ‰“åŒ…é…ç½®ä¸º JSON æ ¼å¼çš„æ¨¡æ¿æ–‡ä»¶
 * - ä¸Šä¼ æ¨¡æ¿åˆ° Cloud Hub äº‘ç«¯æœåŠ¡
 * - æ£€æŸ¥ç”¨æˆ·åˆ†äº«é…é¢ï¼ˆä¼ä¸šåŠŸèƒ½ï¼‰
 */

import chalk from 'chalk';
import inquirer from 'inquirer';
import fs from 'fs/promises';
import path from 'path';
import os from 'os';
import { FileOperations } from '@meteor-shower/utils';
import Database from 'better-sqlite3';
import { UserTierManager } from '@meteor-shower/enterprise/tier/tier-manager.js';

/**
 * æ¨¡æ¿åˆ†äº«é€‰é¡¹
 */
export interface ShareOptions {
  public?: boolean;              // æ˜¯å¦å…¬å¼€åˆ†äº«
  skipUpload?: boolean;          // è·³è¿‡ä¸Šä¼ ï¼Œåªæ‰“åŒ…
}

/**
 * é…ç½®æ–‡ä»¶ä¿¡æ¯
 */
interface ConfigFileInfo {
  file: string;                  // æ–‡ä»¶è·¯å¾„
  found: boolean;                // æ˜¯å¦æ‰¾åˆ°
  content?: string;              // æ–‡ä»¶å†…å®¹
  tool?: string;                 // æ‰€å±å·¥å…·
}

/**
 * æ¨¡æ¿åŒ…æ•°æ®
 */
interface TemplatePackage {
  name: string;                  // æ¨¡æ¿åç§°
  description: string;           // æ¨¡æ¿æè¿°
  version: string;               // æ¨¡æ¿ç‰ˆæœ¬
  author?: string;               // ä½œè€…
  tags: string[];                // æ ‡ç­¾
  configs: ConfigFileInfo[];     // é…ç½®æ–‡ä»¶åˆ—è¡¨
  createdAt: string;             // åˆ›å»ºæ—¶é—´
}

/**
 * åˆ†äº«å‘½ä»¤
 * æ‰“åŒ…å½“å‰é¡¹ç›®çš„é…ç½®æ–‡ä»¶å¹¶ä¸Šä¼ åˆ° Cloud Hub
 */
/**
 * åˆ†äº«å‘½ä»¤ä¸»å‡½æ•°
 * 
 * ä¸šåŠ¡æµç¨‹ï¼š
 * 1. æ£€æŸ¥é…é¢ - éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰åˆ†äº«æƒé™ï¼ˆä¼ä¸šåŠŸèƒ½ï¼‰
 * 2. æ‰«æé…ç½® - æ‰«æé¡¹ç›®ä¸­çš„æ‰€æœ‰é…ç½®æ–‡ä»¶
 * 3. æ”¶é›†ä¿¡æ¯ - è®©ç”¨æˆ·è¾“å…¥æ¨¡æ¿åç§°ã€æè¿°ã€æ ‡ç­¾ç­‰
 * 4. è¯»å–å†…å®¹ - è¯»å–æ‰€æœ‰æ‰¾åˆ°çš„é…ç½®æ–‡ä»¶å†…å®¹
 * 5. åˆ›å»ºæ¨¡æ¿åŒ… - å°†é…ç½®å’Œå…ƒæ•°æ®æ‰“åŒ…ä¸º JSON
 * 6. æœ¬åœ°ä¿å­˜ - ä¿å­˜åˆ° .meteor-shower/templates/ ç›®å½•
 * 7. äº‘ç«¯ä¸Šä¼  - å°†æ¨¡æ¿ä¸Šä¼ åˆ° Cloud Hubï¼ˆå¯é€‰ï¼‰
 *
 * @param options åˆ†äº«é€‰é¡¹
 */
  console.log(chalk.cyan('ğŸ“¦ æ‰“åŒ…å½“å‰é…ç½®ä¸ºæ¨¡æ¿...'));
  
  // ========== æ£€æŸ¥ç”¨æˆ·åˆ†äº«é…é¢ ==========
  // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ£€æŸ¥æ˜¯å¦è¶…å‡ºåˆ†äº«é…é¢
  const userId = process.env.METEOR_USER_ID;
  if (userId) {
    const quotaCheck = await checkShareQuota(userId);
    if (!quotaCheck.allowed) {
      console.log(chalk.red(`\nâŒ åˆ†äº«é…é¢é™åˆ¶: ${quotaCheck.reason}`));
      console.log(chalk.yellow('\nğŸ’¡ æç¤º:'));
      console.log(chalk.gray(`   å½“å‰å±‚çº§: ${quotaCheck.tier}`));
      console.log(chalk.gray(`   æœ¬æœˆå·²ä½¿ç”¨: ${quotaCheck.current}/${quotaCheck.limit}`));
      console.log(chalk.gray('   è¿è¡Œ ms account upgrade å‡çº§ä»¥è·å–æ›´å¤šé…é¢\n'));
      
      // æ˜¾ç¤ºå‡çº§å»ºè®®
      const suggestion = quotaCheck.suggestion;
      if (suggestion && suggestion.shouldUpgrade) {
        console.log(chalk.cyan(`   å»ºè®®å‡çº§åˆ°: ${suggestion.suggestedTier}`));
      }
      return;
    }
    
    // æ˜¾ç¤ºé…é¢ä¿¡æ¯
    if (quotaCheck.remaining !== -1) {
      console.log(chalk.gray(`  æœ¬æœˆå‰©ä½™åˆ†äº«æ¬¡æ•°: ${quotaCheck.remaining}\n`));
    }
  }
  
  const fileOps = new FileOperations();
  const projectRoot = process.cwd();
  const homeDir = os.homedir();

  // ========== æ­¥éª¤1: æ‰«æé…ç½®æ–‡ä»¶ ==========
  // åœ¨é¡¹ç›®ä¸­æ‰«æ Gemini/Claude/Cursor/OpenAI çš„é…ç½®æ–‡ä»¶
  try {
    console.log(chalk.gray('ğŸ” æ‰«æé¡¹ç›®é…ç½®æ–‡ä»¶...'));
    const configs = await scanConfigFiles(projectRoot, homeDir);
    
    const foundConfigs = configs.filter(c => c.found);
    if (foundConfigs.length === 0) {
      console.log(chalk.red('âŒ æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ ms init'));
      return;
    }

    // æ˜¾ç¤ºå‘ç°çš„é…ç½®
    console.log(chalk.yellow('\nğŸ“‹ å‘ç°çš„é…ç½®:'));
    configs.forEach(config => {
      const icon = config.found ? 'âœ…' : 'âŒ';
      const color = config.found ? 'green' : 'gray';
      console.log(chalk[color](`  ${icon} ${config.file} ${config.tool ? `(${config.tool})` : ''}`));
    });

    // ========== æ­¥éª¤2: æ”¶é›†æ¨¡æ¿å…ƒæ•°æ® ==========
    // è®©ç”¨æˆ·è¾“å…¥æ¨¡æ¿çš„åç§°ã€æè¿°ã€æ ‡ç­¾ç­‰ä¿¡æ¯
    console.log(chalk.cyan('\nğŸ“ å¡«å†™æ¨¡æ¿ä¿¡æ¯:'));
    const { templateName, description, version, tags, author } = await inquirer.prompt([
      { 
        type: 'input', 
        name: 'templateName', 
        message: 'æ¨¡æ¿åç§°:', 
        default: 'my-config',
        validate: (input) => input.trim().length > 0 ? true : 'æ¨¡æ¿åç§°ä¸èƒ½ä¸ºç©º'
      },
      { 
        type: 'input', 
        name: 'description', 
        message: 'æ¨¡æ¿æè¿°:', 
        default: 'æˆ‘çš„ AI å·¥å…·é…ç½®' 
      },
      {
        type: 'input',
        name: 'version',
        message: 'æ¨¡æ¿ç‰ˆæœ¬:',
        default: '1.0.0'
      },
      {
        type: 'input',
        name: 'tags',
        message: 'æ ‡ç­¾ (é€—å·åˆ†éš”):',
        default: 'ai,coding,assistant',
        filter: (input) => input.split(',').map((t: string) => t.trim())
      },
      {
        type: 'input',
        name: 'author',
        message: 'ä½œè€…:',
        default: os.userInfo().username
      }
    ]);

    // ========== æ­¥éª¤3: è¯»å–é…ç½®æ–‡ä»¶å†…å®¹ ==========
    // è¯»å–æ¯ä¸ªæ‰¾åˆ°çš„é…ç½®æ–‡ä»¶çš„å®é™…å†…å®¹
    console.log(chalk.gray('\nğŸ“š è¯»å–é…ç½®æ–‡ä»¶å†…å®¹...'));
    for (const config of foundConfigs) {
      try {
        const fullPath = config.file.startsWith('~/') 
          ? path.join(homeDir, config.file.substring(2))
          : path.join(projectRoot, config.file);
        config.content = await fs.readFile(fullPath, 'utf-8');
      } catch (error) {
        console.warn(chalk.yellow(`  âš ï¸ è¯»å–å¤±è´¥: ${config.file}`));
      }
    }

    // ========== æ­¥éª¤4: åˆ›å»ºæ¨¡æ¿åŒ… ==========
    // å°†å…ƒæ•°æ®å’Œé…ç½®æ–‡ä»¶å†…å®¹æ‰“åŒ…ä¸º JSON æ ¼å¼
    const templatePackage: TemplatePackage = {
      name: templateName,
      description,
      version,
      author,
      tags,
      configs: foundConfigs.filter(c => c.content),
      createdAt: new Date().toISOString()
    };

    // ========== æ­¥éª¤5: æœ¬åœ°ä¿å­˜ ==========
    // å°†æ¨¡æ¿ä¿å­˜åˆ° .meteor-shower/templates/ ç›®å½•
    const outputDir = path.join(projectRoot, '.meteor-shower', 'templates');
    await fs.mkdir(outputDir, { recursive: true });
    const outputPath = path.join(outputDir, `${templateName}.json`);
    await fs.writeFile(outputPath, JSON.stringify(templatePackage, null, 2), 'utf-8');
    
    console.log(chalk.green(`\nâœ… æ¨¡æ¿å·²ä¿å­˜åˆ°: ${outputPath}`));

    // ========== æ­¥éª¤6: äº‘ç«¯ä¸Šä¼  ==========
    // å¦‚æœç”¨æˆ·åŒæ„ï¼Œå°†æ¨¡æ¿ä¸Šä¼ åˆ° Cloud Hub
    if (!options.skipUpload) {
      const { shouldUpload } = await inquirer.prompt([
        {
          type: 'confirm',
          name: 'shouldUpload',
          message: 'æ˜¯å¦ä¸Šä¼ åˆ° Cloud Hubï¼Ÿ',
          default: true
        }
      ]);

      if (shouldUpload) {
        console.log(chalk.cyan('\nğŸš€ ä¸Šä¼ åˆ° Cloud Hub...'));
        await uploadToCloudHub(templatePackage, options.public || false);
      }
    }

    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    console.log(chalk.green('\nğŸ‰ æ¨¡æ¿æ‰“åŒ…å®Œæˆï¼'));
    console.log(chalk.gray(`æ¨¡æ¿å: ${templateName}`));
    console.log(chalk.gray(`æè¿°: ${description}`));
    console.log(chalk.gray(`ç‰ˆæœ¬: ${version}`));
    console.log(chalk.gray(`é…ç½®æ•°é‡: ${templatePackage.configs.length}`));
    console.log(chalk.gray('\nğŸ’¡ ä½¿ç”¨ ms init å¯ä»¥é‡æ–°åº”ç”¨æ­¤æ¨¡æ¿'));
    
  } catch (error: any) {
    console.error(chalk.red(`\nâŒ æ‰“åŒ…å¤±è´¥: ${error.message}`));
    throw error;
  }
}

/**
 * æ‰«æé…ç½®æ–‡ä»¶
 * æ£€æµ‹é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨å„ç§ AI å·¥å…·çš„é…ç½®æ–‡ä»¶
 *
 * æ”¯æŒçš„é…ç½®æ–‡ä»¶ï¼š
 * - Gemini: ~/.gemini/GEMINI.md, ~/.gemini/settings.json, .gemini/commands/plan.toml
 * - Claude: ~/.claude/claude.json, CLAUDE.md, CLAUDE.local.md
 * - Cursor: .cursorrules, .cursor/rules.txt, CURSOR.local.md
 * - OpenAI: AGENTS.md, .env.example, OPENAI.local.md
 *
 * @param projectRoot é¡¹ç›®æ ¹ç›®å½•
 * @param homeDir ç”¨æˆ·ä¸»ç›®å½•
 * @returns é…ç½®æ–‡ä»¶åˆ—è¡¨ï¼Œæ ‡è®°æ˜¯å¦å­˜åœ¨
 */
async function scanConfigFiles(projectRoot: string, homeDir: string): Promise<ConfigFileInfo[]> {
  // å®šä¹‰éœ€è¦æ‰«æçš„é…ç½®æ–‡ä»¶æ¨¡å¼
  const configPatterns: ConfigFileInfo[] = [
    // Gemini
    { file: '~/.gemini/GEMINI.md', found: false, tool: 'gemini' },
    { file: '~/.gemini/settings.json', found: false, tool: 'gemini' },
    { file: '.gemini/commands/plan.toml', found: false, tool: 'gemini' },
    
    // Claude
    { file: '~/.claude/claude.json', found: false, tool: 'claude' },
    { file: './CLAUDE.md', found: false, tool: 'claude' },
    { file: './CLAUDE.local.md', found: false, tool: 'claude' },
    
    // Cursor
    { file: './.cursorrules', found: false, tool: 'cursor' },
    { file: './.cursor/rules.txt', found: false, tool: 'cursor' },
    { file: './CURSOR.local.md', found: false, tool: 'cursor' },
    
    // OpenAI
    { file: './AGENTS.md', found: false, tool: 'openai' },
    { file: './.env.example', found: false, tool: 'openai' },
    { file: './OPENAI.local.md', found: false, tool: 'openai' }
  ];

  // æ£€æµ‹æ¯ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ ‡è®° found çŠ¶æ€
  for (const config of configPatterns) {
    const fullPath = config.file.startsWith('~/') 
      ? path.join(homeDir, config.file.substring(2))
      : path.join(projectRoot, config.file);
    
    try {
      await fs.access(fullPath);
      config.found = true;
    } catch {
      config.found = false;
    }
  }

  return configPatterns;
}

/**
 * ä¸Šä¼ æ¨¡æ¿åˆ° Cloud Hub
 * é€šè¿‡ HTTP API å°†æ¨¡æ¿åŒ…ä¸Šä¼ åˆ°äº‘ç«¯æœåŠ¡
 *
 * å·¥ä½œæµç¨‹ï¼š
 * 1. æ£€æŸ¥ API å¯†é’¥æ˜¯å¦é…ç½®
 * 2. æ„é€  HTTP è¯·æ±‚ï¼ˆPOST /templatesï¼‰
 * 3. å‘é€æ¨¡æ¿æ•°æ®
 * 4. å¤„ç†å“åº”å’Œé”™è¯¯
 *
 * æ³¨æ„ï¼šå½“å‰ä¸ºæ¨¡æ‹Ÿå®ç°ï¼ŒTODO ä¸­æœ‰å®é™… HTTP è¯·æ±‚ä»£ç 
 *
 * @param templatePackage æ¨¡æ¿åŒ…æ•°æ®
 * @param isPublic æ˜¯å¦å…¬å¼€åˆ†äº«
 */
async function uploadToCloudHub(templatePackage: TemplatePackage, isPublic: boolean): Promise<void> {
  try {
    // æ£€æŸ¥ API é…ç½®
    const apiEndpoint = process.env.METEOR_CLOUD_API || 'https://api.meteor-shower.dev';
    const apiKey = process.env.METEOR_API_KEY;

    if (!apiKey) {
      console.log(chalk.yellow('\nâš ï¸ æœªè®¾ç½® API å¯†é’¥ï¼Œè·³è¿‡ä¸Šä¼ '));
      console.log(chalk.gray('æç¤º: è®¾ç½® METEOR_API_KEY ç¯å¢ƒå˜é‡ä»¥å¯ç”¨äº‘ç«¯åŒæ­¥'));
      return;
    }

    // TODO: å®ç°å®é™…çš„ HTTP è¯·æ±‚
    // const response = await fetch(`${apiEndpoint}/templates`, {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json',
    //     'Authorization': `Bearer ${apiKey}`
    //   },
    //   body: JSON.stringify({
    //     ...templatePackage,
    //     public: isPublic
    //   })
    // });
    //
    // if (!response.ok) {
    //   throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.statusText}`);
    // }

    // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹ï¼ˆå®é™…åº”è°ƒç”¨ fetch æˆ– axiosï¼‰
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    console.log(chalk.green('âœ… ä¸Šä¼ æˆåŠŸï¼'));
    console.log(chalk.gray(`æ¨¡æ¿ ID: ${templatePackage.name}-${Date.now()}`));
    console.log(chalk.gray(`å¯è§æ€§: ${isPublic ? 'å…¬å¼€' : 'ç§æœ‰'}'));
    console.log(chalk.gray(`åˆ†äº«é“¾æ¥: ${apiEndpoint}/templates/${templatePackage.name}`));
    
  } catch (error: any) {
    console.error(chalk.red(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`));
    console.log(chalk.yellow('æ¨¡æ¿å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œå¯ä»¥ç¨åé‡è¯•ä¸Šä¼ '));
  }
}

/**
 * æ£€æŸ¥åˆ†äº«é…é¢
 * éªŒè¯ç”¨æˆ·æ˜¯å¦è¿˜æœ‰åˆ†äº«é…é¢ï¼ˆåŸºäºç”¨æˆ·å±‚çº§ï¼‰
 *
 * é…é¢æ£€æŸ¥é€»è¾‘ï¼š
 * - è¯»å–ç”¨æˆ·å±‚çº§å’Œæœ¬æœˆä½¿ç”¨é‡
 * - å¯¹æ¯”å±‚çº§é™åˆ¶
 * - è¿”å›æ˜¯å¦å…è®¸åˆ†äº«å’Œå‰©ä½™æ¬¡æ•°
 *
 * @param userId ç”¨æˆ·ID
 * @returns é…é¢æ£€æŸ¥ç»“æœ
 */
async function checkShareQuota(userId: string): Promise<{
  allowed: boolean;
  reason?: string;
  current: number;
  limit: number;
  remaining: number;
  tier?: string;
  suggestion?: any;
}> {
  try {
    const dbPath = process.env.METEOR_DB_PATH || path.join(os.homedir(), '.meteor-shower', 'meteor.db');
    
    // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
    try {
      await fs.access(dbPath);
    } catch {
      // æ•°æ®åº“ä¸å­˜åœ¨ï¼Œè·³è¿‡é…é¢æ£€æŸ¥
      return { allowed: true, current: 0, limit: -1, remaining: -1 };
    }

    const db = new Database(dbPath);
    const tierManager = new UserTierManager(db);

    const quotaResult = tierManager.checkShareQuota(userId);
    const userQuotas = tierManager.getUserQuotas(userId);
    const suggestion = tierManager.getUpgradeSuggestion(userId);

    db.close();

    return {
      allowed: quotaResult.allowed,
      reason: quotaResult.reason,
      current: quotaResult.current,
      limit: quotaResult.limit,
      remaining: quotaResult.remaining,
      tier: userQuotas?.tier,
      suggestion
    };
  } catch (error) {
    console.warn(chalk.yellow('âš ï¸  æ— æ³•æ£€æŸ¥é…é¢ï¼Œç»§ç»­æ‰§è¡Œ...'));
    return { allowed: true, current: 0, limit: -1, remaining: -1 };
  }
}
