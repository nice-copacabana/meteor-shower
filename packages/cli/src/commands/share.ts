// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°CLI shareå‘½ä»¤äº‘ç«¯ä¸Šä¼ åŠŸèƒ½ï¼Œæ‰“åŒ…å¹¶ä¸Šä¼ é…ç½®æ¨¡æ¿åˆ°Cloud Hub

import chalk from 'chalk';
import inquirer from 'inquirer';
import fs from 'fs/promises';
import path from 'path';
import os from 'os';
import { FileOperations } from '@meteor-shower/utils';

/**
 * æ¨¡æ¿åˆ†äº«é€‰é¡¹
 */
export interface ShareOptions {
  public?: boolean;              // æ˜¯å¦å…¬å¼€åˆ†äº«
  skipUpload?: boolean;          // è·³è¿‡ä¸Šä¼ ï¼Œåªæ‰“åŒ…
}

/**
 * é…ç½®æ–‡ä»¶ä¿¡æ¯
 */
interface ConfigFileInfo {
  file: string;                  // æ–‡ä»¶è·¯å¾„
  found: boolean;                // æ˜¯å¦æ‰¾åˆ°
  content?: string;              // æ–‡ä»¶å†…å®¹
  tool?: string;                 // æ‰€å±å·¥å…·
}

/**
 * æ¨¡æ¿åŒ…æ•°æ®
 */
interface TemplatePackage {
  name: string;                  // æ¨¡æ¿åç§°
  description: string;           // æ¨¡æ¿æè¿°
  version: string;               // æ¨¡æ¿ç‰ˆæœ¬
  author?: string;               // ä½œè€…
  tags: string[];                // æ ‡ç­¾
  configs: ConfigFileInfo[];     // é…ç½®æ–‡ä»¶åˆ—è¡¨
  createdAt: string;             // åˆ›å»ºæ—¶é—´
}

/**
 * åˆ†äº«å‘½ä»¤
 * æ‰“åŒ…å½“å‰é¡¹ç›®çš„é…ç½®æ–‡ä»¶å¹¶ä¸Šä¼ åˆ° Cloud Hub
 */
export async function shareCommand(options: ShareOptions = {}) {
  console.log(chalk.cyan('ğŸ“¦ æ‰“åŒ…å½“å‰é…ç½®ä¸ºæ¨¡æ¿...'));
  
  const fileOps = new FileOperations();
  const projectRoot = process.cwd();
  const homeDir = os.homedir();

  try {
    // æ­¥éª¤1: æ‰«æé…ç½®æ–‡ä»¶
    console.log(chalk.gray('ğŸ” æ‰«æé¡¹ç›®é…ç½®æ–‡ä»¶...'));
    const configs = await scanConfigFiles(projectRoot, homeDir);
    
    const foundConfigs = configs.filter(c => c.found);
    if (foundConfigs.length === 0) {
      console.log(chalk.red('âŒ æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ ms init'));
      return;
    }

    // æ˜¾ç¤ºå‘ç°çš„é…ç½®
    console.log(chalk.yellow('\nğŸ“‹ å‘ç°çš„é…ç½®:'));
    configs.forEach(config => {
      const icon = config.found ? 'âœ…' : 'âŒ';
      const color = config.found ? 'green' : 'gray';
      console.log(chalk[color](`  ${icon} ${config.file} ${config.tool ? `(${config.tool})` : ''}`));
    });

    // æ­¥éª¤2: æ”¶é›†æ¨¡æ¿ä¿¡æ¯
    console.log(chalk.cyan('\nğŸ“ å¡«å†™æ¨¡æ¿ä¿¡æ¯:'));
    const { templateName, description, version, tags, author } = await inquirer.prompt([
      { 
        type: 'input', 
        name: 'templateName', 
        message: 'æ¨¡æ¿åç§°:', 
        default: 'my-config',
        validate: (input) => input.trim().length > 0 ? true : 'æ¨¡æ¿åç§°ä¸èƒ½ä¸ºç©º'
      },
      { 
        type: 'input', 
        name: 'description', 
        message: 'æ¨¡æ¿æè¿°:', 
        default: 'æˆ‘çš„ AI å·¥å…·é…ç½®' 
      },
      {
        type: 'input',
        name: 'version',
        message: 'æ¨¡æ¿ç‰ˆæœ¬:',
        default: '1.0.0'
      },
      {
        type: 'input',
        name: 'tags',
        message: 'æ ‡ç­¾ (é€—å·åˆ†éš”):',
        default: 'ai,coding,assistant',
        filter: (input) => input.split(',').map((t: string) => t.trim())
      },
      {
        type: 'input',
        name: 'author',
        message: 'ä½œè€…:',
        default: os.userInfo().username
      }
    ]);

    // æ­¥éª¤3: è¯»å–é…ç½®æ–‡ä»¶å†…å®¹
    console.log(chalk.gray('\nğŸ“š è¯»å–é…ç½®æ–‡ä»¶å†…å®¹...'));
    for (const config of foundConfigs) {
      try {
        const fullPath = config.file.startsWith('~/') 
          ? path.join(homeDir, config.file.substring(2))
          : path.join(projectRoot, config.file);
        config.content = await fs.readFile(fullPath, 'utf-8');
      } catch (error) {
        console.warn(chalk.yellow(`  âš ï¸ è¯»å–å¤±è´¥: ${config.file}`));
      }
    }

    // æ­¥éª¤4: åˆ›å»ºæ¨¡æ¿åŒ…
    const templatePackage: TemplatePackage = {
      name: templateName,
      description,
      version,
      author,
      tags,
      configs: foundConfigs.filter(c => c.content),
      createdAt: new Date().toISOString()
    };

    // æ­¥éª¤5: ä¿å­˜åˆ°æœ¬åœ°
    const outputDir = path.join(projectRoot, '.meteor-shower', 'templates');
    await fs.mkdir(outputDir, { recursive: true });
    const outputPath = path.join(outputDir, `${templateName}.json`);
    await fs.writeFile(outputPath, JSON.stringify(templatePackage, null, 2), 'utf-8');
    
    console.log(chalk.green(`\nâœ… æ¨¡æ¿å·²ä¿å­˜åˆ°: ${outputPath}`));

    // æ­¥éª¤6: ä¸Šä¼ åˆ° Cloud Hubï¼ˆå¦‚æœæ²¡æœ‰è·³è¿‡ï¼‰
    if (!options.skipUpload) {
      const { shouldUpload } = await inquirer.prompt([
        {
          type: 'confirm',
          name: 'shouldUpload',
          message: 'æ˜¯å¦ä¸Šä¼ åˆ° Cloud Hubï¼Ÿ',
          default: true
        }
      ]);

      if (shouldUpload) {
        console.log(chalk.cyan('\nğŸš€ ä¸Šä¼ åˆ° Cloud Hub...'));
        await uploadToCloudHub(templatePackage, options.public || false);
      }
    }

    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    console.log(chalk.green('\nğŸ‰ æ¨¡æ¿æ‰“åŒ…å®Œæˆï¼'));
    console.log(chalk.gray(`æ¨¡æ¿å: ${templateName}`));
    console.log(chalk.gray(`æè¿°: ${description}`));
    console.log(chalk.gray(`ç‰ˆæœ¬: ${version}`));
    console.log(chalk.gray(`é…ç½®æ•°é‡: ${templatePackage.configs.length}`));
    console.log(chalk.gray('\nğŸ’¡ ä½¿ç”¨ ms init å¯ä»¥é‡æ–°åº”ç”¨æ­¤æ¨¡æ¿'));
    
  } catch (error: any) {
    console.error(chalk.red(`\nâŒ æ‰“åŒ…å¤±è´¥: ${error.message}`));
    throw error;
  }
}

/**
 * æ‰«æé…ç½®æ–‡ä»¶
 * æ£€æµ‹é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨å„ç§å·¥å…·çš„é…ç½®æ–‡ä»¶
 */
async function scanConfigFiles(projectRoot: string, homeDir: string): Promise<ConfigFileInfo[]> {
  const configPatterns: ConfigFileInfo[] = [
    // Gemini
    { file: '~/.gemini/GEMINI.md', found: false, tool: 'gemini' },
    { file: '~/.gemini/settings.json', found: false, tool: 'gemini' },
    { file: '.gemini/commands/plan.toml', found: false, tool: 'gemini' },
    
    // Claude
    { file: '~/.claude/claude.json', found: false, tool: 'claude' },
    { file: './CLAUDE.md', found: false, tool: 'claude' },
    { file: './CLAUDE.local.md', found: false, tool: 'claude' },
    
    // Cursor
    { file: './.cursorrules', found: false, tool: 'cursor' },
    { file: './.cursor/rules.txt', found: false, tool: 'cursor' },
    { file: './CURSOR.local.md', found: false, tool: 'cursor' },
    
    // OpenAI
    { file: './AGENTS.md', found: false, tool: 'openai' },
    { file: './.env.example', found: false, tool: 'openai' },
    { file: './OPENAI.local.md', found: false, tool: 'openai' }
  ];

  // æ£€æµ‹æ¯ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨
  for (const config of configPatterns) {
    const fullPath = config.file.startsWith('~/') 
      ? path.join(homeDir, config.file.substring(2))
      : path.join(projectRoot, config.file);
    
    try {
      await fs.access(fullPath);
      config.found = true;
    } catch {
      config.found = false;
    }
  }

  return configPatterns;
}

/**
 * ä¸Šä¼ æ¨¡æ¿åˆ° Cloud Hub
 * é€šè¿‡ API å°†æ¨¡æ¿åŒ…ä¸Šä¼ åˆ°äº‘ç«¯æœåŠ¡
 */
async function uploadToCloudHub(templatePackage: TemplatePackage, isPublic: boolean): Promise<void> {
  try {
    // æ¨¡æ‹Ÿ API è°ƒç”¨ï¼ˆå®é™…åº”ä½¿ç”¨ HTTP å®¢æˆ·ç«¯ï¼‰
    const apiEndpoint = process.env.METEOR_CLOUD_API || 'https://api.meteor-shower.dev';
    const apiKey = process.env.METEOR_API_KEY;

    if (!apiKey) {
      console.log(chalk.yellow('\nâš ï¸ æœªè®¾ç½® API å¯†é’¥ï¼Œè·³è¿‡ä¸Šä¼ '));
      console.log(chalk.gray('æç¤º: è®¾ç½® METEOR_API_KEY ç¯å¢ƒå˜é‡ä»¥å¯ç”¨äº‘ç«¯åŒæ­¥'));
      return;
    }

    // TODO: å®ç°å®é™…çš„ HTTP è¯·æ±‚
    // const response = await fetch(`${apiEndpoint}/templates`, {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json',
    //     'Authorization': `Bearer ${apiKey}`
    //   },
    //   body: JSON.stringify({
    //     ...templatePackage,
    //     public: isPublic
    //   })
    // });
    //
    // if (!response.ok) {
    //   throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.statusText}`);
    // }

    // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    console.log(chalk.green('âœ… ä¸Šä¼ æˆåŠŸï¼'));
    console.log(chalk.gray('  æ¨¡æ¿ID: ' + templatePackage.name + '-' + Date.now()));
    console.log(chalk.gray('  å¯è§æ€§: ' + (isPublic ? 'å…¬å¼€' : 'ç§æœ‰')));
    console.log(chalk.gray('  åˆ†äº«é“¾æ¥: ' + apiEndpoint + '/templates/' + templatePackage.name));
    
  } catch (error: any) {
    console.error(chalk.red('âŒ ä¸Šä¼ å¤±è´¥: ' + error.message));
    console.log(chalk.yellow('æ¨¡æ¿å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œå¯ä»¥ç¨åé‡è¯•ä¸Šä¼ '));
  }
}
