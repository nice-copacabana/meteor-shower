// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-17
// Task: å®ç°CLIç”¨æˆ·ç®¡ç†å‘½ä»¤ï¼ˆ4ä¸ªå‘½ä»¤ï¼‰

/**
 * ç”¨æˆ·ç®¡ç†CLIå‘½ä»¤
 * 
 * æä¾›ç”¨æˆ·ç™»å½•ã€æŸ¥çœ‹ä¿¡æ¯ã€æŸ¥çœ‹é…é¢ã€å‡çº§å±‚çº§ç­‰åŠŸèƒ½
 */

import { Command } from 'commander';
import inquirer from 'inquirer';
import axios from 'axios';
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

const CONFIG_DIR = path.join(os.homedir(), '.meteor-shower');
const CONFIG_FILE = path.join(CONFIG_DIR, 'auth.json');
const API_BASE_URL = process.env.METEOR_SHOWER_API_URL || 'http://localhost:3000';

/**
 * ä¿å­˜è®¤è¯ä¿¡æ¯
 */
function saveAuth(userId: string, token: string): void {
  if (!fs.existsSync(CONFIG_DIR)) {
    fs.mkdirSync(CONFIG_DIR, { recursive: true });
  }
  
  fs.writeFileSync(CONFIG_FILE, JSON.stringify({ userId, token }, null, 2));
}

/**
 * è¯»å–è®¤è¯ä¿¡æ¯
 */
function loadAuth(): { userId: string; token: string } | null {
  if (!fs.existsSync(CONFIG_FILE)) {
    return null;
  }
  
  try {
    return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf-8'));
  } catch {
    return null;
  }
}

/**
 * åˆ é™¤è®¤è¯ä¿¡æ¯
 */
function clearAuth(): void {
  if (fs.existsSync(CONFIG_FILE)) {
    fs.unlinkSync(CONFIG_FILE);
  }
}

/**
 * åˆ›å»ºç”¨æˆ·å‘½ä»¤
 */
export function createUserCommand(): Command {
  const command = new Command('user');
  command.description('ç”¨æˆ·ç®¡ç†å‘½ä»¤');

  /**
   * user login - ç”¨æˆ·ç™»å½•
   */
  command
    .command('login')
    .description('ç™»å½•åˆ°meteor-shower')
    .option('--email <email>', 'ç”¨æˆ·é‚®ç®±')
    .option('--password <password>', 'ç”¨æˆ·å¯†ç ')
    .action(async (options) => {
      try {
        let { email, password } = options;
        
        // å¦‚æœæ²¡æœ‰æä¾›å‚æ•°ï¼Œäº¤äº’å¼è¯¢é—®
        if (!email || !password) {
          const answers = await inquirer.prompt([
            {
              type: 'input',
              name: 'email',
              message: 'è¯·è¾“å…¥é‚®ç®±:',
              when: !email,
            },
            {
              type: 'password',
              name: 'password',
              message: 'è¯·è¾“å…¥å¯†ç :',
              when: !password,
            },
          ]);
          
          email = email || answers.email;
          password = password || answers.password;
        }
        
        // è°ƒç”¨ç™»å½•API
        const response = await axios.post(`${API_BASE_URL}/api/users/login`, {
          email,
          password,
        });
        
        const { userId, tier, token } = response.data;
        
        // ä¿å­˜è®¤è¯ä¿¡æ¯
        saveAuth(userId, token);
        
        console.log('âœ… ç™»å½•æˆåŠŸ!');
        console.log(`   ç”¨æˆ·ID: ${userId}`);
        console.log(`   å±‚çº§: ${tier}`);
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ ç™»å½•å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  /**
   * user logout - ç”¨æˆ·ç™»å‡º
   */
  command
    .command('logout')
    .description('ç™»å‡ºmeteor-shower')
    .action(() => {
      clearAuth();
      console.log('âœ… å·²ç™»å‡º');
    });

  /**
   * user info - æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
   */
  command
    .command('info')
    .description('æŸ¥çœ‹å½“å‰ç”¨æˆ·ä¿¡æ¯')
    .action(async () => {
      try {
        const auth = loadAuth();
        
        if (!auth) {
          console.error('âŒ è¯·å…ˆç™»å½• (meteor-shower user login)');
          process.exit(1);
        }
        
        // è°ƒç”¨ç”¨æˆ·ä¿¡æ¯API
        const response = await axios.get(`${API_BASE_URL}/api/users/${auth.userId}`);
        
        const user = response.data;
        
        console.log('\nğŸ“‹ ç”¨æˆ·ä¿¡æ¯:');
        console.log(`   ID: ${user.id}`);
        console.log(`   é‚®ç®±: ${user.email}`);
        console.log(`   å±‚çº§: ${user.tier}`);
        console.log(`   åˆ›å»ºæ—¶é—´: ${user.createdAt}`);
        
        if (user.lastLoginAt) {
          console.log(`   æœ€åç™»å½•: ${user.lastLoginAt}`);
        }
        
        console.log('\nğŸ“Š é…é¢ä½¿ç”¨æƒ…å†µ:');
        
        const quotaTypes = {
          TOOL: 'å·¥å…·æ•°é‡',
          CLOUD_TEMPLATE: 'äº‘ç«¯æ¨¡æ¿',
          VALIDATION: 'æœˆéªŒè¯æ¬¡æ•°',
          CONCURRENT_TASK: 'å¹¶å‘ä»»åŠ¡',
          STORAGE: 'å­˜å‚¨ç©ºé—´',
        };
        
        Object.entries(user.quota).forEach(([type, data]: [string, any]) => {
          const name = quotaTypes[type as keyof typeof quotaTypes] || type;
          const used = data.used;
          const limit = data.limit === Infinity ? 'æ— é™' : data.limit;
          const remaining = data.remaining === Infinity ? 'æ— é™' : data.remaining;
          
          console.log(`   ${name}: ${used}/${limit} (å‰©ä½™: ${remaining})`);
        });
        
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  /**
   * user quota - æŸ¥çœ‹é…é¢ä½¿ç”¨æƒ…å†µ
   */
  command
    .command('quota')
    .description('æŸ¥çœ‹é…é¢ä½¿ç”¨æƒ…å†µ')
    .option('--resource-type <type>', 'èµ„æºç±»å‹ (TOOL/CLOUD_TEMPLATE/VALIDATION/CONCURRENT_TASK/STORAGE)')
    .action(async (options) => {
      try {
        const auth = loadAuth();
        
        if (!auth) {
          console.error('âŒ è¯·å…ˆç™»å½• (meteor-shower user login)');
          process.exit(1);
        }
        
        // è°ƒç”¨é…é¢æŸ¥è¯¢API
        const response = await axios.get(`${API_BASE_URL}/api/users/${auth.userId}/quota`);
        
        const quotas = response.data;
        
        const quotaTypes = {
          TOOL: 'å·¥å…·æ•°é‡',
          CLOUD_TEMPLATE: 'äº‘ç«¯æ¨¡æ¿',
          VALIDATION: 'æœˆéªŒè¯æ¬¡æ•°',
          CONCURRENT_TASK: 'å¹¶å‘ä»»åŠ¡',
          STORAGE: 'å­˜å‚¨ç©ºé—´',
        };
        
        console.log('\nğŸ“Š é…é¢ä½¿ç”¨æƒ…å†µ:');
        
        Object.entries(quotas).forEach(([type, data]: [string, any]) => {
          if (options.resourceType && type !== options.resourceType) {
            return;
          }
          
          const name = quotaTypes[type as keyof typeof quotaTypes] || type;
          const used = data.used;
          const limit = data.limit === Infinity ? 'æ— é™' : data.limit;
          const remaining = data.remaining === Infinity ? 'æ— é™' : data.remaining;
          const resetAt = new Date(data.resetAt).toLocaleDateString();
          
          console.log(`\n   ${name}:`);
          console.log(`     å·²ä½¿ç”¨: ${used}`);
          console.log(`     æ€»é™åˆ¶: ${limit}`);
          console.log(`     å‰©ä½™: ${remaining}`);
          console.log(`     é‡ç½®æ—¶é—´: ${resetAt}`);
        });
        
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ æŸ¥è¯¢é…é¢å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  /**
   * user upgrade - å‡çº§ç”¨æˆ·å±‚çº§
   */
  command
    .command('upgrade')
    .description('å‡çº§ç”¨æˆ·å±‚çº§')
    .requiredOption('--tier <tier>', 'æ–°å±‚çº§ (PROFESSIONAL/TEAM/ENTERPRISE)')
    .option('--payment-method <method>', 'æ”¯ä»˜æ–¹å¼ (ALIPAY/WECHAT/STRIPE)', 'ALIPAY')
    .action(async (options) => {
      try {
        const auth = loadAuth();
        
        if (!auth) {
          console.error('âŒ è¯·å…ˆç™»å½• (meteor-shower user login)');
          process.exit(1);
        }
        
        const validTiers = ['PROFESSIONAL', 'TEAM', 'ENTERPRISE'];
        if (!validTiers.includes(options.tier)) {
          console.error(`âŒ æ— æ•ˆçš„å±‚çº§ç±»å‹ã€‚æœ‰æ•ˆå€¼: ${validTiers.join(', ')}`);
          process.exit(1);
        }
        
        // ç¡®è®¤å‡çº§
        const { confirm } = await inquirer.prompt([
          {
            type: 'confirm',
            name: 'confirm',
            message: `ç¡®å®šè¦å‡çº§åˆ° ${options.tier} å±‚çº§å—?`,
            default: false,
          },
        ]);
        
        if (!confirm) {
          console.log('å·²å–æ¶ˆå‡çº§');
          return;
        }
        
        // è°ƒç”¨å‡çº§API
        const response = await axios.put(`${API_BASE_URL}/api/users/${auth.userId}/tier`, {
          newTier: options.tier,
          paymentInfo: {
            paymentMethod: options.paymentMethod,
          },
        });
        
        console.log('âœ… å‡çº§æˆåŠŸ!');
        console.log(`   æ–°å±‚çº§: ${response.data.newTier}`);
        
        if (response.data.subscription) {
          console.log(`   è®¢é˜…ID: ${response.data.subscription.id}`);
          console.log(`   å¼€å§‹æ—¥æœŸ: ${response.data.subscription.start_date}`);
          console.log(`   ç»“æŸæ—¥æœŸ: ${response.data.subscription.end_date}`);
        }
        
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ å‡çº§å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  return command;
}
