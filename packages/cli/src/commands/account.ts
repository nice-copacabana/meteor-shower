// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: M6 Phase1 - é›†æˆç”¨æˆ·å±‚çº§æ£€æŸ¥åˆ°CLIå‘½ä»¤ä¸­ - accountå‘½ä»¤

import chalk from 'chalk';
import inquirer from 'inquirer';
import Database from 'better-sqlite3';
import path from 'path';
import os from 'os';
import Table from 'cli-table3';
import { UserTierManager } from '@meteor-shower/enterprise/tier/tier-manager.js';
import { UserTier } from '@meteor-shower/enterprise/database/schema.js';

/**
 * è´¦æˆ·å‘½ä»¤é€‰é¡¹
 */
export interface AccountOptions {
  action?: 'info' | 'quota' | 'upgrade' | 'compare';
}

/**
 * è´¦æˆ·ç®¡ç†å‘½ä»¤
 * æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯ã€é…é¢ã€å‡çº§å»ºè®®
 */
export async function accountCommand(options: AccountOptions = {}) {
  const userId = process.env.METEOR_USER_ID;
  
  if (!userId) {
    console.log(chalk.red('\nâŒ æœªç™»å½•'));
    console.log(chalk.gray('æç¤º: è®¾ç½® METEOR_USER_ID ç¯å¢ƒå˜é‡æˆ–è¿è¡Œ ms login'));
    console.log(chalk.gray('ç¤ºä¾‹: export METEOR_USER_ID=your-user-id\n'));
    return;
  }

  try {
    const dbPath = process.env.METEOR_DB_PATH || path.join(os.homedir(), '.meteor-shower', 'meteor.db');
    const db = new Database(dbPath);
    const tierManager = new UserTierManager(db);

    // å¦‚æœæ²¡æœ‰æŒ‡å®šactionï¼Œæ˜¾ç¤ºèœå•
    let action = options.action;
    if (!action) {
      const { selectedAction } = await inquirer.prompt([
        {
          type: 'list',
          name: 'selectedAction',
          message: 'é€‰æ‹©æ“ä½œ:',
          choices: [
            { name: 'ğŸ“Š æŸ¥çœ‹è´¦æˆ·ä¿¡æ¯', value: 'info' },
            { name: 'ğŸ“ˆ æŸ¥çœ‹é…é¢ä½¿ç”¨æƒ…å†µ', value: 'quota' },
            { name: 'â¬†ï¸  å‡çº§å±‚çº§', value: 'upgrade' },
            { name: 'ğŸ” å¯¹æ¯”ä¸åŒå±‚çº§', value: 'compare' }
          ]
        }
      ]);
      action = selectedAction;
    }

    switch (action) {
      case 'info':
        await showAccountInfo(tierManager, userId);
        break;
      case 'quota':
        await showQuotaInfo(tierManager, userId);
        break;
      case 'upgrade':
        await showUpgradeInfo(tierManager, userId);
        break;
      case 'compare':
        await showTierComparison(tierManager);
        break;
      default:
        console.log(chalk.red('æœªçŸ¥æ“ä½œ'));
    }

    db.close();
  } catch (error: any) {
    console.error(chalk.red(`\nâŒ é”™è¯¯: ${error.message}`));
  }
}

/**
 * æ˜¾ç¤ºè´¦æˆ·ä¿¡æ¯
 */
async function showAccountInfo(tierManager: UserTierManager, userId: string): Promise<void> {
  console.log(chalk.cyan('\nğŸ“Š è´¦æˆ·ä¿¡æ¯\n'));

  const quotas = tierManager.getUserQuotas(userId);
  if (!quotas) {
    console.log(chalk.red('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯'));
    return;
  }

  console.log(chalk.white(`ç”¨æˆ·ID:    ${userId}`));
  console.log(chalk.white(`å½“å‰å±‚çº§:  ${getTierDisplayName(quotas.tier)}`));
  console.log('');

  // é…é¢æ‘˜è¦è¡¨æ ¼
  const table = new Table({
    head: [chalk.cyan('é…é¢ç±»å‹'), chalk.cyan('å·²ä½¿ç”¨'), chalk.cyan('æ€»é™é¢'), chalk.cyan('å‰©ä½™')],
    colWidths: [20, 15, 15, 15]
  });

  table.push(
    [
      'Templates',
      quotas.templates.current,
      quotas.templates.limit === -1 ? 'æ— é™' : quotas.templates.limit,
      quotas.templates.remaining === -1 ? 'æ— é™' : quotas.templates.remaining
    ],
    [
      'Configs',
      quotas.configs.current,
      quotas.configs.limit === -1 ? 'æ— é™' : quotas.configs.limit,
      quotas.configs.remaining === -1 ? 'æ— é™' : quotas.configs.remaining
    ],
    [
      'Shares (æœ¬æœˆ)',
      quotas.shares.current,
      quotas.shares.limit === -1 ? 'æ— é™' : quotas.shares.limit,
      quotas.shares.remaining === -1 ? 'æ— é™' : quotas.shares.remaining
    ]
  );

  console.log(table.toString());

  // å‡çº§å»ºè®®
  const suggestion = tierManager.getUpgradeSuggestion(userId);
  if (suggestion.shouldUpgrade) {
    console.log(chalk.yellow('\nğŸ’¡ å‡çº§å»ºè®®:'));
    suggestion.reasons.forEach(reason => {
      console.log(chalk.gray(`   â€¢ ${reason}`));
    });
    if (suggestion.suggestedTier) {
      console.log(chalk.cyan(`\n   å»ºè®®å‡çº§åˆ°: ${getTierDisplayName(suggestion.suggestedTier)}`));
      console.log(chalk.gray('   è¿è¡Œ ms account upgrade æŸ¥çœ‹å‡çº§é€‰é¡¹\n'));
    }
  } else {
    console.log(chalk.green('\nâœ… å½“å‰é…é¢å……è¶³\n'));
  }
}

/**
 * æ˜¾ç¤ºé…é¢è¯¦æƒ…
 */
async function showQuotaInfo(tierManager: UserTierManager, userId: string): Promise<void> {
  console.log(chalk.cyan('\nğŸ“ˆ é…é¢ä½¿ç”¨æƒ…å†µ\n'));

  const quotas = tierManager.getUserQuotas(userId);
  if (!quotas) {
    console.log(chalk.red('æ— æ³•è·å–é…é¢ä¿¡æ¯'));
    return;
  }

  // Templatesé…é¢
  console.log(chalk.yellow('ğŸ“„ Templates:'));
  console.log(chalk.gray(`   å·²ä½¿ç”¨: ${quotas.templates.current}`));
  console.log(chalk.gray(`   æ€»é™é¢: ${quotas.templates.limit === -1 ? 'æ— é™' : quotas.templates.limit}`));
  if (quotas.templates.limit !== -1) {
    const percentage = (quotas.templates.current / quotas.templates.limit) * 100;
    const bar = generateProgressBar(percentage);
    console.log(chalk.gray(`   è¿›åº¦:   ${bar} ${percentage.toFixed(1)}%`));
  }
  console.log('');

  // Configsé…é¢
  console.log(chalk.yellow('âš™ï¸  Configs:'));
  console.log(chalk.gray(`   å·²ä½¿ç”¨: ${quotas.configs.current}`));
  console.log(chalk.gray(`   æ€»é™é¢: ${quotas.configs.limit === -1 ? 'æ— é™' : quotas.configs.limit}`));
  if (quotas.configs.limit !== -1) {
    const percentage = (quotas.configs.current / quotas.configs.limit) * 100;
    const bar = generateProgressBar(percentage);
    console.log(chalk.gray(`   è¿›åº¦:   ${bar} ${percentage.toFixed(1)}%`));
  }
  console.log('');

  // Sharesé…é¢
  console.log(chalk.yellow('ğŸ”— Shares (æœ¬æœˆ):'));
  console.log(chalk.gray(`   å·²ä½¿ç”¨: ${quotas.shares.current}`));
  console.log(chalk.gray(`   æ€»é™é¢: ${quotas.shares.limit === -1 ? 'æ— é™' : quotas.shares.limit}`));
  if (quotas.shares.limit !== -1) {
    const percentage = (quotas.shares.current / quotas.shares.limit) * 100;
    const bar = generateProgressBar(percentage);
    console.log(chalk.gray(`   è¿›åº¦:   ${bar} ${percentage.toFixed(1)}%`));
  }
  console.log('');
}

/**
 * æ˜¾ç¤ºå‡çº§ä¿¡æ¯
 */
async function showUpgradeInfo(tierManager: UserTierManager, userId: string): Promise<void> {
  console.log(chalk.cyan('\nâ¬†ï¸  å±‚çº§å‡çº§\n'));

  const quotas = tierManager.getUserQuotas(userId);
  if (!quotas) {
    console.log(chalk.red('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯'));
    return;
  }

  console.log(chalk.white(`å½“å‰å±‚çº§: ${getTierDisplayName(quotas.tier)}\n`));

  const tiers = tierManager.getTierComparison();
  const currentTier = quotas.tier;

  // å¯å‡çº§çš„å±‚çº§
  const upgradeTiers = [];
  const tierOrder = [UserTier.FREE, UserTier.PROFESSIONAL, UserTier.TEAM, UserTier.ENTERPRISE];
  const currentIndex = tierOrder.indexOf(currentTier);

  for (let i = currentIndex + 1; i < tierOrder.length; i++) {
    upgradeTiers.push(tierOrder[i]);
  }

  if (upgradeTiers.length === 0) {
    console.log(chalk.green('âœ… æ‚¨å·²æ˜¯æœ€é«˜å±‚çº§ï¼\n'));
    return;
  }

  // æ˜¾ç¤ºå¯é€‰å‡çº§å±‚çº§
  console.log(chalk.yellow('å¯å‡çº§å±‚çº§:\n'));

  upgradeTiers.forEach(tier => {
    const tierInfo = tiers[tier];
    console.log(chalk.cyan(`${tierInfo.name}:`));
    console.log(chalk.gray(`  ${tierInfo.description}`));
    console.log(chalk.gray(`  Templates: ${tierInfo.quotas.templates === -1 ? 'æ— é™' : tierInfo.quotas.templates}`));
    console.log(chalk.gray(`  Configs:   ${tierInfo.quotas.configs === -1 ? 'æ— é™' : tierInfo.quotas.configs}`));
    console.log(chalk.gray(`  Shares:    ${tierInfo.quotas.shares === -1 ? 'æ— é™' : tierInfo.quotas.shares}`));
    console.log(chalk.gray('  åŠŸèƒ½:'));
    tierInfo.features.forEach(feature => {
      console.log(chalk.gray(`    â€¢ ${feature}`));
    });
    console.log('');
  });

  console.log(chalk.yellow('ğŸ’¡ å‡çº§æç¤º:'));
  console.log(chalk.gray('   è¯·è®¿é—® https://meteor-shower.dev/pricing äº†è§£è¯¦ç»†ä»·æ ¼'));
  console.log(chalk.gray('   æˆ–è”ç³»æˆ‘ä»¬çš„é”€å”®å›¢é˜Ÿè·å–å®šåˆ¶æ–¹æ¡ˆ\n'));
}

/**
 * æ˜¾ç¤ºå±‚çº§å¯¹æ¯”
 */
async function showTierComparison(tierManager: UserTierManager): Promise<void> {
  console.log(chalk.cyan('\nğŸ” å±‚çº§å¯¹æ¯”è¡¨\n'));

  const tiers = tierManager.getTierComparison();

  // åˆ›å»ºå¯¹æ¯”è¡¨æ ¼
  const table = new Table({
    head: [
      chalk.cyan('åŠŸèƒ½'),
      chalk.cyan('Free'),
      chalk.cyan('Professional'),
      chalk.cyan('Team'),
      chalk.cyan('Enterprise')
    ],
    colWidths: [25, 15, 18, 15, 15]
  });

  // Templatesé…é¢
  table.push([
    'Templatesé…é¢',
    tiers[UserTier.FREE].quotas.templates,
    tiers[UserTier.PROFESSIONAL].quotas.templates,
    tiers[UserTier.TEAM].quotas.templates,
    'æ— é™'
  ]);

  // Configsé…é¢
  table.push([
    'Configsé…é¢',
    tiers[UserTier.FREE].quotas.configs,
    tiers[UserTier.PROFESSIONAL].quotas.configs,
    tiers[UserTier.TEAM].quotas.configs,
    'æ— é™'
  ]);

  // Sharesé…é¢
  table.push([
    'Sharesé…é¢(æœˆ)',
    tiers[UserTier.FREE].quotas.shares,
    tiers[UserTier.PROFESSIONAL].quotas.shares,
    tiers[UserTier.TEAM].quotas.shares,
    'æ— é™'
  ]);

  // æœ€å¤§æˆå‘˜æ•°
  table.push([
    'æœ€å¤§æˆå‘˜æ•°',
    tiers[UserTier.FREE].quotas.max_members,
    tiers[UserTier.PROFESSIONAL].quotas.max_members,
    tiers[UserTier.TEAM].quotas.max_members,
    'æ— é™'
  ]);

  // äº‘ç«¯å¤‡ä»½
  table.push([
    'äº‘ç«¯å¤‡ä»½',
    'âŒ',
    'âœ…',
    'âœ…',
    'âœ…'
  ]);

  // å›¢é˜Ÿåä½œ
  table.push([
    'å›¢é˜Ÿåä½œ',
    'âŒ',
    'âŒ',
    'âœ…',
    'âœ…'
  ]);

  // å®¡è®¡æ—¥å¿—
  table.push([
    'å®¡è®¡æ—¥å¿—',
    'âŒ',
    'âŒ',
    'âœ…',
    'âœ…'
  ]);

  // SSO
  table.push([
    'SSOå•ç‚¹ç™»å½•',
    'âŒ',
    'âŒ',
    'âŒ',
    'âœ…'
  ]);

  // RBAC
  table.push([
    'RBACæƒé™ç®¡ç†',
    'âŒ',
    'âŒ',
    'âŒ',
    'âœ…'
  ]);

  console.log(table.toString());
  console.log('');
}

/**
 * è·å–å±‚çº§æ˜¾ç¤ºåç§°
 */
function getTierDisplayName(tier: UserTier): string {
  const names: Record<UserTier, string> = {
    [UserTier.FREE]: 'å…è´¹ç‰ˆ (Free)',
    [UserTier.PROFESSIONAL]: 'ä¸“ä¸šç‰ˆ (Professional)',
    [UserTier.TEAM]: 'å›¢é˜Ÿç‰ˆ (Team)',
    [UserTier.ENTERPRISE]: 'ä¼ä¸šç‰ˆ (Enterprise)'
  };
  return names[tier] || tier;
}

/**
 * ç”Ÿæˆè¿›åº¦æ¡
 */
function generateProgressBar(percentage: number, length: number = 20): string {
  const filled = Math.round((percentage / 100) * length);
  const empty = length - filled;
  
  let color: (text: string) => string;
  if (percentage < 50) {
    color = chalk.green;
  } else if (percentage < 80) {
    color = chalk.yellow;
  } else {
    color = chalk.red;
  }
  
  return color('â–ˆ'.repeat(filled)) + chalk.gray('â–‘'.repeat(empty));
}
