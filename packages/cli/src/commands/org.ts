// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-17
// Task: å®ç°CLIç»„ç»‡ç®¡ç†å‘½ä»¤ï¼ˆ3ä¸ªå‘½ä»¤ï¼‰

/**
 * ç»„ç»‡ç®¡ç†CLIå‘½ä»¤
 * 
 * æä¾›ç»„ç»‡åˆ›å»ºã€æŸ¥çœ‹ã€æˆå‘˜ç®¡ç†ç­‰åŠŸèƒ½
 */

import { Command } from 'commander';
import inquirer from 'inquirer';
import axios from 'axios';
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

const CONFIG_FILE = path.join(os.homedir(), '.meteor-shower', 'auth.json');
const API_BASE_URL = process.env.METEOR_SHOWER_API_URL || 'http://localhost:3000';

/**
 * è¯»å–è®¤è¯ä¿¡æ¯
 */
function loadAuth(): { userId: string; token: string } | null {
  if (!fs.existsSync(CONFIG_FILE)) {
    return null;
  }
  
  try {
    return JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf-8'));
  } catch {
    return null;
  }
}

/**
 * åˆ›å»ºç»„ç»‡å‘½ä»¤
 */
export function createOrgCommand(): Command {
  const command = new Command('org');
  command.description('ç»„ç»‡ç®¡ç†å‘½ä»¤');

  /**
   * org create - åˆ›å»ºç»„ç»‡
   */
  command
    .command('create')
    .description('åˆ›å»ºæ–°ç»„ç»‡')
    .requiredOption('--name <name>', 'ç»„ç»‡åç§°')
    .requiredOption('--tier <tier>', 'ç»„ç»‡å±‚çº§ (TEAM/ENTERPRISE)')
    .option('--max-members <number>', 'æœ€å¤§æˆå‘˜æ•°', '50')
    .action(async (options) => {
      try {
        const auth = loadAuth();
        
        if (!auth) {
          console.error('âŒ è¯·å…ˆç™»å½• (meteor-shower user login)');
          process.exit(1);
        }
        
        const validTiers = ['TEAM', 'ENTERPRISE'];
        if (!validTiers.includes(options.tier)) {
          console.error(`âŒ æ— æ•ˆçš„å±‚çº§ç±»å‹ã€‚æœ‰æ•ˆå€¼: ${validTiers.join(', ')}`);
          process.exit(1);
        }
        
        // è°ƒç”¨åˆ›å»ºç»„ç»‡API
        const response = await axios.post(`${API_BASE_URL}/api/organizations`, {
          name: options.name,
          tier: options.tier,
          ownerId: auth.userId,
          maxMembers: parseInt(options.maxMembers),
        });
        
        console.log('âœ… ç»„ç»‡åˆ›å»ºæˆåŠŸ!');
        console.log(`   ç»„ç»‡ID: ${response.data.orgId}`);
        console.log(`   åç§°: ${response.data.name}`);
        console.log(`   å±‚çº§: ${response.data.tier}`);
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ åˆ›å»ºç»„ç»‡å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  /**
   * org info - æŸ¥çœ‹ç»„ç»‡ä¿¡æ¯
   */
  command
    .command('info')
    .description('æŸ¥çœ‹ç»„ç»‡ä¿¡æ¯')
    .argument('[orgId]', 'ç»„ç»‡ID (å¯é€‰ï¼Œé»˜è®¤ä¸ºå½“å‰ç”¨æˆ·çš„ç»„ç»‡)')
    .action(async (orgId) => {
      try {
        const auth = loadAuth();
        
        if (!auth) {
          console.error('âŒ è¯·å…ˆç™»å½• (meteor-shower user login)');
          process.exit(1);
        }
        
        if (!orgId) {
          // å¦‚æœæ²¡æœ‰æä¾›ç»„ç»‡IDï¼Œéœ€è¦ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–
          const userResponse = await axios.get(`${API_BASE_URL}/api/users/${auth.userId}`);
          orgId = userResponse.data.organizationId;
          
          if (!orgId) {
            console.error('âŒ å½“å‰ç”¨æˆ·æœªåŠ å…¥ä»»ä½•ç»„ç»‡');
            process.exit(1);
          }
        }
        
        // è°ƒç”¨ç»„ç»‡ä¿¡æ¯API
        const response = await axios.get(`${API_BASE_URL}/api/organizations/${orgId}`);
        
        const org = response.data;
        
        console.log('\nğŸ¢ ç»„ç»‡ä¿¡æ¯:');
        console.log(`   ID: ${org.id}`);
        console.log(`   åç§°: ${org.name}`);
        console.log(`   å±‚çº§: ${org.tier}`);
        console.log(`   æ‰€æœ‰è€…: ${org.owner.email} (${org.owner.id})`);
        console.log(`   æˆå‘˜æ•°: ${org.members.total}/${org.members.max}`);
        console.log(`   åˆ›å»ºæ—¶é—´: ${org.createdAt}`);
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ è·å–ç»„ç»‡ä¿¡æ¯å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  /**
   * org invite - é‚€è¯·æˆå‘˜
   */
  command
    .command('invite')
    .description('é‚€è¯·æˆå‘˜åŠ å…¥ç»„ç»‡')
    .requiredOption('--email <email>', 'æˆå‘˜é‚®ç®±æˆ–ç”¨æˆ·ID')
    .option('--role <role>', 'è§’è‰² (admin/member)', 'member')
    .option('--org-id <orgId>', 'ç»„ç»‡ID')
    .action(async (options) => {
      try {
        const auth = loadAuth();
        
        if (!auth) {
          console.error('âŒ è¯·å…ˆç™»å½• (meteor-shower user login)');
          process.exit(1);
        }
        
        let orgId = options.orgId;
        
        if (!orgId) {
          // å¦‚æœæ²¡æœ‰æä¾›ç»„ç»‡IDï¼Œä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–
          const userResponse = await axios.get(`${API_BASE_URL}/api/users/${auth.userId}`);
          orgId = userResponse.data.organizationId;
          
          if (!orgId) {
            console.error('âŒ è¯·æŒ‡å®šç»„ç»‡ID (--org-id)');
            process.exit(1);
          }
        }
        
        // å‡è®¾emailæ˜¯ç”¨æˆ·IDï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥é€šè¿‡é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·ï¼‰
        const userId = options.email;
        
        // è°ƒç”¨æ·»åŠ æˆå‘˜API
        await axios.post(`${API_BASE_URL}/api/organizations/${orgId}/members`, {
          userId,
          role: options.role,
        });
        
        console.log('âœ… æˆå‘˜é‚€è¯·æˆåŠŸ!');
        console.log(`   ç”¨æˆ·: ${userId}`);
        console.log(`   è§’è‰²: ${options.role}`);
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ é‚€è¯·æˆå‘˜å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  /**
   * org remove - ç§»é™¤æˆå‘˜
   */
  command
    .command('remove')
    .description('ä»ç»„ç»‡ä¸­ç§»é™¤æˆå‘˜')
    .requiredOption('--email <email>', 'æˆå‘˜é‚®ç®±æˆ–ç”¨æˆ·ID')
    .option('--org-id <orgId>', 'ç»„ç»‡ID')
    .action(async (options) => {
      try {
        const auth = loadAuth();
        
        if (!auth) {
          console.error('âŒ è¯·å…ˆç™»å½• (meteor-shower user login)');
          process.exit(1);
        }
        
        let orgId = options.orgId;
        
        if (!orgId) {
          // å¦‚æœæ²¡æœ‰æä¾›ç»„ç»‡IDï¼Œä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–
          const userResponse = await axios.get(`${API_BASE_URL}/api/users/${auth.userId}`);
          orgId = userResponse.data.organizationId;
          
          if (!orgId) {
            console.error('âŒ è¯·æŒ‡å®šç»„ç»‡ID (--org-id)');
            process.exit(1);
          }
        }
        
        // ç¡®è®¤ç§»é™¤
        const { confirm } = await inquirer.prompt([
          {
            type: 'confirm',
            name: 'confirm',
            message: `ç¡®å®šè¦ç§»é™¤æˆå‘˜ ${options.email} å—?`,
            default: false,
          },
        ]);
        
        if (!confirm) {
          console.log('å·²å–æ¶ˆç§»é™¤');
          return;
        }
        
        // å‡è®¾emailæ˜¯ç”¨æˆ·IDï¼ˆç®€åŒ–ç‰ˆï¼‰
        const userId = options.email;
        
        // è°ƒç”¨ç§»é™¤æˆå‘˜API
        await axios.delete(`${API_BASE_URL}/api/organizations/${orgId}/members/${userId}`);
        
        console.log('âœ… æˆå‘˜å·²ç§»é™¤');
      } catch (error: any) {
        if (error.response) {
          console.error(`âŒ ç§»é™¤æˆå‘˜å¤±è´¥: ${error.response.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        } else {
          console.error(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
        }
        process.exit(1);
      }
    });

  return command;
}
