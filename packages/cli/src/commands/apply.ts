// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°CLI applyå‘½ä»¤å®é™…é€»è¾‘

/**
 * é…ç½®åº”ç”¨å‘½ä»¤
 * è´Ÿè´£å°†é…ç½®è®¡åˆ’å®é™…åº”ç”¨åˆ°ç³»ç»Ÿï¼Œç”Ÿæˆæˆ–æ›´æ–°é…ç½®æ–‡ä»¶
 *
 * æ ¸å¿ƒèŒè´£ï¼š
 * - è¯»å–å¹¶éªŒè¯é…ç½®è®¡åˆ’
 * - å‘ç”¨æˆ·ç¡®è®¤æ“ä½œï¼ˆå¯è·³è¿‡ï¼‰
 * - è°ƒç”¨é€‚é…å™¨åº”ç”¨é…ç½®
 * - æä¾›å¤‡ä»½å’Œå›æ»šæœºåˆ¶ï¼ˆé€šè¿‡é€‚é…å™¨å®ç°ï¼‰
 */

import chalk from 'chalk';
import inquirer from 'inquirer';
import fs from 'fs/promises';
import path from 'path';
import { createAdapter } from '@meteor-shower/adapters';

/**
 * åº”ç”¨é…ç½®é€‰é¡¹
 */
export interface ApplyOptions {
  yes?: boolean;  // è·³è¿‡ç¡®è®¤æç¤ºï¼Œç›´æ¥åº”ç”¨
}

/**
 * åº”ç”¨é…ç½®å‘½ä»¤ä¸»å‡½æ•°
 *
 * ä¸šåŠ¡æµç¨‹ï¼š
 * 1. è¯»å–é…ç½®è®¡åˆ’ - ä» .meteor-shower/config-plan.json è¯»å–
 * 2. æ˜¾ç¤ºè®¡åˆ’æ‘˜è¦ - å±•ç¤ºå°†è¦è¿›è¡Œçš„æ“ä½œ
 * 3. ç”¨æˆ·ç¡®è®¤ - é™¤éä½¿ç”¨ --yes å‚æ•°ï¼Œå¦åˆ™éœ€è¦ç”¨æˆ·ç¡®è®¤
 * 4. åº”ç”¨é…ç½® - è°ƒç”¨æ¯ä¸ªå·¥å…·çš„é€‚é…å™¨è¿›è¡Œ apply()
 * 5. æ˜¾ç¤ºç»“æœ - æç¤ºç”¨æˆ·é…ç½®å·²åº”ç”¨
 *
 * æ³¨æ„ï¼š
 * - é€‚é…å™¨å†…éƒ¨å¤„ç†æ–‡ä»¶å¤‡ä»½å’Œé”™è¯¯å›æ»š
 * - dryRun=false è¡¨ç¤ºå®é™…ä¿®æ”¹æ–‡ä»¶
 * 
 * @param options åº”ç”¨é€‰é¡¹
 */
  console.log(chalk.cyan('âš¡ åº”ç”¨é…ç½®å˜æ›´...'));
  
  try {
    // ========== è¯»å–é…ç½®è®¡åˆ’ ==========
    const planPath = path.join(process.cwd(), '.meteor-shower', 'config-plan.json');
    const planContent = await fs.readFile(planPath, 'utf-8');
    const configPlan = JSON.parse(planContent);
    
    console.log(chalk.gray(`ğŸ“„ é…ç½®è®¡åˆ’: ${configPlan.template}`));
    console.log(chalk.gray(`ğŸ¯ ç›®æ ‡å·¥å…·: ${configPlan.toolset.join(', ')}`));
    console.log(chalk.gray(`ğŸ“ å°†åˆ›å»º ${configPlan.operations.length} ä¸ªæ–‡ä»¶`));
    
    // ========== ç”¨æˆ·ç¡®è®¤ ==========
    // å¦‚æœæ²¡æœ‰ --yes å‚æ•°ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤
    if (!options.yes) {
      const { confirm } = await inquirer.prompt([{
        type: 'confirm',
        name: 'confirm',
        message: 'ç¡®å®šè¦åº”ç”¨è¿™äº›é…ç½®å˜æ›´å—ï¼Ÿ',
        default: false
      }]);
      
      if (!confirm) {
        console.log(chalk.yellow('âŒ æ“ä½œå·²å–æ¶ˆ'));
        return;
      }
    }
    
    // ========== åº”ç”¨é…ç½® ==========
    // ä¾æ¬¡ä¸ºæ¯ä¸ªå·¥å…·åº”ç”¨é…ç½®
    console.log(chalk.green('\nğŸ“ åº”ç”¨è¿›åº¦:'));
    
    for (const tool of configPlan.toolset) {
      console.log(chalk.gray(`  ğŸ”§ å¤„ç† ${tool} é…ç½®...`));
      
      const adapter = createAdapter(tool);
      await adapter.apply({
        target: tool,
        dryRun: false,
        variables: configPlan.variables
      });
      
      console.log(chalk.green(`  âœ… ${tool} é…ç½®å®Œæˆ`));
    }
    
    console.log(chalk.green('\nğŸ‰ é…ç½®åº”ç”¨æˆåŠŸï¼'));
    console.log(chalk.gray('ğŸ’¡ ä½¿ç”¨ ms diff æŸ¥çœ‹å˜æ›´ï¼Œæˆ–è¿è¡Œç›¸åº”å·¥å…·éªŒè¯é…ç½®'));
    
  } catch (error: any) {
    if (error.code === 'ENOENT') {
      console.error(chalk.red('âŒ æœªæ‰¾åˆ°é…ç½®è®¡åˆ’æ–‡ä»¶'));
      console.log(chalk.gray('ğŸ’¡ è¯·å…ˆè¿è¡Œ ms init åˆå§‹åŒ–é…ç½®'));
    } else {
      console.error(chalk.red('âŒ åº”ç”¨å¤±è´¥:'), error);
    }
  }
}
