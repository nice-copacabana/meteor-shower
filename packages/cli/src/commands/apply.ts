// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: å®ç°CLI applyå‘½ä»¤å®é™…é€»è¾‘

import chalk from 'chalk';
import inquirer from 'inquirer';
import fs from 'fs/promises';
import path from 'path';
import { createAdapter } from '@meteor-shower/adapters';

export interface ApplyOptions {
  yes?: boolean;
}

export async function applyCommand(options: ApplyOptions = {}) {
  console.log(chalk.cyan('âš¡ åº”ç”¨é…ç½®å˜æ›´...'));
  
  try {
    // è¯»å–é…ç½®è®¡åˆ’
    const planPath = path.join(process.cwd(), '.meteor-shower', 'config-plan.json');
    const planContent = await fs.readFile(planPath, 'utf-8');
    const configPlan = JSON.parse(planContent);
    
    console.log(chalk.gray(`ğŸ“„ é…ç½®è®¡åˆ’: ${configPlan.template}`));
    console.log(chalk.gray(`ğŸ¯ ç›®æ ‡å·¥å…·: ${configPlan.toolset.join(', ')}`));
    console.log(chalk.gray(`ğŸ“ å°†åˆ›å»º ${configPlan.operations.length} ä¸ªæ–‡ä»¶`));
    
    // ç¡®è®¤åº”ç”¨
    if (!options.yes) {
      const { confirm } = await inquirer.prompt([{
        type: 'confirm',
        name: 'confirm',
        message: 'ç¡®å®šè¦åº”ç”¨è¿™äº›é…ç½®å˜æ›´å—ï¼Ÿ',
        default: false
      }]);
      
      if (!confirm) {
        console.log(chalk.yellow('âŒ æ“ä½œå·²å–æ¶ˆ'));
        return;
      }
    }
    
    // åº”ç”¨é…ç½®
    console.log(chalk.green('\nğŸ“ åº”ç”¨è¿›åº¦:'));
    
    for (const tool of configPlan.toolset) {
      console.log(chalk.gray(`  ğŸ”§ å¤„ç† ${tool} é…ç½®...`));
      
      const adapter = createAdapter(tool);
      await adapter.apply({
        target: tool,
        dryRun: false,
        variables: configPlan.variables
      });
      
      console.log(chalk.green(`  âœ… ${tool} é…ç½®å®Œæˆ`));
    }
    
    console.log(chalk.green('\nğŸ‰ é…ç½®åº”ç”¨æˆåŠŸï¼'));
    console.log(chalk.gray('ğŸ’¡ ä½¿ç”¨ ms diff æŸ¥çœ‹å˜æ›´ï¼Œæˆ–è¿è¡Œç›¸åº”å·¥å…·éªŒè¯é…ç½®'));
    
  } catch (error: any) {
    if (error.code === 'ENOENT') {
      console.error(chalk.red('âŒ æœªæ‰¾åˆ°é…ç½®è®¡åˆ’æ–‡ä»¶'));
      console.log(chalk.gray('ğŸ’¡ è¯·å…ˆè¿è¡Œ ms init åˆå§‹åŒ–é…ç½®'));
    } else {
      console.error(chalk.red('âŒ åº”ç”¨å¤±è´¥:'), error);
    }
  }
}
