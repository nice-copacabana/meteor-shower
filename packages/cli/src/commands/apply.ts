// Generated by Qoder AI (Model: claude-sonnet-4-20250514) - 2025-10-14
// Task: 实现CLI apply命令实际逻辑

/**
 * 配置应用命令
 * 负责将配置计划实际应用到系统，生成或更新配置文件
 *
 * 核心职责：
 * - 读取并验证配置计划
 * - 向用户确认操作（可跳过）
 * - 调用适配器应用配置
 * - 提供备份和回滚机制（通过适配器实现）
 */

import chalk from 'chalk';
import inquirer from 'inquirer';
import fs from 'fs/promises';
import path from 'path';
import { createAdapter } from '@meteor-shower/adapters';

/**
 * 应用配置选项
 */
export interface ApplyOptions {
  yes?: boolean;  // 跳过确认提示，直接应用
}

/**
 * 应用配置命令主函数
 *
 * 业务流程：
 * 1. 读取配置计划 - 从 .meteor-shower/config-plan.json 读取
 * 2. 显示计划摘要 - 展示将要进行的操作
 * 3. 用户确认 - 除非使用 --yes 参数，否则需要用户确认
 * 4. 应用配置 - 调用每个工具的适配器进行 apply()
 * 5. 显示结果 - 提示用户配置已应用
 *
 * 注意：
 * - 适配器内部处理文件备份和错误回滚
 * - dryRun=false 表示实际修改文件
 * 
 * @param options 应用选项
 */
  console.log(chalk.cyan('⚡ 应用配置变更...'));
  
  try {
    // ========== 读取配置计划 ==========
    const planPath = path.join(process.cwd(), '.meteor-shower', 'config-plan.json');
    const planContent = await fs.readFile(planPath, 'utf-8');
    const configPlan = JSON.parse(planContent);
    
    console.log(chalk.gray(`📄 配置计划: ${configPlan.template}`));
    console.log(chalk.gray(`🎯 目标工具: ${configPlan.toolset.join(', ')}`));
    console.log(chalk.gray(`📝 将创建 ${configPlan.operations.length} 个文件`));
    
    // ========== 用户确认 ==========
    // 如果没有 --yes 参数，需要用户手动确认
    if (!options.yes) {
      const { confirm } = await inquirer.prompt([{
        type: 'confirm',
        name: 'confirm',
        message: '确定要应用这些配置变更吗？',
        default: false
      }]);
      
      if (!confirm) {
        console.log(chalk.yellow('❌ 操作已取消'));
        return;
      }
    }
    
    // ========== 应用配置 ==========
    // 依次为每个工具应用配置
    console.log(chalk.green('\n📝 应用进度:'));
    
    for (const tool of configPlan.toolset) {
      console.log(chalk.gray(`  🔧 处理 ${tool} 配置...`));
      
      const adapter = createAdapter(tool);
      await adapter.apply({
        target: tool,
        dryRun: false,
        variables: configPlan.variables
      });
      
      console.log(chalk.green(`  ✅ ${tool} 配置完成`));
    }
    
    console.log(chalk.green('\n🎉 配置应用成功！'));
    console.log(chalk.gray('💡 使用 ms diff 查看变更，或运行相应工具验证配置'));
    
  } catch (error: any) {
    if (error.code === 'ENOENT') {
      console.error(chalk.red('❌ 未找到配置计划文件'));
      console.log(chalk.gray('💡 请先运行 ms init 初始化配置'));
    } else {
      console.error(chalk.red('❌ 应用失败:'), error);
    }
  }
}
