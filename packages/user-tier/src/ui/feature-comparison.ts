// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-15
// Task: M6 Phase5 - åŠŸèƒ½å¯¹æ¯”è¡¨æ•°æ®æ¨¡å‹å’ŒCLIå±•ç¤º

import chalk from 'chalk';
import { UserTier, TIER_LIMITS } from '../types.js';
import { Feature, FeatureManager } from '../features/feature-flags.js';
import { QuotaType, QUOTA_LIMITS } from '../quota/quota-manager.js';

/**
 * åŠŸèƒ½åˆ†ç±»
 */
export enum FeatureCategory {
  /** åŸºç¡€åŠŸèƒ½ */
  BASIC = 'basic',
  /** é…é¢é™åˆ¶ */
  QUOTA = 'quota',
  /** é«˜çº§åŠŸèƒ½ */
  ADVANCED = 'advanced',
  /** åä½œåŠŸèƒ½ */
  COLLABORATION = 'collaboration',
  /** å®‰å…¨ä¸åˆè§„ */
  SECURITY = 'security',
  /** æ”¯æŒæœåŠ¡ */
  SUPPORT = 'support',
}

/**
 * åŠŸèƒ½å¯¹æ¯”é¡¹
 */
export interface ComparisonItem {
  /** åŠŸèƒ½åç§° */
  name: string;
  /** åŠŸèƒ½åˆ†ç±» */
  category: FeatureCategory;
  /** åŠŸèƒ½æè¿° */
  description?: string;
  /** å„å±‚çº§çš„å€¼ */
  values: Record<UserTier, string | number | boolean>;
  /** é«˜äº®æ˜¾ç¤ºï¼ˆé‡è¦åŠŸèƒ½ï¼‰ */
  highlight?: boolean;
}

/**
 * åŠŸèƒ½å¯¹æ¯”æ•°æ®
 */
export const FEATURE_COMPARISON: ComparisonItem[] = [
  // åŸºç¡€åŠŸèƒ½
  {
    name: 'å·¥å…·é…ç½®æ•°é‡',
    category: FeatureCategory.BASIC,
    description: 'å¯é…ç½®çš„AIå·¥å…·æ•°é‡',
    values: {
      [UserTier.FREE]: '3ä¸ª',
      [UserTier.PROFESSIONAL]: 'æ— é™',
      [UserTier.TEAM]: 'æ— é™',
      [UserTier.ENTERPRISE]: 'æ— é™',
    },
    highlight: true,
  },
  {
    name: 'äº‘ç«¯æ¨¡æ¿',
    category: FeatureCategory.BASIC,
    description: 'å¯ä¿å­˜çš„äº‘ç«¯æ¨¡æ¿æ•°é‡',
    values: {
      [UserTier.FREE]: '5ä¸ª',
      [UserTier.PROFESSIONAL]: 'æ— é™',
      [UserTier.TEAM]: 'æ— é™',
      [UserTier.ENTERPRISE]: 'æ— é™',
    },
    highlight: true,
  },
  {
    name: 'æ¨¡æ¿åˆ†äº«',
    category: FeatureCategory.BASIC,
    description: 'æ¯æœˆå¯åˆ†äº«çš„æ¨¡æ¿æ¬¡æ•°',
    values: {
      [UserTier.FREE]: '10æ¬¡/æœˆ',
      [UserTier.PROFESSIONAL]: '100æ¬¡/æœˆ',
      [UserTier.TEAM]: '100æ¬¡/æœˆ',
      [UserTier.ENTERPRISE]: 'æ— é™',
    },
  },
  
  // é…é¢é™åˆ¶
  {
    name: 'èƒ½åŠ›éªŒè¯æ¬¡æ•°',
    category: FeatureCategory.QUOTA,
    description: 'æ¯æœˆå¯æ‰§è¡Œçš„èƒ½åŠ›éªŒè¯æ¬¡æ•°',
    values: {
      [UserTier.FREE]: '20æ¬¡/æœˆ',
      [UserTier.PROFESSIONAL]: '500æ¬¡/æœˆ',
      [UserTier.TEAM]: '2000æ¬¡/æœˆ',
      [UserTier.ENTERPRISE]: 'æ— é™',
    },
    highlight: true,
  },
  {
    name: 'å­˜å‚¨ç©ºé—´',
    category: FeatureCategory.QUOTA,
    description: 'äº‘ç«¯å­˜å‚¨ç©ºé—´é…é¢',
    values: {
      [UserTier.FREE]: '100MB',
      [UserTier.PROFESSIONAL]: '10GB',
      [UserTier.TEAM]: '100GB',
      [UserTier.ENTERPRISE]: 'æ— é™',
    },
  },
  {
    name: 'å¹¶å‘ä»»åŠ¡æ•°',
    category: FeatureCategory.QUOTA,
    description: 'å¯åŒæ—¶ç®¡ç†çš„ä»»åŠ¡æ•°é‡',
    values: {
      [UserTier.FREE]: '3ä¸ª',
      [UserTier.PROFESSIONAL]: '20ä¸ª',
      [UserTier.TEAM]: '100ä¸ª',
      [UserTier.ENTERPRISE]: 'æ— é™',
    },
  },
  
  // é«˜çº§åŠŸèƒ½
  {
    name: 'AI å¢å¼ºåŠŸèƒ½',
    category: FeatureCategory.ADVANCED,
    description: 'AIé©±åŠ¨çš„é…ç½®ä¼˜åŒ–å’Œå»ºè®®',
    values: {
      [UserTier.FREE]: false,
      [UserTier.PROFESSIONAL]: true,
      [UserTier.TEAM]: true,
      [UserTier.ENTERPRISE]: true,
    },
  },
  {
    name: 'äº‘ç«¯å¤‡ä»½',
    category: FeatureCategory.ADVANCED,
    description: 'é…ç½®å’Œæ•°æ®çš„äº‘ç«¯å¤‡ä»½',
    values: {
      [UserTier.FREE]: '-',
      [UserTier.PROFESSIONAL]: '7å¤©',
      [UserTier.TEAM]: '30å¤©',
      [UserTier.ENTERPRISE]: 'æ— é™',
    },
  },
  {
    name: 'ç§æœ‰äº‘å­˜å‚¨',
    category: FeatureCategory.ADVANCED,
    description: 'æ”¯æŒç§æœ‰äº‘å­˜å‚¨é…ç½®',
    values: {
      [UserTier.FREE]: false,
      [UserTier.PROFESSIONAL]: true,
      [UserTier.TEAM]: true,
      [UserTier.ENTERPRISE]: true,
    },
  },
  {
    name: 'æ•°æ®å¯¼å‡º',
    category: FeatureCategory.ADVANCED,
    description: 'å¯¼å‡ºæ‰€æœ‰é…ç½®å’Œæ•°æ®',
    values: {
      [UserTier.FREE]: 'åŸºç¡€',
      [UserTier.PROFESSIONAL]: 'é«˜çº§',
      [UserTier.TEAM]: 'é«˜çº§',
      [UserTier.ENTERPRISE]: 'ä¼ä¸šçº§',
    },
  },
  
  // åä½œåŠŸèƒ½
  {
    name: 'å›¢é˜Ÿåä½œ',
    category: FeatureCategory.COLLABORATION,
    description: 'å›¢é˜Ÿæˆå‘˜åä½œåŠŸèƒ½',
    values: {
      [UserTier.FREE]: false,
      [UserTier.PROFESSIONAL]: false,
      [UserTier.TEAM]: true,
      [UserTier.ENTERPRISE]: true,
    },
    highlight: true,
  },
  {
    name: 'å›¢é˜Ÿæˆå‘˜æ•°',
    category: FeatureCategory.COLLABORATION,
    description: 'å¯æ·»åŠ çš„å›¢é˜Ÿæˆå‘˜æ•°é‡',
    values: {
      [UserTier.FREE]: '1äºº',
      [UserTier.PROFESSIONAL]: '1äºº',
      [UserTier.TEAM]: '3-50äºº',
      [UserTier.ENTERPRISE]: '50+äºº',
    },
  },
  {
    name: 'æƒé™ç®¡ç†',
    category: FeatureCategory.COLLABORATION,
    description: 'ç»†ç²’åº¦çš„æƒé™æ§åˆ¶',
    values: {
      [UserTier.FREE]: 'åŸºç¡€',
      [UserTier.PROFESSIONAL]: 'åŸºç¡€',
      [UserTier.TEAM]: 'é«˜çº§',
      [UserTier.ENTERPRISE]: 'RBAC',
    },
  },
  {
    name: 'æ•°æ®å¯è§æ€§',
    category: FeatureCategory.COLLABORATION,
    description: 'æ”¯æŒçš„æ•°æ®å¯è§æ€§çº§åˆ«',
    values: {
      [UserTier.FREE]: 'å…¬å¼€',
      [UserTier.PROFESSIONAL]: 'ç§æœ‰/å…¬å¼€',
      [UserTier.TEAM]: 'å›¢é˜Ÿå†…/éƒ¨é—¨',
      [UserTier.ENTERPRISE]: '5çº§æ§åˆ¶',
    },
  },
  
  // å®‰å…¨ä¸åˆè§„
  {
    name: 'å®¡è®¡æ—¥å¿—',
    category: FeatureCategory.SECURITY,
    description: 'æ“ä½œå®¡è®¡æ—¥å¿—ä¿ç•™',
    values: {
      [UserTier.FREE]: '-',
      [UserTier.PROFESSIONAL]: '-',
      [UserTier.TEAM]: '90å¤©',
      [UserTier.ENTERPRISE]: '365å¤©',
    },
  },
  {
    name: 'SSO å•ç‚¹ç™»å½•',
    category: FeatureCategory.SECURITY,
    description: 'ä¼ä¸šSSOé›†æˆ',
    values: {
      [UserTier.FREE]: false,
      [UserTier.PROFESSIONAL]: false,
      [UserTier.TEAM]: false,
      [UserTier.ENTERPRISE]: true,
    },
  },
  {
    name: 'IP ç™½åå•',
    category: FeatureCategory.SECURITY,
    description: 'IPè®¿é—®æ§åˆ¶',
    values: {
      [UserTier.FREE]: false,
      [UserTier.PROFESSIONAL]: false,
      [UserTier.TEAM]: false,
      [UserTier.ENTERPRISE]: true,
    },
  },
  {
    name: 'æ•°æ®åŠ å¯†',
    category: FeatureCategory.SECURITY,
    description: 'æ•°æ®ä¼ è¾“å’Œå­˜å‚¨åŠ å¯†',
    values: {
      [UserTier.FREE]: 'ä¼ è¾“',
      [UserTier.PROFESSIONAL]: 'ä¼ è¾“+å­˜å‚¨',
      [UserTier.TEAM]: 'ä¼ è¾“+å­˜å‚¨',
      [UserTier.ENTERPRISE]: 'é«˜çº§åŠ å¯†',
    },
  },
  {
    name: 'åˆè§„è®¤è¯',
    category: FeatureCategory.SECURITY,
    description: 'ç¬¦åˆçš„åˆè§„æ ‡å‡†',
    values: {
      [UserTier.FREE]: '-',
      [UserTier.PROFESSIONAL]: '-',
      [UserTier.TEAM]: 'åŸºç¡€',
      [UserTier.ENTERPRISE]: 'SOC2/ISO',
    },
  },
  
  // æ”¯æŒæœåŠ¡
  {
    name: 'SLA ä¿éšœ',
    category: FeatureCategory.SUPPORT,
    description: 'æœåŠ¡å¯ç”¨æ€§ä¿è¯',
    values: {
      [UserTier.FREE]: '-',
      [UserTier.PROFESSIONAL]: '-',
      [UserTier.TEAM]: '-',
      [UserTier.ENTERPRISE]: '99.9%',
    },
  },
  {
    name: 'æŠ€æœ¯æ”¯æŒ',
    category: FeatureCategory.SUPPORT,
    description: 'æŠ€æœ¯æ”¯æŒå“åº”çº§åˆ«',
    values: {
      [UserTier.FREE]: 'ç¤¾åŒº',
      [UserTier.PROFESSIONAL]: 'é‚®ä»¶',
      [UserTier.TEAM]: 'ä¼˜å…ˆæ”¯æŒ',
      [UserTier.ENTERPRISE]: 'ä¸“å±æ”¯æŒ',
    },
  },
  {
    name: 'å“åº”æ—¶é—´',
    category: FeatureCategory.SUPPORT,
    description: 'æŠ€æœ¯æ”¯æŒå“åº”æ—¶é—´',
    values: {
      [UserTier.FREE]: '3-5å¤©',
      [UserTier.PROFESSIONAL]: '1-2å¤©',
      [UserTier.TEAM]: '4-8å°æ—¶',
      [UserTier.ENTERPRISE]: '1å°æ—¶',
    },
  },
  {
    name: 'åŸ¹è®­æœåŠ¡',
    category: FeatureCategory.SUPPORT,
    description: 'å›¢é˜ŸåŸ¹è®­å’Œå’¨è¯¢',
    values: {
      [UserTier.FREE]: false,
      [UserTier.PROFESSIONAL]: 'æ–‡æ¡£',
      [UserTier.TEAM]: 'è§†é¢‘æ•™ç¨‹',
      [UserTier.ENTERPRISE]: 'ç°åœºåŸ¹è®­',
    },
  },
];

/**
 * åŠŸèƒ½å¯¹æ¯”CLIå±•ç¤º
 */
export class FeatureComparisonUI {
  private featureManager: FeatureManager;

  constructor() {
    this.featureManager = new FeatureManager();
  }

  /**
   * æ˜¾ç¤ºå®Œæ•´åŠŸèƒ½å¯¹æ¯”è¡¨
   */
  displayFullComparison(): void {
    console.log(chalk.bold('\nğŸ“Š meteor-shower åŠŸèƒ½å¯¹æ¯”è¡¨\n'));
    console.log(chalk.gray('â”€'.repeat(100)));

    // æŒ‰åˆ†ç±»æ˜¾ç¤º
    const categories = Object.values(FeatureCategory);
    
    for (const category of categories) {
      this.displayCategory(category);
    }
  }

  /**
   * æ˜¾ç¤ºç‰¹å®šåˆ†ç±»çš„åŠŸèƒ½å¯¹æ¯”
   */
  displayCategory(category: FeatureCategory): void {
    const categoryNames = {
      [FeatureCategory.BASIC]: 'ğŸ“¦ åŸºç¡€åŠŸèƒ½',
      [FeatureCategory.QUOTA]: 'ğŸ“Š é…é¢é™åˆ¶',
      [FeatureCategory.ADVANCED]: 'âš¡ é«˜çº§åŠŸèƒ½',
      [FeatureCategory.COLLABORATION]: 'ğŸ‘¥ åä½œåŠŸèƒ½',
      [FeatureCategory.SECURITY]: 'ğŸ”’ å®‰å…¨ä¸åˆè§„',
      [FeatureCategory.SUPPORT]: 'ğŸ†˜ æ”¯æŒæœåŠ¡',
    };

    const items = FEATURE_COMPARISON.filter(item => item.category === category);
    
    if (items.length === 0) return;

    console.log(chalk.cyan(`\n${categoryNames[category]}`));
    console.log(chalk.gray('â”€'.repeat(100)));

    // è¡¨å¤´
    console.log(
      this.formatRow(
        'åŠŸèƒ½',
        'å…è´¹ç‰ˆ',
        'ä¸“ä¸šç‰ˆ',
        'å›¢é˜Ÿç‰ˆ',
        'ä¼ä¸šç‰ˆ'
      )
    );
    console.log(chalk.gray('â”€'.repeat(100)));

    // åŠŸèƒ½è¡Œ
    items.forEach(item => {
      const row = this.formatRow(
        item.name,
        this.formatValue(item.values[UserTier.FREE]),
        this.formatValue(item.values[UserTier.PROFESSIONAL]),
        this.formatValue(item.values[UserTier.TEAM]),
        this.formatValue(item.values[UserTier.ENTERPRISE])
      );

      if (item.highlight) {
        console.log(chalk.yellow(row));
      } else {
        console.log(row);
      }
    });

    console.log();
  }

  /**
   * æ˜¾ç¤ºä¸¤ä¸ªå±‚çº§çš„å¯¹æ¯”
   */
  displayTierComparison(tier1: UserTier, tier2: UserTier): void {
    const tierNames = {
      [UserTier.FREE]: 'å…è´¹ç‰ˆ',
      [UserTier.PROFESSIONAL]: 'ä¸“ä¸šç‰ˆ',
      [UserTier.TEAM]: 'å›¢é˜Ÿç‰ˆ',
      [UserTier.ENTERPRISE]: 'ä¼ä¸šç‰ˆ',
    };

    console.log(chalk.bold(`\nğŸ“Š ${tierNames[tier1]} vs ${tierNames[tier2]}\n`));
    console.log(chalk.gray('â”€'.repeat(80)));

    // è¡¨å¤´
    console.log(this.formatComparisonRow('åŠŸèƒ½', tierNames[tier1], tierNames[tier2], 'å·®å¼‚'));
    console.log(chalk.gray('â”€'.repeat(80)));

    // æ˜¾ç¤ºæœ‰å·®å¼‚çš„åŠŸèƒ½
    FEATURE_COMPARISON.forEach(item => {
      const value1 = item.values[tier1];
      const value2 = item.values[tier2];

      if (value1 !== value2) {
        const diff = this.calculateDifference(value1, value2);
        console.log(
          this.formatComparisonRow(
            item.name,
            this.formatValue(value1),
            this.formatValue(value2),
            diff
          )
        );
      }
    });

    console.log();
  }

  /**
   * æ˜¾ç¤ºå‡çº§å»ºè®®
   */
  displayUpgradeRecommendation(currentTier: UserTier, targetTier: UserTier): void {
    console.log(chalk.bold(`\nğŸ’¡ å‡çº§åˆ°${this.getTierName(targetTier)}åï¼Œæ‚¨å°†è·å¾—:\n`));

    const improvements: string[] = [];

    FEATURE_COMPARISON.forEach(item => {
      const currentValue = item.values[currentTier];
      const targetValue = item.values[targetTier];

      if (this.isImprovement(currentValue, targetValue)) {
        improvements.push(
          `âœ“ ${item.name}: ${this.formatValue(currentValue)} â†’ ${chalk.green(this.formatValue(targetValue))}`
        );
      }
    });

    improvements.forEach(improvement => console.log(improvement));
    console.log();
  }

  /**
   * æ ¼å¼åŒ–è¡¨æ ¼è¡Œ
   */
  private formatRow(...columns: string[]): string {
    const widths = [30, 15, 15, 15, 15];
    return columns
      .map((col, i) => col.padEnd(widths[i]))
      .join(' ');
  }

  /**
   * æ ¼å¼åŒ–å¯¹æ¯”è¡Œ
   */
  private formatComparisonRow(...columns: string[]): string {
    const widths = [30, 20, 20, 20];
    return columns
      .map((col, i) => col.padEnd(widths[i]))
      .join(' ');
  }

  /**
   * æ ¼å¼åŒ–å€¼æ˜¾ç¤º
   */
  private formatValue(value: string | number | boolean): string {
    if (typeof value === 'boolean') {
      return value ? chalk.green('âœ“') : chalk.gray('-');
    }
    if (value === 'æ— é™' || value === 'Infinity') {
      return chalk.green('æ— é™');
    }
    if (value === '-' || value === false) {
      return chalk.gray('-');
    }
    return String(value);
  }

  /**
   * è®¡ç®—å·®å¼‚
   */
  private calculateDifference(value1: any, value2: any): string {
    if (typeof value1 === 'boolean' && typeof value2 === 'boolean') {
      return value2 ? chalk.green('æ–°å¢') : chalk.red('ç§»é™¤');
    }
    if (value1 === '-' && value2 !== '-') {
      return chalk.green('æ–°å¢');
    }
    if (value1 !== '-' && value2 === '-') {
      return chalk.red('ç§»é™¤');
    }
    return chalk.yellow('å‡çº§');
  }

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºæ”¹è¿›
   */
  private isImprovement(currentValue: any, targetValue: any): boolean {
    if (typeof currentValue === 'boolean' && typeof targetValue === 'boolean') {
      return !currentValue && targetValue;
    }
    if (currentValue === '-' || currentValue === false) {
      return targetValue !== '-' && targetValue !== false;
    }
    return currentValue !== targetValue;
  }

  /**
   * è·å–å±‚çº§åç§°
   */
  private getTierName(tier: UserTier): string {
    const names = {
      [UserTier.FREE]: 'å…è´¹ç‰ˆ',
      [UserTier.PROFESSIONAL]: 'ä¸“ä¸šç‰ˆ',
      [UserTier.TEAM]: 'å›¢é˜Ÿç‰ˆ',
      [UserTier.ENTERPRISE]: 'ä¼ä¸šç‰ˆ',
    };
    return names[tier];
  }
}
