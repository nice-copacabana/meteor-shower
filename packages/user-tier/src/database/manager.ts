// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-15
// Task: å®ç°æ•°æ®åº“ç®¡ç†å™¨ï¼Œæä¾›æ•°æ®åº“åˆå§‹åŒ–ã€è¿ç§»å’Œè¿æ¥ç®¡ç†åŠŸèƒ½

/**
 * æ•°æ®åº“ç®¡ç†å™¨
 * 
 * è´Ÿè´£æ•°æ®åº“çš„åˆå§‹åŒ–ã€è¿ç§»ã€è¿æ¥ç®¡ç†
 */

import Database from 'better-sqlite3';
import * as path from 'path';
import * as fs from 'fs';
import { initializeDatabase, MIGRATIONS } from './schema.js';
import { UserDAO, SubscriptionDAO, UsageStatsDAO, OrganizationDAO } from './dao.js';
import { AuditLogManager, AUDIT_LOG_SCHEMA } from '../permissions/audit-manager.js';

/**
 * æ•°æ®åº“ç®¡ç†å™¨é…ç½®
 */
export interface DatabaseConfig {
  /** æ•°æ®åº“æ–‡ä»¶è·¯å¾„ */
  path: string;
  /** æ˜¯å¦ä¸ºåªè¯»æ¨¡å¼ */
  readonly?: boolean;
  /** æ˜¯å¦å¯ç”¨WALæ¨¡å¼ */
  wal?: boolean;
  /** æ˜¯å¦åœ¨å†…å­˜ä¸­è¿è¡Œ */
  memory?: boolean;
}

/**
 * è¿ç§»è®°å½•
 */
interface MigrationRecord {
  version: number;
  name: string;
  applied_at: number;
}

/**
 * æ•°æ®åº“ç®¡ç†å™¨
 */
export class DatabaseManager {
  private db: Database.Database | null = null;
  private config: DatabaseConfig;

  // DAOå®ä¾‹
  public users!: UserDAO;
  public subscriptions!: SubscriptionDAO;
  public usageStats!: UsageStatsDAO;
  public organizations!: OrganizationDAO;
  public auditLogs!: AuditLogManager;

  constructor(config: DatabaseConfig) {
    this.config = config;
  }

  /**
   * è¿æ¥æ•°æ®åº“
   */
  connect(): void {
    if (this.db) {
      console.warn('âš ï¸  æ•°æ®åº“å·²è¿æ¥');
      return;
    }

    // å¦‚æœä¸æ˜¯å†…å­˜æ•°æ®åº“ï¼Œç¡®ä¿ç›®å½•å­˜åœ¨
    if (!this.config.memory) {
      const dir = path.dirname(this.config.path);
      if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
      }
    }

    // åˆ›å»ºæ•°æ®åº“è¿æ¥
    this.db = new Database(
      this.config.memory ? ':memory:' : this.config.path,
      {
        readonly: this.config.readonly || false,
        fileMustExist: false,
      }
    );

    // å¯ç”¨WALæ¨¡å¼ï¼ˆæé«˜å¹¶å‘æ€§èƒ½ï¼‰
    if (this.config.wal && !this.config.memory) {
      this.db.pragma('journal_mode = WAL');
    }

    // åˆå§‹åŒ–DAO
    this.users = new UserDAO(this.db);
    this.subscriptions = new SubscriptionDAO(this.db);
    this.usageStats = new UsageStatsDAO(this.db);
    this.organizations = new OrganizationDAO(this.db);
    this.auditLogs = new AuditLogManager(this.db);

    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
  }

  /**
   * åˆå§‹åŒ–æ•°æ®åº“ï¼ˆåˆ›å»ºè¡¨ï¼‰
   */
  initialize(): void {
    if (!this.db) {
      throw new Error('æ•°æ®åº“æœªè¿æ¥');
    }

    // åˆ›å»ºè¿ç§»è®°å½•è¡¨
    this.db.exec(`
      CREATE TABLE IF NOT EXISTS migrations (
        version INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        applied_at INTEGER NOT NULL
      )
    `);

    // åˆå§‹åŒ–æ•°æ®åº“ç»“æ„
    initializeDatabase(this.db);
    
    // åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
    this.db.exec(AUDIT_LOG_SCHEMA);

    console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
  }

  /**
   * æ‰§è¡Œæ•°æ®åº“è¿ç§»
   */
  migrate(): void {
    if (!this.db) {
      throw new Error('æ•°æ®åº“æœªè¿æ¥');
    }

    // è·å–å·²åº”ç”¨çš„è¿ç§»
    const appliedMigrations = this.db
      .prepare('SELECT * FROM migrations ORDER BY version')
      .all() as MigrationRecord[];

    const appliedVersions = new Set(appliedMigrations.map(m => m.version));

    // æ‰§è¡Œæœªåº”ç”¨çš„è¿ç§»
    for (const migration of MIGRATIONS) {
      if (!appliedVersions.has(migration.version)) {
        console.log(`ğŸ“¦ åº”ç”¨è¿ç§»: ${migration.name} (v${migration.version})`);
        
        // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè¿ç§»
        const transaction = this.db.transaction(() => {
          migration.up(this.db!);
          
          // è®°å½•è¿ç§»
          this.db!.prepare(`
            INSERT INTO migrations (version, name, applied_at)
            VALUES (?, ?, ?)
          `).run(migration.version, migration.name, Date.now());
        });

        transaction();
        
        console.log(`âœ… è¿ç§»å®Œæˆ: ${migration.name}`);
      }
    }

    console.log('âœ… æ‰€æœ‰è¿ç§»å·²åº”ç”¨');
  }

  /**
   * å›æ»šè¿ç§»
   */
  rollback(targetVersion: number): void {
    if (!this.db) {
      throw new Error('æ•°æ®åº“æœªè¿æ¥');
    }

    const appliedMigrations = this.db
      .prepare('SELECT * FROM migrations ORDER BY version DESC')
      .all() as MigrationRecord[];

    for (const record of appliedMigrations) {
      if (record.version <= targetVersion) {
        break;
      }

      const migration = MIGRATIONS.find(m => m.version === record.version);
      if (!migration) {
        console.warn(`âš ï¸  æœªæ‰¾åˆ°è¿ç§»å®šä¹‰: v${record.version}`);
        continue;
      }

      console.log(`ğŸ”„ å›æ»šè¿ç§»: ${migration.name} (v${migration.version})`);

      const transaction = this.db.transaction(() => {
        migration.down(this.db!);
        
        this.db!.prepare('DELETE FROM migrations WHERE version = ?')
          .run(migration.version);
      });

      transaction();

      console.log(`âœ… å›æ»šå®Œæˆ: ${migration.name}`);
    }
  }

  /**
   * è·å–æ•°æ®åº“å®ä¾‹ï¼ˆç”¨äºé«˜çº§æ“ä½œï¼‰
   */
  getDatabase(): Database.Database {
    if (!this.db) {
      throw new Error('æ•°æ®åº“æœªè¿æ¥');
    }
    return this.db;
  }

  /**
   * æ‰§è¡ŒåŸå§‹SQLæŸ¥è¯¢
   */
  query<T = any>(sql: string, params?: any[]): T[] {
    if (!this.db) {
      throw new Error('æ•°æ®åº“æœªè¿æ¥');
    }

    const stmt = this.db.prepare(sql);
    return params ? stmt.all(...params) as T[] : stmt.all() as T[];
  }

  /**
   * åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ
   */
  transaction<T>(fn: () => T): T {
    if (!this.db) {
      throw new Error('æ•°æ®åº“æœªè¿æ¥');
    }

    const transaction = this.db.transaction(fn);
    return transaction();
  }

  /**
   * å…³é—­æ•°æ®åº“è¿æ¥
   */
  close(): void {
    if (this.db) {
      this.db.close();
      this.db = null;
      console.log('âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­');
    }
  }

  /**
   * å¤‡ä»½æ•°æ®åº“
   */
  backup(destPath: string): void {
    if (!this.db || this.config.memory) {
      throw new Error('æ— æ³•å¤‡ä»½å†…å­˜æ•°æ®åº“');
    }

    const destDir = path.dirname(destPath);
    if (!fs.existsSync(destDir)) {
      fs.mkdirSync(destDir, { recursive: true });
    }

    this.db.backup(destPath);
    console.log(`âœ… æ•°æ®åº“å·²å¤‡ä»½åˆ°: ${destPath}`);
  }

  /**
   * è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
   */
  getStats(): {
    users: number;
    organizations: number;
    subscriptions: number;
    usageRecords: number;
  } {
    if (!this.db) {
      throw new Error('æ•°æ®åº“æœªè¿æ¥');
    }

    const getUserCount = this.db.prepare('SELECT COUNT(*) as count FROM users');
    const getOrgCount = this.db.prepare('SELECT COUNT(*) as count FROM organizations');
    const getSubCount = this.db.prepare('SELECT COUNT(*) as count FROM subscriptions');
    const getUsageCount = this.db.prepare('SELECT COUNT(*) as count FROM usage_stats');

    return {
      users: (getUserCount.get() as any).count,
      organizations: (getOrgCount.get() as any).count,
      subscriptions: (getSubCount.get() as any).count,
      usageRecords: (getUsageCount.get() as any).count,
    };
  }
}

/**
 * åˆ›å»ºæ•°æ®åº“ç®¡ç†å™¨å®ä¾‹
 */
export function createDatabaseManager(config: DatabaseConfig): DatabaseManager {
  const manager = new DatabaseManager(config);
  manager.connect();
  manager.initialize();
  return manager;
}
