// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-15
// Task: M6 Phase4 - é€€æ¬¾ç”¨æˆ·ç•Œé¢å’Œäº¤äº’é€»è¾‘

import chalk from 'chalk';
import {
  RefundManager,
  RefundRequest,
  RefundRecord,
  RefundReason,
  RefundStatus,
  RefundType,
} from './refund-manager.js';
import { PaymentManager } from './payment-manager.js';

/**
 * é€€æ¬¾UIé€‰é¡¹
 */
export interface RefundUIOptions {
  /** æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ */
  verbose?: boolean;
  /** æ˜¯å¦ä½¿ç”¨é¢œè‰² */
  colored?: boolean;
}

/**
 * é€€æ¬¾ç”¨æˆ·ç•Œé¢
 */
export class RefundUI {
  constructor(
    private refundManager: RefundManager,
    private paymentManager: PaymentManager
  ) {}

  /**
   * æ˜¾ç¤ºé€€æ¬¾ç”³è¯·è¡¨å•
   */
  async displayRefundForm(orderId: string, userId: string): Promise<void> {
    console.log(chalk.bold('\nğŸ“ é€€æ¬¾ç”³è¯·è¡¨å•'));
    console.log(chalk.gray('â”€'.repeat(50)));

    // æ£€æŸ¥é€€æ¬¾èµ„æ ¼
    const eligibility = await this.refundManager.checkRefundEligibility(orderId);
    
    if (!eligibility.eligible) {
      console.log(chalk.red(`âŒ ä¸ç¬¦åˆé€€æ¬¾æ¡ä»¶: ${eligibility.reason}`));
      return;
    }

    // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
    const order = await this.paymentManager.queryPayment(orderId);
    if (order) {
      console.log(chalk.cyan('\nè®¢å•ä¿¡æ¯:'));
      console.log(`  è®¢å•å·: ${order.id}`);
      console.log(`  é‡‘é¢: Â¥${(order.amount / 100).toFixed(2)}`);
      console.log(`  æ”¯ä»˜æ—¶é—´: ${order.paidAt?.toLocaleString('zh-CN')}`);
    }

    console.log(chalk.green(`\nâœ… å¯ç”³è¯·é€€æ¬¾ï¼Œå‰©ä½™ ${eligibility.daysRemaining} å¤©`));
    console.log(chalk.gray('\nè¯·é€‰æ‹©é€€æ¬¾åŸå› :'));
    console.log('  1. ç”¨æˆ·ä¸»åŠ¨é€€æ¬¾');
    console.log('  2. æœåŠ¡é—®é¢˜');
    console.log('  3. é‡å¤æ”¯ä»˜');
    console.log('  4. è®¢å•å–æ¶ˆ');
    console.log('  5. å…¶ä»–åŸå› ');
  }

  /**
   * æ˜¾ç¤ºé€€æ¬¾è®°å½•è¯¦æƒ…
   */
  async displayRefundDetails(
    refundId: string,
    options: RefundUIOptions = {}
  ): Promise<void> {
    const refund = await this.refundManager.getRefundById(refundId);
    if (!refund) {
      console.log(chalk.red('âŒ é€€æ¬¾è®°å½•ä¸å­˜åœ¨'));
      return;
    }

    const colored = options.colored ?? true;
    
    console.log(chalk.bold('\nğŸ’° é€€æ¬¾è¯¦æƒ…'));
    console.log(chalk.gray('â”€'.repeat(60)));

    // åŸºæœ¬ä¿¡æ¯
    console.log(chalk.cyan('\nåŸºæœ¬ä¿¡æ¯:'));
    console.log(`  é€€æ¬¾ID: ${refund.id}`);
    console.log(`  è®¢å•ID: ${refund.orderId}`);
    console.log(`  ç”¨æˆ·ID: ${refund.userId}`);

    // é‡‘é¢ä¿¡æ¯
    console.log(chalk.cyan('\né‡‘é¢ä¿¡æ¯:'));
    console.log(`  é€€æ¬¾ç±»å‹: ${this.getRefundTypeLabel(refund.type)}`);
    console.log(`  é€€æ¬¾é‡‘é¢: ${colored ? chalk.yellow(`Â¥${(refund.amount / 100).toFixed(2)}`) : `Â¥${(refund.amount / 100).toFixed(2)}`}`);
    console.log(`  åŸè®¢å•é‡‘é¢: Â¥${(refund.originalAmount / 100).toFixed(2)}`);

    // çŠ¶æ€ä¿¡æ¯
    console.log(chalk.cyan('\nçŠ¶æ€ä¿¡æ¯:'));
    console.log(`  é€€æ¬¾çŠ¶æ€: ${this.formatRefundStatus(refund.status, colored)}`);
    console.log(`  ç”³è¯·æ—¶é—´: ${refund.requestedAt.toLocaleString('zh-CN')}`);
    
    if (refund.processedAt) {
      console.log(`  å¤„ç†æ—¶é—´: ${refund.processedAt.toLocaleString('zh-CN')}`);
    }
    
    if (refund.completedAt) {
      console.log(`  å®Œæˆæ—¶é—´: ${refund.completedAt.toLocaleString('zh-CN')}`);
    }

    // é€€æ¬¾åŸå› 
    console.log(chalk.cyan('\né€€æ¬¾åŸå› :'));
    console.log(`  åŸå› : ${this.getRefundReasonLabel(refund.reason)}`);
    
    if (refund.description) {
      console.log(`  è¯´æ˜: ${refund.description}`);
    }

    // å®¡æ‰¹ä¿¡æ¯
    if (refund.approvedBy) {
      console.log(chalk.cyan('\nå®¡æ‰¹ä¿¡æ¯:'));
      console.log(`  å®¡æ‰¹äºº: ${refund.approvedBy}`);
      
      if (refund.rejectionReason) {
        console.log(`  ${colored ? chalk.red('æ‹’ç»åŸå› ') : 'æ‹’ç»åŸå› '}: ${refund.rejectionReason}`);
      }
    }

    // äº¤æ˜“ä¿¡æ¯
    if (refund.refundTransactionId) {
      console.log(chalk.cyan('\näº¤æ˜“ä¿¡æ¯:'));
      console.log(`  é€€æ¬¾äº¤æ˜“å·: ${refund.refundTransactionId}`);
    }

    console.log();
  }

  /**
   * æ˜¾ç¤ºç”¨æˆ·é€€æ¬¾åˆ—è¡¨
   */
  async displayUserRefunds(
    userId: string,
    options: RefundUIOptions = {}
  ): Promise<void> {
    const refunds = await this.refundManager.getUserRefunds(userId);
    
    console.log(chalk.bold('\nğŸ“‹ æˆ‘çš„é€€æ¬¾è®°å½•'));
    console.log(chalk.gray('â”€'.repeat(80)));

    if (refunds.length === 0) {
      console.log(chalk.yellow('\næš‚æ— é€€æ¬¾è®°å½•'));
      return;
    }

    const colored = options.colored ?? true;

    console.log();
    for (const refund of refunds) {
      const statusBadge = this.formatRefundStatus(refund.status, colored);
      const amount = colored 
        ? chalk.yellow(`Â¥${(refund.amount / 100).toFixed(2)}`)
        : `Â¥${(refund.amount / 100).toFixed(2)}`;
      
      console.log(`${statusBadge} ${amount} - ${refund.id}`);
      console.log(chalk.gray(`    è®¢å•: ${refund.orderId} | ç”³è¯·æ—¶é—´: ${refund.requestedAt.toLocaleDateString('zh-CN')}`));
      
      if (options.verbose && refund.description) {
        console.log(chalk.gray(`    è¯´æ˜: ${refund.description}`));
      }
      
      console.log();
    }
  }

  /**
   * æ˜¾ç¤ºå¾…å®¡æ‰¹é€€æ¬¾åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
   */
  async displayPendingRefunds(options: RefundUIOptions = {}): Promise<void> {
    const refunds = await this.refundManager.getPendingRefunds();
    
    console.log(chalk.bold('\nâ³ å¾…å®¡æ‰¹é€€æ¬¾åˆ—è¡¨'));
    console.log(chalk.gray('â”€'.repeat(80)));

    if (refunds.length === 0) {
      console.log(chalk.green('\nâœ… æš‚æ— å¾…å®¡æ‰¹é€€æ¬¾'));
      return;
    }

    const colored = options.colored ?? true;

    console.log(chalk.yellow(`\nå…± ${refunds.length} æ¡å¾…å¤„ç†é€€æ¬¾:\n`));

    for (const refund of refunds) {
      const amount = colored 
        ? chalk.yellow(`Â¥${(refund.amount / 100).toFixed(2)}`)
        : `Â¥${(refund.amount / 100).toFixed(2)}`;
      
      console.log(`${amount} - ${refund.id}`);
      console.log(chalk.gray(`    ç”¨æˆ·: ${refund.userId} | è®¢å•: ${refund.orderId}`));
      console.log(chalk.gray(`    åŸå› : ${this.getRefundReasonLabel(refund.reason)}`));
      
      if (refund.description) {
        console.log(chalk.gray(`    è¯´æ˜: ${refund.description}`));
      }
      
      const daysAgo = Math.floor(
        (Date.now() - refund.requestedAt.getTime()) / (24 * 60 * 60 * 1000)
      );
      console.log(chalk.gray(`    ç”³è¯·æ—¶é—´: ${refund.requestedAt.toLocaleString('zh-CN')} (${daysAgo}å¤©å‰)`));
      console.log();
    }
  }

  /**
   * æ˜¾ç¤ºé€€æ¬¾ç»Ÿè®¡
   */
  async displayRefundStatistics(
    userId?: string,
    options: RefundUIOptions = {}
  ): Promise<void> {
    const stats = await this.refundManager.getRefundStatistics(userId);
    
    const title = userId ? 'ğŸ“Š é€€æ¬¾ç»Ÿè®¡ï¼ˆä¸ªäººï¼‰' : 'ğŸ“Š é€€æ¬¾ç»Ÿè®¡ï¼ˆå…¨å±€ï¼‰';
    console.log(chalk.bold(`\n${title}`));
    console.log(chalk.gray('â”€'.repeat(60)));

    const colored = options.colored ?? true;

    // æ€»ä½“ç»Ÿè®¡
    console.log(chalk.cyan('\næ€»ä½“ç»Ÿè®¡:'));
    console.log(`  æ€»é€€æ¬¾æ¬¡æ•°: ${stats.totalRefunds}`);
    console.log(`  æˆåŠŸé€€æ¬¾: ${colored ? chalk.green(stats.successfulRefunds.toString()) : stats.successfulRefunds}`);
    console.log(`  å¤±è´¥é€€æ¬¾: ${colored ? chalk.red(stats.failedRefunds.toString()) : stats.failedRefunds}`);
    console.log(`  æˆåŠŸç‡: ${stats.totalRefunds > 0 ? ((stats.successfulRefunds / stats.totalRefunds) * 100).toFixed(1) : 0}%`);
    console.log(`  æ€»é€€æ¬¾é‡‘é¢: ${colored ? chalk.yellow(`Â¥${(stats.totalAmount / 100).toFixed(2)}`) : `Â¥${(stats.totalAmount / 100).toFixed(2)}`}`);

    // æŒ‰åŸå› åˆ†ç±»
    if (Object.keys(stats.byReason).length > 0) {
      console.log(chalk.cyan('\næŒ‰åŸå› åˆ†ç±»:'));
      for (const [reason, count] of Object.entries(stats.byReason)) {
        console.log(`  ${this.getRefundReasonLabel(reason as RefundReason)}: ${count}`);
      }
    }

    // æŒ‰æ”¯ä»˜æ–¹å¼åˆ†ç±»
    if (Object.keys(stats.byProvider).length > 0) {
      console.log(chalk.cyan('\næŒ‰æ”¯ä»˜æ–¹å¼åˆ†ç±»:'));
      for (const [provider, count] of Object.entries(stats.byProvider)) {
        console.log(`  ${provider}: ${count}`);
      }
    }

    console.log();
  }

  /**
   * æ ¼å¼åŒ–é€€æ¬¾çŠ¶æ€
   */
  private formatRefundStatus(status: RefundStatus, colored: boolean = true): string {
    if (!colored) {
      return `[${status}]`;
    }

    switch (status) {
      case RefundStatus.PENDING:
        return chalk.yellow('â³ å¾…å®¡æ‰¹');
      case RefundStatus.PROCESSING:
        return chalk.blue('âš™ï¸  å¤„ç†ä¸­');
      case RefundStatus.SUCCESS:
        return chalk.green('âœ… å·²å®Œæˆ');
      case RefundStatus.FAILED:
        return chalk.red('âŒ å¤±è´¥');
      case RefundStatus.REJECTED:
        return chalk.red('ğŸš« å·²æ‹’ç»');
      default:
        return chalk.gray(`[${status}]`);
    }
  }

  /**
   * è·å–é€€æ¬¾ç±»å‹æ ‡ç­¾
   */
  private getRefundTypeLabel(type: RefundType): string {
    switch (type) {
      case RefundType.FULL:
        return 'å…¨é¢é€€æ¬¾';
      case RefundType.PARTIAL:
        return 'éƒ¨åˆ†é€€æ¬¾';
      default:
        return type;
    }
  }

  /**
   * è·å–é€€æ¬¾åŸå› æ ‡ç­¾
   */
  private getRefundReasonLabel(reason: RefundReason): string {
    switch (reason) {
      case RefundReason.USER_REQUEST:
        return 'ç”¨æˆ·ä¸»åŠ¨é€€æ¬¾';
      case RefundReason.SERVICE_ISSUE:
        return 'æœåŠ¡é—®é¢˜';
      case RefundReason.DUPLICATE_PAYMENT:
        return 'é‡å¤æ”¯ä»˜';
      case RefundReason.ORDER_CANCELLED:
        return 'è®¢å•å–æ¶ˆ';
      case RefundReason.FRAUD_DETECTED:
        return 'æ¬ºè¯ˆæ£€æµ‹';
      case RefundReason.OTHER:
        return 'å…¶ä»–åŸå› ';
      default:
        return reason;
    }
  }

  /**
   * æ˜¾ç¤ºé€€æ¬¾æˆåŠŸæç¤º
   */
  displayRefundSuccess(refund: RefundRecord): void {
    console.log(chalk.green('\nâœ… é€€æ¬¾ç”³è¯·å·²æäº¤'));
    console.log(chalk.gray('â”€'.repeat(50)));
    console.log(`é€€æ¬¾ID: ${refund.id}`);
    console.log(`é€€æ¬¾é‡‘é¢: ${chalk.yellow(`Â¥${(refund.amount / 100).toFixed(2)}`)}`);
    
    if (refund.status === RefundStatus.PENDING) {
      console.log(chalk.yellow('\nâ³ é€€æ¬¾ç”³è¯·å¾…å®¡æ‰¹ï¼Œè¯·è€å¿ƒç­‰å¾…...'));
      console.log(chalk.gray('é€šå¸¸ä¼šåœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å¤„ç†'));
    } else if (refund.status === RefundStatus.SUCCESS) {
      console.log(chalk.green('\nâœ… é€€æ¬¾å·²è‡ªåŠ¨æ‰¹å‡†å¹¶å¤„ç†'));
      console.log(chalk.gray('é€€æ¬¾å°†åœ¨3-5ä¸ªå·¥ä½œæ—¥å†…åˆ°è´¦'));
    }
    
    console.log();
  }

  /**
   * æ˜¾ç¤ºé€€æ¬¾å¤±è´¥æç¤º
   */
  displayRefundError(error: Error): void {
    console.log(chalk.red('\nâŒ é€€æ¬¾ç”³è¯·å¤±è´¥'));
    console.log(chalk.gray('â”€'.repeat(50)));
    console.log(chalk.red(`é”™è¯¯: ${error.message}`));
    console.log(chalk.gray('\nå¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å®¢æœ'));
    console.log();
  }
}
