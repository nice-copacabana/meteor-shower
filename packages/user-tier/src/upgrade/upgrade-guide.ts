// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-15
// Task: M6 Phase3 - å‡çº§å¼•å¯¼æµç¨‹

import chalk from 'chalk';
import { UserTier } from '../types.js';
import { FeatureManager, Feature } from '../features/feature-flags.js';
import { QuotaManager, QuotaType } from '../quota/quota-manager.js';

/**
 * å‡çº§åŸå› 
 */
export enum UpgradeReason {
  /** é…é¢ä¸è¶³ */
  QUOTA_LIMIT = 'quota_limit',
  
  /** åŠŸèƒ½é™åˆ¶ */
  FEATURE_LIMIT = 'feature_limit',
  
  /** ä¸»åŠ¨å‡çº§ */
  PROACTIVE = 'proactive',
}

/**
 * å‡çº§å»ºè®®
 */
export interface UpgradeSuggestion {
  /** å½“å‰å±‚çº§ */
  currentTier: UserTier;
  
  /** å»ºè®®å‡çº§åˆ°çš„å±‚çº§ */
  suggestedTier: UserTier;
  
  /** å‡çº§åŸå›  */
  reason: UpgradeReason;
  
  /** è¯¦ç»†åŸå› æè¿° */
  details: string;
  
  /** å‡çº§åçš„å¥½å¤„ */
  benefits: string[];
  
  /** å®šä»·ä¿¡æ¯ */
  pricing?: {
    monthly: number;
    yearly: number;
    savings?: number;
  };
}

/**
 * å‡çº§å¼•å¯¼ç®¡ç†å™¨
 */
export class UpgradeGuide {
  constructor(
    private featureManager: FeatureManager,
    private quotaManager: QuotaManager
  ) {}

  /**
   * è·å–å‡çº§å»ºè®®
   */
  async getUpgradeSuggestion(
    userId: string,
    tier: UserTier,
    reason?: UpgradeReason,
    context?: { quotaType?: QuotaType; feature?: Feature }
  ): Promise<UpgradeSuggestion | null> {
    // å¦‚æœå·²æ˜¯ä¼ä¸šç‰ˆï¼Œæ— éœ€å‡çº§
    if (tier === UserTier.ENTERPRISE) {
      return null;
    }

    let suggestedTier: UserTier;
    let details: string;
    let benefits: string[] = [];

    if (reason === UpgradeReason.QUOTA_LIMIT && context?.quotaType) {
      // é…é¢é™åˆ¶å¯¼è‡´çš„å‡çº§å»ºè®®
      const quota = await this.quotaManager.checkQuota(userId, context.quotaType);
      details = `${this.getQuotaName(context.quotaType)}å·²è¾¾ä¸Šé™ (${quota.limit})`;
      
      // æ ¹æ®å½“å‰å±‚çº§æ¨èä¸‹ä¸€çº§
      suggestedTier = this.getNextTier(tier);
      benefits = this.getQuotaBenefits(tier, suggestedTier, context.quotaType);
      
    } else if (reason === UpgradeReason.FEATURE_LIMIT && context?.feature) {
      // åŠŸèƒ½é™åˆ¶å¯¼è‡´çš„å‡çº§å»ºè®®
      const featureCheck = this.featureManager.checkFeature(tier, context.feature);
      details = `å½“å‰å±‚çº§ä¸æ”¯æŒåŠŸèƒ½: ${this.featureManager.getFeatureDescription(context.feature)}`;
      
      // æ‰¾åˆ°æ”¯æŒè¯¥åŠŸèƒ½çš„æœ€ä½å±‚çº§
      suggestedTier = featureCheck.upgradeRecommendation?.suggestedTier || this.getNextTier(tier);
      benefits = featureCheck.upgradeRecommendation?.benefits || [];
      
    } else {
      // ä¸»åŠ¨å‡çº§å»ºè®®
      details = 'å‡çº§ä»¥è·å–æ›´å¤šåŠŸèƒ½å’Œé…é¢';
      suggestedTier = this.getNextTier(tier);
      benefits = this.getAllBenefits(tier, suggestedTier);
    }

    return {
      currentTier: tier,
      suggestedTier,
      reason: reason || UpgradeReason.PROACTIVE,
      details,
      benefits,
      pricing: this.getPricing(suggestedTier),
    };
  }

  /**
   * æ˜¾ç¤ºå‡çº§å¼•å¯¼
   */
  async displayUpgradeGuide(suggestion: UpgradeSuggestion): Promise<void> {
    console.log(chalk.cyan.bold('\nğŸ’ å‡çº§å»ºè®®\n'));
    
    // å½“å‰çŠ¶æ€
    console.log(chalk.gray(`å½“å‰å±‚çº§: ${this.getTierDisplayName(suggestion.currentTier)}`));
    console.log(chalk.yellow(`å‡çº§åŸå› : ${suggestion.details}\n`));
    
    // æ¨èå±‚çº§
    console.log(chalk.cyan.bold(`æ¨èå‡çº§åˆ°: ${this.getTierDisplayName(suggestion.suggestedTier)}\n`));
    
    // å‡çº§åçš„å¥½å¤„
    if (suggestion.benefits.length > 0) {
      console.log(chalk.green('âœ¨ å‡çº§åæ‚¨å°†è·å¾—:\n'));
      for (const benefit of suggestion.benefits) {
        console.log(chalk.gray(`  â€¢ ${benefit}`));
      }
      console.log('');
    }
    
    // å®šä»·ä¿¡æ¯
    if (suggestion.pricing) {
      console.log(chalk.white.bold('ğŸ’° å®šä»·ä¿¡æ¯:\n'));
      console.log(chalk.gray(`  æœˆä»˜: Â¥${suggestion.pricing.monthly}/æœˆ`));
      console.log(chalk.gray(`  å¹´ä»˜: Â¥${suggestion.pricing.yearly}/å¹´`));
      
      if (suggestion.pricing.savings) {
        console.log(chalk.green(`  ğŸ’° å¹´ä»˜èŠ‚çœ: Â¥${suggestion.pricing.savings} (${((suggestion.pricing.savings / (suggestion.pricing.monthly * 12)) * 100).toFixed(0)}%)`));
      }
      console.log('');
    }
    
    // å‡çº§é“¾æ¥
    console.log(chalk.cyan('ğŸ”— äº†è§£æ›´å¤š: https://meteor-shower.dev/pricing'));
    console.log(chalk.cyan('ğŸ“§ è”ç³»é”€å”®: sales@meteor-shower.dev\n'));
  }

  /**
   * æ˜¾ç¤ºå±‚çº§å¯¹æ¯”
   */
  displayTierComparison(currentTier: UserTier, targetTier: UserTier): void {
    console.log(chalk.cyan.bold('\nğŸ“Š å±‚çº§å¯¹æ¯”\n'));
    
    const comparison = this.featureManager.compareFeatures(currentTier, targetTier);
    
    // æ˜¾ç¤ºå…±åŒåŠŸèƒ½
    if (comparison.common.length > 0) {
      console.log(chalk.green('âœ… å…±åŒåŠŸèƒ½:\n'));
      for (const feature of comparison.common) {
        console.log(chalk.gray(`  â€¢ ${this.featureManager.getFeatureDescription(feature)}`));
      }
      console.log('');
    }
    
    // æ˜¾ç¤ºæ–°å¢åŠŸèƒ½
    if (comparison.onlyInTier2.length > 0) {
      console.log(chalk.yellow('â­ æ–°å¢åŠŸèƒ½:\n'));
      for (const feature of comparison.onlyInTier2) {
        console.log(chalk.gray(`  â€¢ ${this.featureManager.getFeatureDescription(feature)}`));
      }
      console.log('');
    }
  }

  /**
   * è·å–ä¸‹ä¸€çº§å±‚çº§
   */
  private getNextTier(currentTier: UserTier): UserTier {
    const tiers = [UserTier.FREE, UserTier.PROFESSIONAL, UserTier.TEAM, UserTier.ENTERPRISE];
    const currentIndex = tiers.indexOf(currentTier);
    
    if (currentIndex === -1 || currentIndex === tiers.length - 1) {
      return currentTier;
    }
    
    return tiers[currentIndex + 1]!;
  }

  /**
   * è·å–é…é¢ç›¸å…³çš„å¥½å¤„
   */
  private getQuotaBenefits(fromTier: UserTier, toTier: UserTier, quotaType: QuotaType): string[] {
    const benefits: string[] = [];
    
    // æ ¹æ®é…é¢ç±»å‹æ·»åŠ å…·ä½“å¥½å¤„
    switch (quotaType) {
      case QuotaType.TOOLS:
        benefits.push('æ— é™å·¥å…·é…ç½®æ•°é‡');
        break;
      case QuotaType.TEMPLATES:
        benefits.push('æ— é™äº‘ç«¯æ¨¡æ¿å­˜å‚¨');
        break;
      case QuotaType.SHARES:
        if (toTier === UserTier.TEAM || toTier === UserTier.ENTERPRISE) {
          benefits.push('æ— é™æœˆåˆ†äº«æ¬¡æ•°');
        } else {
          benefits.push('æ›´å¤šæœˆåˆ†äº«æ¬¡æ•° (100æ¬¡)');
        }
        break;
      case QuotaType.VALIDATIONS:
        if (toTier === UserTier.ENTERPRISE) {
          benefits.push('æ— é™æœˆéªŒè¯æ¬¡æ•°');
        } else {
          benefits.push(`æ›´å¤šæœˆéªŒè¯æ¬¡æ•° (${toTier === UserTier.PROFESSIONAL ? '500æ¬¡' : '2000æ¬¡'})`);
        }
        break;
      case QuotaType.TEAM_MEMBERS:
        benefits.push(`æ”¯æŒæ›´å¤šå›¢é˜Ÿæˆå‘˜ (æœ€å¤š${toTier === UserTier.TEAM ? 50 : 'æ— é™'}äºº)`);
        break;
    }
    
    // æ·»åŠ å…¶ä»–é€šç”¨å¥½å¤„
    benefits.push(...this.getAdditionalBenefits(toTier));
    
    return benefits;
  }

  /**
   * è·å–æ‰€æœ‰å‡çº§å¥½å¤„
   */
  private getAllBenefits(fromTier: UserTier, toTier: UserTier): string[] {
    const comparison = this.featureManager.compareFeatures(fromTier, toTier);
    return comparison.onlyInTier2.map(f => this.featureManager.getFeatureDescription(f));
  }

  /**
   * è·å–é¢å¤–å¥½å¤„
   */
  private getAdditionalBenefits(tier: UserTier): string[] {
    const benefits: Record<UserTier, string[]> = {
      [UserTier.FREE]: [],
      [UserTier.PROFESSIONAL]: [
        'ä¼˜å…ˆæŠ€æœ¯æ”¯æŒ',
        'AIå¢å¼ºåŠŸèƒ½',
        'ç§æœ‰äº‘ç«¯å­˜å‚¨',
      ],
      [UserTier.TEAM]: [
        'å›¢é˜Ÿåä½œåŠŸèƒ½',
        'å®¡è®¡æ—¥å¿— (90å¤©)',
        'æ‰¹é‡æ“ä½œ',
        'é«˜çº§åˆ†æ',
      ],
      [UserTier.ENTERPRISE]: [
        'SSOå•ç‚¹ç™»å½•',
        'RBACæƒé™ç®¡ç†',
        'ç§æœ‰åŒ–éƒ¨ç½²é€‰é¡¹',
        'å®¡è®¡æ—¥å¿— (365å¤©)',
        'ä¸“å±å®¢æˆ·ç»ç†',
      ],
    };
    
    return benefits[tier] || [];
  }

  /**
   * è·å–å®šä»·ä¿¡æ¯
   */
  private getPricing(tier: UserTier): { monthly: number; yearly: number; savings?: number } | undefined {
    const pricing: Record<UserTier, { monthly: number; yearly: number }> = {
      [UserTier.FREE]: { monthly: 0, yearly: 0 },
      [UserTier.PROFESSIONAL]: { monthly: 99, yearly: 999 },
      [UserTier.TEAM]: { monthly: 299, yearly: 2999 },
      [UserTier.ENTERPRISE]: { monthly: 0, yearly: 0 }, // è”ç³»é”€å”®
    };
    
    const price = pricing[tier];
    if (!price) return undefined;
    
    if (tier === UserTier.FREE || tier === UserTier.ENTERPRISE) {
      return undefined;
    }
    
    const savings = price.monthly * 12 - price.yearly;
    
    return {
      monthly: price.monthly,
      yearly: price.yearly,
      savings: savings > 0 ? savings : undefined,
    };
  }

  /**
   * è·å–é…é¢åç§°
   */
  private getQuotaName(quotaType: QuotaType): string {
    const names: Record<QuotaType, string> = {
      [QuotaType.TOOLS]: 'å·¥å…·é…ç½®',
      [QuotaType.TEMPLATES]: 'äº‘ç«¯æ¨¡æ¿',
      [QuotaType.SHARES]: 'æœˆåˆ†äº«',
      [QuotaType.VALIDATIONS]: 'æœˆéªŒè¯',
      [QuotaType.TEAM_MEMBERS]: 'å›¢é˜Ÿæˆå‘˜',
    };
    return names[quotaType] || quotaType;
  }

  /**
   * è·å–å±‚çº§æ˜¾ç¤ºåç§°
   */
  private getTierDisplayName(tier: UserTier): string {
    const names: Record<UserTier, string> = {
      [UserTier.FREE]: 'å…è´¹ç‰ˆ (Free)',
      [UserTier.PROFESSIONAL]: 'ä¸“ä¸šç‰ˆ (Professional)',
      [UserTier.TEAM]: 'å›¢é˜Ÿç‰ˆ (Team)',
      [UserTier.ENTERPRISE]: 'ä¼ä¸šç‰ˆ (Enterprise)',
    };
    return names[tier] || tier;
  }
}
