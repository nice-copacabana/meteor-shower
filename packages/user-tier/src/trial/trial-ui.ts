// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-15
// Task: M6 Phase5 - è¯•ç”¨æœŸUIå±•ç¤ºå’Œäº¤äº’

import chalk from 'chalk';
import { TrialInfo, TrialStatus, TrialManager } from './trial-manager.js';
import { UserTier } from '../types.js';

/**
 * è¯•ç”¨æœŸUIé€‰é¡¹
 */
export interface TrialUIOptions {
  /** æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ */
  verbose?: boolean;
  /** æ˜¯å¦ä½¿ç”¨é¢œè‰² */
  colored?: boolean;
}

/**
 * è¯•ç”¨æœŸç”¨æˆ·ç•Œé¢
 */
export class TrialUI {
  constructor(private trialManager: TrialManager) {}

  /**
   * æ˜¾ç¤ºè¯•ç”¨æœŸä¿¡æ¯å¡ç‰‡
   */
  async displayTrialCard(userId: string, options: TrialUIOptions = {}): Promise<void> {
    const trial = await this.trialManager.getUserActiveTrial(userId);
    
    if (!trial) {
      console.log(chalk.gray('\næš‚æ— è¿›è¡Œä¸­çš„è¯•ç”¨æœŸ'));
      return;
    }

    const colored = options.colored ?? true;

    console.log(chalk.bold('\nğŸ è¯•ç”¨æœŸä¿¡æ¯\n'));
    console.log(chalk.gray('â”€'.repeat(60)));

    // å±‚çº§ä¿¡æ¯
    const tierName = this.getTierName(trial.tier);
    console.log(chalk.cyan('è¯•ç”¨æ–¹æ¡ˆ:'), chalk.bold(tierName));

    // çŠ¶æ€ä¿¡æ¯
    const statusBadge = this.formatStatus(trial.status, colored);
    console.log(chalk.cyan('è¯•ç”¨çŠ¶æ€:'), statusBadge);

    // æ—¶é—´ä¿¡æ¯
    console.log(chalk.cyan('å¼€å§‹æ—¶é—´:'), trial.startDate.toLocaleDateString('zh-CN'));
    console.log(chalk.cyan('ç»“æŸæ—¶é—´:'), trial.endDate.toLocaleDateString('zh-CN'));

    // å‰©ä½™å¤©æ•°ï¼ˆé«˜äº®æ˜¾ç¤ºï¼‰
    const daysDisplay = this.formatDaysRemaining(trial.daysRemaining, colored);
    console.log(chalk.cyan('å‰©ä½™æ—¶é—´:'), daysDisplay);

    // è¿›åº¦æ¡
    this.displayTrialProgress(trial, colored);

    // è¡ŒåŠ¨å»ºè®®
    this.displayActionSuggestions(trial);

    console.log(chalk.gray('â”€'.repeat(60)));
    console.log();
  }

  /**
   * æ˜¾ç¤ºè¯•ç”¨æœŸè¿›åº¦æ¡
   */
  private displayTrialProgress(trial: TrialInfo, colored: boolean = true): void {
    const totalDays = Math.ceil(
      (trial.endDate.getTime() - trial.startDate.getTime()) / (24 * 60 * 60 * 1000)
    );
    const usedDays = totalDays - trial.daysRemaining;
    const percentage = (usedDays / totalDays) * 100;

    const barLength = 40;
    const filled = Math.round((percentage / 100) * barLength);
    const empty = barLength - filled;

    let barColor = chalk.green;
    if (percentage > 80) {
      barColor = chalk.red;
    } else if (percentage > 60) {
      barColor = chalk.yellow;
    }

    const progressBar = colored
      ? `${barColor('â–ˆ'.repeat(filled))}${chalk.gray('â–‘'.repeat(empty))}`
      : `${'â–ˆ'.repeat(filled)}${'â–‘'.repeat(empty)}`;

    console.log(chalk.cyan('\nè¯•ç”¨è¿›åº¦:'));
    console.log(`${progressBar} ${percentage.toFixed(0)}%`);
    console.log(chalk.gray(`å·²ä½¿ç”¨ ${usedDays} å¤© / å…± ${totalDays} å¤©`));
  }

  /**
   * æ˜¾ç¤ºè¡ŒåŠ¨å»ºè®®
   */
  private displayActionSuggestions(trial: TrialInfo): void {
    console.log(chalk.cyan('\nğŸ’¡ å»ºè®®:'));

    if (trial.daysRemaining <= 1) {
      console.log(chalk.red('âš ï¸  è¯•ç”¨æœŸå³å°†ç»“æŸï¼'));
      console.log(chalk.yellow('   ç«‹å³å‡çº§ä»¥ç»§ç»­ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½'));
      console.log(chalk.gray('   å‘½ä»¤: meteor-shower upgrade'));
    } else if (trial.daysRemaining <= 3) {
      console.log(chalk.yellow('â° è¯•ç”¨æœŸå¿«ç»“æŸäº†'));
      console.log(chalk.gray('   è€ƒè™‘å‡çº§åˆ°æ­£å¼ç‰ˆæœ¬'));
      console.log(chalk.gray('   å‘½ä»¤: meteor-shower upgrade'));
    } else {
      console.log(chalk.green('âœ“ å°½æƒ…ä½“éªŒæ‰€æœ‰åŠŸèƒ½'));
      console.log(chalk.gray('  å¦‚æœ‰ç–‘é—®ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£æˆ–è”ç³»å®¢æœ'));
    }
  }

  /**
   * æ˜¾ç¤ºè¯•ç”¨æœŸæ¬¢è¿ä¿¡æ¯
   */
  displayTrialWelcome(trial: TrialInfo): void {
    const tierName = this.getTierName(trial.tier);

    console.log(chalk.bold.green('\nğŸ‰ æ¬¢è¿å¼€å§‹è¯•ç”¨ï¼\n'));
    console.log(chalk.gray('â”€'.repeat(60)));
    console.log(chalk.cyan(`æ‚¨å·²æˆåŠŸå¼€å§‹ ${chalk.bold(tierName)} çš„è¯•ç”¨æœŸ`));
    console.log(chalk.cyan(`è¯•ç”¨æœŸé™: ${chalk.bold(trial.daysRemaining + ' å¤©')}`));
    console.log(chalk.cyan(`åˆ°æœŸæ—¶é—´: ${chalk.bold(trial.endDate.toLocaleDateString('zh-CN'))}`));
    console.log(chalk.gray('â”€'.repeat(60)));

    console.log(chalk.bold('\nâœ¨ æ‚¨ç°åœ¨å¯ä»¥:'));
    const features = this.getTierFeatures(trial.tier);
    features.forEach(feature => {
      console.log(chalk.green('  âœ“'), feature);
    });

    console.log(chalk.bold('\nğŸ“ æ¸©é¦¨æç¤º:'));
    console.log(chalk.gray('  â€¢ è¯•ç”¨æœŸå†…å¯éšæ—¶å–æ¶ˆï¼Œä¸ä¼šäº§ç”Ÿè´¹ç”¨'));
    console.log(chalk.gray('  â€¢ æˆ‘ä»¬ä¼šåœ¨è¯•ç”¨æœŸç»“æŸå‰æé†’æ‚¨'));
    console.log(chalk.gray('  â€¢ å¦‚éœ€å¸®åŠ©ï¼Œè¯·éšæ—¶è”ç³»å®¢æœ'));

    console.log(chalk.bold('\nğŸš€ å¼€å§‹æ¢ç´¢å§ï¼\n'));
  }

  /**
   * æ˜¾ç¤ºè¯•ç”¨æœŸç»“æŸæç¤º
   */
  displayTrialExpired(trial: TrialInfo): void {
    console.log(chalk.bold.red('\nâ° è¯•ç”¨æœŸå·²ç»“æŸ\n'));
    console.log(chalk.gray('â”€'.repeat(60)));
    console.log(chalk.cyan(`æ‚¨çš„ ${this.getTierName(trial.tier)} è¯•ç”¨æœŸå·²äº`));
    console.log(chalk.cyan(`${trial.endDate.toLocaleDateString('zh-CN')} ç»“æŸ`));
    console.log(chalk.gray('â”€'.repeat(60)));

    console.log(chalk.bold('\nğŸ’¡ ç»§ç»­ä½¿ç”¨:'));
    console.log(chalk.yellow('  ç«‹å³å‡çº§åˆ°æ­£å¼ç‰ˆæœ¬ï¼Œè§£é”æ‰€æœ‰åŠŸèƒ½'));
    console.log(chalk.gray('  å‘½ä»¤: meteor-shower upgrade'));

    console.log(chalk.bold('\nğŸ“Š æ‚¨çš„è´¦æˆ·:'));
    console.log(chalk.gray('  å·²è‡ªåŠ¨é™çº§åˆ°å…è´¹ç‰ˆ'));
    console.log(chalk.gray('  è¯•ç”¨æœŸé—´çš„æ•°æ®å·²ä¿ç•™'));

    console.log(chalk.bold('\nâ¤ï¸  æ„Ÿè°¢æ‚¨çš„è¯•ç”¨ï¼\n'));
  }

  /**
   * æ˜¾ç¤ºè¯•ç”¨æœŸå³å°†åˆ°æœŸæé†’
   */
  displayTrialReminder(trial: TrialInfo): void {
    const daysLeft = trial.daysRemaining;
    
    console.log(chalk.bold.yellow(`\nâ° è¯•ç”¨æœŸæé†’\n`));
    console.log(chalk.gray('â”€'.repeat(60)));
    console.log(chalk.cyan(`æ‚¨çš„ ${this.getTierName(trial.tier)} è¯•ç”¨æœŸè¿˜å‰© ${chalk.bold(daysLeft + ' å¤©')}`));
    console.log(chalk.cyan(`åˆ°æœŸæ—¶é—´: ${trial.endDate.toLocaleDateString('zh-CN')}`));
    console.log(chalk.gray('â”€'.repeat(60)));

    if (daysLeft === 1) {
      console.log(chalk.red('\nâš ï¸  æ˜å¤©å°±è¦åˆ°æœŸäº†ï¼'));
    } else {
      console.log(chalk.yellow(`\nâš ï¸  è¿˜æœ‰ ${daysLeft} å¤©åˆ°æœŸ`));
    }

    console.log(chalk.bold('\nğŸ’ å‡çº§ä¼˜æƒ :'));
    console.log(chalk.green('  ç°åœ¨å‡çº§äº«å—é¦–æœˆ8æŠ˜ä¼˜æƒ '));
    console.log(chalk.gray('  å‘½ä»¤: meteor-shower upgrade --promo TRIAL20'));

    console.log(chalk.bold('\nâ“ è¿˜åœ¨çŠ¹è±«ï¼Ÿ'));
    console.log(chalk.gray('  æŸ¥çœ‹å®Œæ•´åŠŸèƒ½å¯¹æ¯”'));
    console.log(chalk.gray('  å‘½ä»¤: meteor-shower pricing\n'));
  }

  /**
   * æ˜¾ç¤ºè¯•ç”¨æœŸå–æ¶ˆç¡®è®¤
   */
  displayCancellationConfirmation(trial: TrialInfo): void {
    console.log(chalk.bold.yellow('\nâš ï¸  ç¡®è®¤å–æ¶ˆè¯•ç”¨æœŸ\n'));
    console.log(chalk.gray('â”€'.repeat(60)));
    console.log(chalk.cyan('å–æ¶ˆåæ‚¨å°†:'));
    console.log(chalk.red('  â€¢ ç«‹å³å¤±å»æ‰€æœ‰é«˜çº§åŠŸèƒ½'));
    console.log(chalk.red('  â€¢ é™çº§åˆ°å…è´¹ç‰ˆé…é¢é™åˆ¶'));
    console.log(chalk.yellow('  â€¢ è¯•ç”¨æœŸé—´çš„æ•°æ®ä»ä¼šä¿ç•™'));
    console.log(chalk.gray('â”€'.repeat(60)));

    console.log(chalk.bold('\nğŸ’¡ æˆ–è€…æ‚¨å¯ä»¥:'));
    console.log(chalk.green('  â€¢ ç»§ç»­è¯•ç”¨å‰©ä½™çš„', trial.daysRemaining, 'å¤©'));
    console.log(chalk.green('  â€¢ éšæ—¶å¯ä»¥å‡çº§åˆ°æ­£å¼ç‰ˆæœ¬'));
    console.log();
  }

  /**
   * æ˜¾ç¤ºè¯•ç”¨æœŸç»Ÿè®¡
   */
  async displayTrialStatistics(): Promise<void> {
    const stats = await this.trialManager.getTrialStatistics();

    console.log(chalk.bold('\nğŸ“Š è¯•ç”¨æœŸç»Ÿè®¡\n'));
    console.log(chalk.gray('â”€'.repeat(60)));

    console.log(chalk.cyan('æ€»è¯•ç”¨æ•°:'), stats.totalTrials);
    console.log(chalk.cyan('è¿›è¡Œä¸­:'), chalk.yellow(stats.activeTrials.toString()));
    console.log(chalk.cyan('å·²è½¬æ­£:'), chalk.green(stats.convertedTrials.toString()));
    console.log(chalk.cyan('å·²è¿‡æœŸ:'), chalk.red(stats.expiredTrials.toString()));
    console.log(chalk.cyan('å·²å–æ¶ˆ:'), chalk.gray(stats.cancelledTrials.toString()));

    console.log(chalk.cyan('\nè½¬åŒ–ç‡:'), this.formatConversionRate(stats.conversionRate));

    console.log(chalk.gray('â”€'.repeat(60)));
    console.log();
  }

  /**
   * æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
   */
  private formatStatus(status: TrialStatus, colored: boolean = true): string {
    if (!colored) {
      return status;
    }

    switch (status) {
      case TrialStatus.ACTIVE:
        return chalk.green('è¯•ç”¨ä¸­');
      case TrialStatus.EXPIRED:
        return chalk.red('å·²è¿‡æœŸ');
      case TrialStatus.CONVERTED:
        return chalk.blue('å·²è½¬æ­£');
      case TrialStatus.CANCELLED:
        return chalk.gray('å·²å–æ¶ˆ');
      default:
        return chalk.gray(status);
    }
  }

  /**
   * æ ¼å¼åŒ–å‰©ä½™å¤©æ•°æ˜¾ç¤º
   */
  private formatDaysRemaining(days: number, colored: boolean = true): string {
    if (!colored) {
      return `${days} å¤©`;
    }

    let color = chalk.green;
    if (days <= 1) {
      color = chalk.red;
    } else if (days <= 3) {
      color = chalk.yellow;
    }

    return color.bold(`${days} å¤©`);
  }

  /**
   * æ ¼å¼åŒ–è½¬åŒ–ç‡æ˜¾ç¤º
   */
  private formatConversionRate(rate: number): string {
    const percentage = (rate * 100).toFixed(1);
    let color = chalk.red;
    
    if (rate >= 0.5) {
      color = chalk.green;
    } else if (rate >= 0.3) {
      color = chalk.yellow;
    }

    return color.bold(`${percentage}%`);
  }

  /**
   * è·å–å±‚çº§åç§°
   */
  private getTierName(tier: UserTier): string {
    const names = {
      [UserTier.FREE]: 'å…è´¹ç‰ˆ',
      [UserTier.PROFESSIONAL]: 'ä¸“ä¸šç‰ˆ',
      [UserTier.TEAM]: 'å›¢é˜Ÿç‰ˆ',
      [UserTier.ENTERPRISE]: 'ä¼ä¸šç‰ˆ',
    };
    return names[tier];
  }

  /**
   * è·å–å±‚çº§åŠŸèƒ½åˆ—è¡¨
   */
  private getTierFeatures(tier: UserTier): string[] {
    const features = {
      [UserTier.PROFESSIONAL]: [
        'æ— é™å·¥å…·é…ç½®å’Œæ¨¡æ¿',
        'æ¯æœˆ500æ¬¡èƒ½åŠ›éªŒè¯',
        '10GBäº‘ç«¯å­˜å‚¨',
        'AIå¢å¼ºåŠŸèƒ½',
        '7å¤©äº‘ç«¯å¤‡ä»½',
      ],
      [UserTier.TEAM]: [
        'ä¸“ä¸šç‰ˆå…¨éƒ¨åŠŸèƒ½',
        'å›¢é˜Ÿåä½œåŠŸèƒ½',
        'æ¯æœˆ2000æ¬¡èƒ½åŠ›éªŒè¯',
        '100GBäº‘ç«¯å­˜å‚¨',
        '30å¤©äº‘ç«¯å¤‡ä»½',
        '90å¤©å®¡è®¡æ—¥å¿—',
      ],
      [UserTier.ENTERPRISE]: [
        'å›¢é˜Ÿç‰ˆå…¨éƒ¨åŠŸèƒ½',
        'æ— é™èƒ½åŠ›éªŒè¯',
        'æ— é™äº‘ç«¯å­˜å‚¨',
        'SSOå•ç‚¹ç™»å½•',
        'RBACæƒé™æ§åˆ¶',
        '365å¤©å®¡è®¡æ—¥å¿—',
        '99.9% SLAä¿éšœ',
        'ä¸“å±æŠ€æœ¯æ”¯æŒ',
      ],
    };

    return features[tier as keyof typeof features] || [];
  }
}
