// Generated by Qoder AI (Model: claude-sonnet-4-5-20250929) - 2025-10-15
// Task: M6 Phase3 - ä½¿ç”¨é‡ç»Ÿè®¡æ˜¾ç¤º

import chalk from 'chalk';
import { QuotaManager, QuotaType, QuotaCheckResult } from './quota-manager.js';
import { UserTier } from '../types.js';

/**
 * ä½¿ç”¨é‡æ˜¾ç¤ºé…ç½®
 */
export interface UsageDisplayOptions {
  /** æ˜¯å¦æ˜¾ç¤ºç™¾åˆ†æ¯” */
  showPercentage?: boolean;
  
  /** æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡ */
  showProgressBar?: boolean;
  
  /** è¿›åº¦æ¡é•¿åº¦ */
  barLength?: number;
  
  /** æ˜¯å¦æ˜¾ç¤ºé¢œè‰² */
  colored?: boolean;
}

/**
 * ä½¿ç”¨é‡ç»Ÿè®¡æ˜¾ç¤ºå™¨
 */
export class UsageDisplay {
  constructor(private quotaManager: QuotaManager) {}

  /**
   * æ˜¾ç¤ºå•ä¸ªé…é¢ä½¿ç”¨æƒ…å†µ
   */
  async displayQuota(
    userId: string,
    quotaType: QuotaType,
    options: UsageDisplayOptions = {}
  ): Promise<void> {
    const {
      showPercentage = true,
      showProgressBar = true,
      barLength = 20,
      colored = true,
    } = options;

    const quota = await this.quotaManager.checkQuota(userId, quotaType);
    
    console.log(chalk.bold(`\n${this.getQuotaDisplayName(quotaType)}:`));
    
    // æ˜¾ç¤ºæ•°å€¼
    if (quota.limit === -1) {
      console.log(chalk.gray(`  å½“å‰ä½¿ç”¨: ${quota.current} (æ— é™åˆ¶)`));
    } else {
      console.log(chalk.gray(`  å½“å‰ä½¿ç”¨: ${quota.current} / ${quota.limit}`));
      console.log(chalk.gray(`  å‰©ä½™é…é¢: ${quota.remaining}`));
      
      // æ˜¾ç¤ºç™¾åˆ†æ¯”
      if (showPercentage) {
        const percentage = (quota.current / quota.limit) * 100;
        const percentColor = this.getPercentageColor(percentage, colored);
        console.log(percentColor(`  ä½¿ç”¨ç‡: ${percentage.toFixed(1)}%`));
      }
      
      // æ˜¾ç¤ºè¿›åº¦æ¡
      if (showProgressBar) {
        const bar = this.generateProgressBar(quota, barLength, colored);
        console.log(`  è¿›åº¦: ${bar}`);
      }
    }
    
    // æ˜¾ç¤ºè­¦å‘Š
    if (!quota.allowed) {
      console.log(chalk.red(`  âš ï¸  ${quota.reason}`));
    } else if (quota.limit !== -1 && quota.remaining < quota.limit * 0.2) {
      console.log(chalk.yellow(`  âš ï¸  é…é¢å³å°†ç”¨å°½ï¼Œå»ºè®®å‡çº§`));
    }
  }

  /**
   * æ˜¾ç¤ºæ‰€æœ‰é…é¢ä½¿ç”¨æƒ…å†µ
   */
  async displayAllQuotas(
    userId: string,
    options: UsageDisplayOptions = {}
  ): Promise<void> {
    console.log(chalk.cyan.bold('\nğŸ“Š é…é¢ä½¿ç”¨æƒ…å†µ\n'));
    
    const quotas = await this.quotaManager.getAllQuotas(userId);
    
    for (const [type, quota] of Object.entries(quotas)) {
      await this.displayQuota(userId, type as QuotaType, options);
    }
    
    console.log('');
  }

  /**
   * æ˜¾ç¤ºé…é¢æ‘˜è¦
   */
  async displayQuotaSummary(userId: string): Promise<void> {
    const quotas = await this.quotaManager.getAllQuotas(userId);
    const tier = quotas[QuotaType.TOOLS]?.tier || UserTier.FREE;
    
    console.log(chalk.cyan.bold('\nğŸ“Š é…é¢æ‘˜è¦\n'));
    console.log(chalk.white(`å½“å‰å±‚çº§: ${this.getTierDisplayName(tier)}\n`));
    
    // è®¡ç®—æ€»ä½“ä½¿ç”¨æƒ…å†µ
    let totalQuotas = 0;
    let nearLimitQuotas = 0;
    let atLimitQuotas = 0;
    
    for (const quota of Object.values(quotas)) {
      if (quota.limit === -1) continue; // è·³è¿‡æ— é™é…é¢
      
      totalQuotas++;
      const percentage = (quota.current / quota.limit) * 100;
      
      if (percentage >= 100) {
        atLimitQuotas++;
      } else if (percentage >= 80) {
        nearLimitQuotas++;
      }
    }
    
    console.log(chalk.gray(`æ€»é…é¢é¡¹: ${totalQuotas}`));
    console.log(chalk.red(`å·²è¾¾ä¸Šé™: ${atLimitQuotas}`));
    console.log(chalk.yellow(`æ¥è¿‘ä¸Šé™ (â‰¥80%): ${nearLimitQuotas}`));
    console.log(chalk.green(`æ­£å¸¸ä½¿ç”¨: ${totalQuotas - atLimitQuotas - nearLimitQuotas}`));
    
    // æ˜¾ç¤ºå»ºè®®
    if (atLimitQuotas > 0 || nearLimitQuotas > 0) {
      console.log(chalk.yellow('\nğŸ’¡ å»ºè®®: è€ƒè™‘å‡çº§åˆ°æ›´é«˜å±‚çº§ä»¥è·å¾—æ›´å¤šé…é¢'));
    }
    
    console.log('');
  }

  /**
   * ç”Ÿæˆè¿›åº¦æ¡
   */
  private generateProgressBar(
    quota: QuotaCheckResult,
    length: number = 20,
    colored: boolean = true
  ): string {
    if (quota.limit === -1) {
      return chalk.gray('âˆ æ— é™åˆ¶');
    }
    
    const percentage = (quota.current / quota.limit) * 100;
    const filled = Math.round((percentage / 100) * length);
    const empty = length - filled;
    
    let barColor: (text: string) => string;
    if (!colored) {
      barColor = (text: string) => text;
    } else if (percentage >= 100) {
      barColor = chalk.red;
    } else if (percentage >= 80) {
      barColor = chalk.yellow;
    } else if (percentage >= 50) {
      barColor = chalk.blue;
    } else {
      barColor = chalk.green;
    }
    
    const filledBar = barColor('â–ˆ'.repeat(filled));
    const emptyBar = chalk.gray('â–‘'.repeat(empty));
    
    return `${filledBar}${emptyBar} ${percentage.toFixed(0)}%`;
  }

  /**
   * è·å–ç™¾åˆ†æ¯”é¢œè‰²
   */
  private getPercentageColor(percentage: number, colored: boolean): (text: string) => string {
    if (!colored) {
      return chalk.white;
    }
    
    if (percentage >= 100) {
      return chalk.red;
    } else if (percentage >= 80) {
      return chalk.yellow;
    } else if (percentage >= 50) {
      return chalk.blue;
    } else {
      return chalk.green;
    }
  }

  /**
   * è·å–é…é¢æ˜¾ç¤ºåç§°
   */
  private getQuotaDisplayName(quotaType: QuotaType): string {
    const names: Record<QuotaType, string> = {
      [QuotaType.TOOLS]: 'ğŸ”§ å·¥å…·é…ç½®æ•°é‡',
      [QuotaType.TEMPLATES]: 'ğŸ“„ äº‘ç«¯æ¨¡æ¿æ•°é‡',
      [QuotaType.SHARES]: 'ğŸ”— æœˆåˆ†äº«æ¬¡æ•°',
      [QuotaType.VALIDATIONS]: 'âœ… æœˆéªŒè¯æ¬¡æ•°',
      [QuotaType.TEAM_MEMBERS]: 'ğŸ‘¥ å›¢é˜Ÿæˆå‘˜æ•°é‡',
    };
    return names[quotaType] || quotaType;
  }

  /**
   * è·å–å±‚çº§æ˜¾ç¤ºåç§°
   */
  private getTierDisplayName(tier: UserTier): string {
    const names: Record<UserTier, string> = {
      [UserTier.FREE]: 'å…è´¹ç‰ˆ (Free)',
      [UserTier.PROFESSIONAL]: 'ä¸“ä¸šç‰ˆ (Professional)',
      [UserTier.TEAM]: 'å›¢é˜Ÿç‰ˆ (Team)',
      [UserTier.ENTERPRISE]: 'ä¼ä¸šç‰ˆ (Enterprise)',
    };
    return names[tier] || tier;
  }
}
