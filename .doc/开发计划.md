# 开发计划（AI 全自动执行，决策点需审批）

## 目标
- 交付“一键优化与同步”平台 M1-M3 全栈能力：模板化配置、适配层、CLI、UI 控制台、可选 Cloud Hub。
- 在尽量减少人工参与的前提下，由 AI 代理完成代码实现、测试、构建与发布（关键决策需审批）。

## 路线图与时间
- M1（2-3 周）：本地端到端最小可用
- M2（3-4 周）：云端与 UI Alpha、RAG/MCP 示例
- M3（4-6 周）：企业化、可观测、分发与自动升级

## 里程碑与任务明细
### M1：本地最小可用（CLI 为主）
- 核心功能
  - 模板引擎与渲染：JSONSchema 驱动 + 模板（规则/GEMINI.md、CLAUDE.md、MCP、Memory、命令、README 片段）
  - 适配层：
    - Gemini：生成/合并 ~/.gemini/GEMINI.md、settings.json、commands/*.toml
    - Claude：生成 ~/.claude/claude.json、项目 CLAUDE.md/CLAUDE.local.md
    - Cursor：导出/导入 state.vscdb 的 aicontext.personalContext（文本化中介）
    - OpenAI/通用：AGENTS.md、shell profile 片段、.env 占位
  - CLI 指令：
    - ms init：交互式选择工具/模板 → 变量采集 → ApplicationPlan
    - ms diff：渲染并展示变更差异（安全提示）
    - ms apply [-y]：写入各工具配置，失败回滚
    - ms share：将当前项目规则打包为模板（变量抽取）
    - ms mcp test：探测 MCP 服务器（连通性/超时/白名单）
  - Devcontainer：一键生成带 CLI/chezmoi/工具链的 devcontainer.json
- 工程与质量
  - 代码结构：packages/cli、packages/adapters、packages/templates、examples
  - 测试：模板渲染单测；适配层集成测；diff/回滚 e2e；危险命令扫描
  - 日志与可观测：--verbose、--json 输出；审计轨迹（本地文件）
- 产出
  - 可执行 CLI（跨平台打包）+ 示例模板库 + 演示脚本
- KPI
  - 10 分钟内完成一次“选模板→应用→验证→回滚”的完整闭环
  - 渲染/写入平均 < 2s；失败可回滚；零密钥泄露

### M2：Cloud Hub 与 UI Alpha
- Cloud Hub（轻后端，可选）
  - 模板上载/检索/评分；签名与静态扫描；账户/令牌；速率限制
  - API：GET /templates、POST /templates、审计/日志
- UI 控制台（Tauri/Electron 或 VS Code 扩展）
  - 向导式初始化：选工具集→选模板→变量表单→校验→一键应用
  - 实时 diff 预览与危险项二次确认；备份/还原/导入/导出；日志与回滚入口
  - 本地守护进程（REST/gRPC）：渲染、校验、apply/diff/rollback、Keychain
- RAG/MCP 示例
  - 本地 RAG（嵌入/向量库/检索）与 MCP Server 示例；`ms mcp test` 深化
- KPI
  - 模板市场首批 ≥ 10 个高质量模板；UI 配置时长下降 50%

### M3：企业化与分发
- 组织与权限、审批流、私有模板域、策略集（安全/网络/命令）
- Devcontainer 预制镜像、Codespaces 工作流、自动升级通道
- 可观测：指标/追踪、Sentry、离线缓存、灰度与回滚策略
- KPI
  - 组织内 20+ 开发者落地；回滚与升级成功率 > 99%

## 风险与对策
- 配置破坏/误写入：
  - 对策：默认 dry-run；强制备份与回滚点；危险命令黑名单与二次确认
- 凭证泄露：
  - 对策：Keychain/.env.local、本地加密、敏感扫描、永不入库
- Cursor DB 兼容性：
  - 对策：文本中介与版本检测、集成测试覆盖不同版本
- 模板质量参差：
  - 对策：签名与扫描、评分门槛、示例与校验规则

## 自动化执行（AI 代理流水线）
- 触发：PR 评论命令/CLI 指令；仅在策略变更、危险操作时等待审批
- 流水：需求解析→任务拆分→代码生成→测试→构建→发布→文档更新
- 产物：CLI 二进制、桌面 UI 包、模板库、devcontainer、脚本与文档

## 初始任务分解（AI 执行）
1) 初始化仓库结构（packages/*、examples、scripts）
2) 实现模板引擎与渲染器（schema 校验、变量收集、渲染管线）
3) 实现适配层（Gemini/Claude/Cursor/OpenAI）与回滚器
4) 实现 CLI（init/diff/apply/share/mcp test）
5) Devcontainer 生成器与 chezmoi hooks 示例
6) 编写单测/集成/E2E 与危险命令扫描器
7) 打包与发布脚本（多平台），演示脚本与文档
8) 统一入口与编排（规划）：定义任务状态机与评分维度；设计 Auto-Continue 策略与断点；产出 IDE 浮层交互原型与 API 草案（不编码）。

## 统一入口与人机协作编排（新增规划）
- 产品愿景：成为“AI 工具与人类协作”的统一入口，像捕捉流星般接住灵感与任务，持续靠近目标并完善连接。

- 入口形态：
  - CLI：面向工程师与自动化脚本的第一入口（capture/queue/continue/review 原语）。
  - Background Agent：常驻守护，拉取队列与上下文，执行 Auto-Continue/心跳续写，将阶段产物入列“待审”。
  - IDE 浮动小工具条（概念/交互原型）：展示评分、继续/暂停、提交审查、跳转任务卡片与变更摘要（M1 仅文档与原型说明，不编码）。

- 编排模型：
  - 任务状态机：captured → queued → in_progress → await_review → done/blocked；支持分解/合并/去重。
  - 评分机制：优先级/影响/信心/到期；用于排序与 WIP 限流。
  - Auto-Continue 策略：节拍、令牌预算、风险阈值、失败回退、“请人类介入”断点。
  - Review 队列：提供变更摘要与风险提示，支持一键通过/退回与批量操作。

- 数据与同步：
  - 本地优先存储（SQLite/文件），可选与 Cloud Hub 同步；离线优先、最终一致性。
  - 安全与审计：本地加密、隐私不出端；模板/策略签名与操作审计。

- 与现有模块的关系：
  - 与模板/适配层：编排输出作为模板渲染与适配层 apply 的上游计划。
  - 与 UI/Cloud Hub：共用任务源与审查列表；UI 展示、人机协作入口。
  - 与 Observability：记录任务推进指标与失败原因，回馈策略优化。

- 里程碑影响（不改变现有范围，仅补充规划与 KPI）：
  - M1：
    - 新增规划项与概念原型：CLI 原语定义（capture/queue/continue/review），IDE 浮层交互说明，守护进程职责说明。
    - KPI 补充：灵感捕捉→任务入队 < 10s；Auto-Continue 能连续推进 ≥ 3 个子步骤（以脚本模拟验证）。
  - M2：
    - 任务编排服务雏形：状态机与评分实现；Auto-Continue 策略中心；Review 队列与变更摘要。
    - 多入口聚合：CLI、UI、IDE 面板共享任务源（本地为主，Cloud Hub 可选同步）。
    - KPI 补充：≥ 70% 流水在无人干预下可到“待审”；审查通过率 ≥ 80%。
  - M3：
    - 规模化与治理：组织级看板（吞吐、Lead Time、自动续写占比、人工介入原因库）。
    - 策略与合规：审批门槛、审计追踪、模型/工具白名单；成本与配额（预算告警、性价比路由）。
    - KPI 补充：每人每日成功处理（自动+人工）任务 ≥ 20；重复问题回归率 < 5%。

- 风险与对策补充：
  - Auto-Continue 误推进：设置风险阈值与强制“待审”闸口、变更差异可视化。
  - 任务泛滥与上下文稀释：评分/去重/合并相似灵感、看板 WIP 限制、定期归档。
  - 多入口一致性：单一任务源与事件总线；冲突检测与幂等写入。
