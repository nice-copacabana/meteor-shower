# 系统设计：AI 编程工具一键优化与同步平台（meteor-shower）

## 1. 背景与目标
- 背景：当前 AI 编程工具（示例：Gemini CLI、Cursor、Claude Code）在规则、上下文、MCP、内存等配置上分散、异构，难以快速复用到多端和多人，优秀配置的共享门槛高。
- 目标：
  - 一键在本机多款 AI 工具应用“最佳实践配置”（初始化说明、规则、MCP、Memory 等）。
  - 将差异项抽象为可配置模板并自动整合，支持多工具协同落地。
  - 提供云端配置仓库，支持优秀配置的评价、检索、订阅与一键拉取应用。
  - 保持凭证安全与个性化变量不外泄，实现“公私分离”。
- 读者：产品、平台/工具链工程、AI/后端、DevOps、文档与体验团队。

## 2. 范围与不在范围
- 范围：
  - 本地一键应用：初始化 README/规则、MCP、Memory、命令、目录约定。
  - 多工具适配：Gemini CLI、Cursor、Claude Code、OpenAI 代理等的差异适配层。
  - 云端共享：配置模板上载、审核、评级、检索与一键下发。
  - 安全与合规：凭证隔离、私密变量模板化、最小权限工具白名单。
  - 运维与可观测：日志、指标、事件追踪与失败回滚。
- 不在范围：
  - 具体 IDE 二次开发与内核修改。
  - 模型推理服务本身的训练/部署。

## 3. 架构总览
- 架构风格：模块化单体 + 轻服务（本地 CLI 为核心，云端为轻后端）。
- 技术栈建议：
  - 本地 CLI：Node.js（Nx/TS）或 Python（Typer/FastAPI CLI 模式）。
  - 轻后端（可选）：FastAPI/NestJS + Postgres/SQLite + S3 兼容存储。
  - 同步与模板：chezmoi/gnu-stow 支持；devcontainer.json 集成。
  - RAG/MCP：内置本地 RAG 工具与 MCP Server 示例（Python/FastAPI）。
- 关键组件：
  1) Template Registry 本地/云端仓库（模板与规则集）
  2) Tool Adapter 适配层（Gemini/Cursor/Claude/OpenAI）
  3) Secrets & Memory Manager（密钥与记忆分层）
  4) MCP Orchestrator（统一声明式 mcpServers 生成与校验）
  5) DevEnv Distributor（devcontainer/dotfiles 一键应用）
  6) Cloud Hub（分享/评级/检索/订阅/同步）

### 3.1 工具分组与活跃度排行（同类合并）
- 插件/扩展类（VS Code/JetBrains 生态）：
  - 头部：GitHub Copilot（显著第一）
  - 其次：Codeium、Tabnine、Sourcegraph Cody
  - 新锐增长：Continue.dev、Cline
- AI 原生编辑器/IDE 类：
  - 头部：Cursor（同类领先）
  - 其次：Windsurf（增长中）
- CLI/桌面 Agent 类：
  - 领先：Claude Code（桌面/扩展）、Gemini CLI
  - 其次：Aider、Replit Ghostwriter、CodeBuddy
注：基于公开装机/使用信号的综合判断，非严格份额。用于模板优先级与适配深度排序。

### 3.2 常见配置项差异摘要
- 模型与路由：提供商优先级、fallback、网络代理/地域
- 生成参数：temperature/top_p/max_tokens/stop、系统提示与规则源
- 上下文与索引：遵守 .gitignore、白/黑名单、代码索引/图谱深度
- RAG/检索：嵌入模型、chunk/overlap、topK、向量库、缓存 TTL
- MCP/工具：mcpServers、工具白/黑名单、超时/重试、危险命令防护
- 记忆分层：全局/项目/子目录/会话合并顺序、持久化与自动摘要
- 安全隐私：API Key 来源（钥匙串/.env.local）、遥测、PII 脱敏、上传边界
- 质量规范：格式化/Lint/测试/构建命令、提交模板、分支策略
- 工作流：PR 审查策略、自动修复阈值、dry-run/diff 粒度、回滚点
- 环境：devcontainer.json 生成、依赖安装、代理/证书、GPU/加速

## 4. 核心模块设计
### 4.1 Template Registry（模板与规则仓库）
- 内容类型：
  - 初始化说明模板：项目 README 初始化片段、工具使用 SOP。
  - 规则模板：GEMINI.md、CLAUDE.md/CLAUDE.local.md、AGENTS.md 片段。
  - MCP 模板：标准化 mcpServers 声明、常见第三方 MCP 一键启用。
  - Memory 策略：长期/短期/会话内指令分层策略与合并顺序。
  - 命令模板：Gemini `.gemini/commands/*.toml`、常用斜杠命令。
- 模板元数据：id、名称、版本、作者、适配工具集、依赖、变量声明、风险分级、验证用例、评分、下载量。
- 模板渲染：基于 JSONSchema + Handlebars/Go Template 渲染，支持条件/循环与平台变量（OS、用户名、路径）。

### 4.2 Tool Adapter（多工具差异适配）
- Gemini CLI：
  - 生成/合并 `~/.gemini/GEMINI.md` 与项目级 `./.gemini/GEMINI.md`。
  - 生成 `~/.gemini/settings.json`（尊重 ignore、安全白名单、mcpServers）。
  - 注入 `.gemini/commands/*.toml` 自定义命令。
- Cursor：
  - 通过脚本桥接 `state.vscdb`：导出/导入 `aicontext.personalContext`。
  - 遵循“文本化中介”原则，永不直接提交 DB，始终以可版本化文本为源。
- Claude Code：
  - 生成 `~/.claude/claude.json` 与项目级 `CLAUDE.md/CLAUDE.local.md`。
- OpenAI/通用代理：
  - 生成 `AGENTS.md`、shell profile 片段与 `.env` 占位，避免密钥入库。

### 4.3 Secrets & Memory Manager（公私分离）
- 私密变量：API Key、私有端点、组织标识，存储于系统密钥链或 `.env.local`，永不入库。
- 公共记忆：规则、SOP、约定，随项目版本管理，可推送云端共享。
- 合并顺序：全局 > 项目 > 子目录 > 会话动态追加，冲突时最近优先，保留审计轨迹。

### 4.4 MCP Orchestrator（统一声明）
- 统一的 `mcp.json`/`settings.json` 生成器：
  - 校验 MCP 服务器可达性、命令与参数白名单、超时与错误处理。
  - 预置常用 MCP（GitHub、Vector/RAG、本地工具链）。

### 4.5 DevEnv Distributor（环境分发）
- 生成 `devcontainer.json`：安装 Gemini/Claude CLI、Python、gh、chezmoi；克隆并应用 dotfiles；注入远程密钥。
- 生成 dotfiles 变更：chezmoi 模板化与 hooks（导入/导出 Cursor 规则）。

### 4.6 Cloud Hub（可选轻后端）
- 能力：模板上载/审核、评分与评论、检索、订阅、Webhook 下发；版本与兼容性矩阵。
- 安全：模板沙箱扫描、命令白名单审计、作者信誉分。

## 5. 数据模型（核心实体）
- Template：id、name、version、type（rule/mcp/memory/command/readme）、targets（gemini/cursor/...）、variables（schema）、riskLevel、author、rating、downloads、files[]。
- ConfigProfile：id、name、toolset、templateRefs[]、overrides（kv）、createdBy、visibility。
- ApplicationPlan：id、profileId、targetMachine、dryRunReport、diff、status、logs。
- User/Org：id、roles、keysRef、preferences。
- Submission/Review（云端）：templateId、artifactHash、scanReport、reviewState。

## 6. 接口设计（示例）
- 本地 CLI：
  - `ms init`：交互式选择工具与模板，生成应用计划与变更预览。
  - `ms apply [-y]`：按适配层写入各工具配置；失败回滚；输出摘要。
  - `ms diff`：展示当前环境与选择配置间差异。
  - `ms share`：将当前项目规则打包为模板（自动抽取变量），可推送云端。
  - `ms mcp test`：探测并验证 MCP 服务可用性。
- 云端 API（可选）：
  - `GET /api/v1/templates?tool=gemini` 检索模板
  - `POST /api/v1/templates` 上载模板（含签名与扫描）
  - `POST /api/v1/configs/apply` 生成 devcontainer 与脚本包

## 7. 关键流程
### 7.1 本地一键应用
1) 选择模板与目标工具集 → 2) 变量收集（交互或 .env.local） → 3) 生成 ApplicationPlan → 4) dry-run diff → 5) apply → 6) 验证（MCP/CLI 探测） → 7) 产出报告与回滚点。

### 7.2 多工具差异整合
- 以 Template Registry 为源，渲染多份工件（GEMINI.md、CLAUDE.md、settings.json、commands、chezmoi 脚本、devcontainer.json）。
- 针对 Cursor 走“导出文本/导入 DB”的桥接流程。

### 7.3 云端分享与下发
1) `ms share` 生成模板包 → 2) 本地扫描（敏感/危险命令） → 3) 上载云端 → 4) 社区审核与评级 → 5) 他人一键拉取与应用。

## 8. 非功能性需求
- 安全：
  - 最小权限命令白名单；默认拒绝高风险命令（rm -rf、curl | sh 等）。
  - 凭证不入库；支持系统钥匙串/密管集成；本地加密存储（可选）。
- 可靠性：失败回滚；应用点快照；幂等写入与重试；离线缓存模板。
- 性能：本地渲染 < 2s；批量文件写入与并发探测；云端检索 p95 < 300ms。
- 可观测：结构化日志；操作审计；CLI `--verbose --json` 输出；Sentry 集成（可选）。
- 可移植：支持 macOS/Linux/Windows；路径与 shell 差异以模板变量适配。

## 9. 部署与环境
- 单机版（优先）：仅 CLI + 本地模板仓库即可工作。
- 云端（可选）：Docker 化后端 + Postgres + 对象存储；CDN 分发只读模板。
- DevContainer：提供标准环境镜像与一键脚本，便于开箱即用体验。

## 10. 安全与合规
- 模板来源与签名校验；SBOM/脚本静态扫描；运行前高风险确认。
- 隐私：默认匿名统计；可全局关闭；遵循数据最小化原则。

## 11. 里程碑
- M1（MVP）：
  - 本地 CLI：模板渲染、Gemini/Claude 适配、Cursor 导出/导入脚本、devcontainer 生成、dry-run/diff/apply、回滚。
  - 内置模板：初始化 README、GEMINI.md/CLAUDE.md、MCP 常用项、commands 示例、chezmoi hooks。
- M2：
  - Cloud Hub 最小版：模板上载/检索/评级；模板安全扫描；账户体系。
  - RAG/MCP 示例服务器与验证工具。
- M3：
  - 企业特性：组织与权限、审批流、私有模板域；多环境编排与策略集。

## 12. 参考与附录
- 参考：`.doc/构建自主代理：优化Gemini CLI以实现高级软件开发的综合指南.md`、`.doc/统一 AI 开发环境：现代编码助手配置同步与共享综合指南.md`
- 附录：
  - A. 风险命令默认黑名单与可覆盖机制
  - B. 渲染变量清单（OS、home、user、shell、toolset、paths、secretsRef）
  - C. 目录与文件约定：`~/.gemini/`、`~/.claude/`、`AGENTS.md`、`devcontainer.json`、`chezmoi` 源目录结构

> 注：本文件为活文档，随项目推进持续更新。

## 13. 控制台（UI）方案
- 形态：
  - 桌面端（Tauri/Electron）或 VS Code 扩展面板
  - 本地守护进程（REST/gRPC）承载渲染、校验、dry-run/diff、应用/回滚、密钥读写（集成 OS Keychain）
- 核心能力：
  - 向导式初始化（选工具集→选模板→变量表单→校验→一键应用）
  - 实时预览与高亮 diff、危险项二次确认
  - 备份/还原、导入/导出、配置版本对比
  - 云端模板库浏览/评分/一键拉取本地化
  - 日志/审计/回滚入口；与 CLI 功能等价
